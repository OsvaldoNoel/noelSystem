import{getViewportSize,getPanAreaSize}from"../util/viewport-size.js";import ZoomLevel from"./zoom-level.js";const MIN_SLIDES_TO_CACHE=5;export function lazyLoadData(e,t,i){const d=t.createContentFromData(e,i);let o;const{options:a}=t;if(a){let s;o=new ZoomLevel(a,e,-1),s=t.pswp?t.pswp.viewportSize:getViewportSize(a,t);const n=getPanAreaSize(a,s,e,i);o.update(d.width,d.height,n)}return d.lazyLoad(),o&&d.setDisplayedSize(Math.ceil(d.width*o.initial),Math.ceil(d.height*o.initial)),d}export function lazyLoadSlide(e,t){const i=t.getItemData(e);if(!t.dispatch("lazyLoadSlide",{index:e,itemData:i}).defaultPrevented)return lazyLoadData(i,t,e)}class ContentLoader{constructor(e){this.pswp=e,this.limit=Math.max(e.options.preload[0]+e.options.preload[1]+1,5),this._cachedItems=[]}updateLazy(e){const{pswp:t}=this;if(t.dispatch("lazyLoad").defaultPrevented)return;const{preload:i}=t.options,d=void 0===e||e>=0;let o;for(o=0;o<=i[1];o++)this.loadSlideByIndex(t.currIndex+(d?o:-o));for(o=1;o<=i[0];o++)this.loadSlideByIndex(t.currIndex+(d?-o:o))}loadSlideByIndex(e){const t=this.pswp.getLoopedIndex(e);let i=this.getContentByIndex(t);i||(i=lazyLoadSlide(t,this.pswp),i&&this.addToCache(i))}getContentBySlide(e){let t=this.getContentByIndex(e.index);return t||(t=this.pswp.createContentFromData(e.data,e.index),this.addToCache(t)),t.setSlide(e),t}addToCache(e){if(this.removeByIndex(e.index),this._cachedItems.push(e),this._cachedItems.length>this.limit){const e=this._cachedItems.findIndex((e=>!e.isAttached&&!e.hasSlide));if(-1!==e){this._cachedItems.splice(e,1)[0].destroy()}}}removeByIndex(e){const t=this._cachedItems.findIndex((t=>t.index===e));-1!==t&&this._cachedItems.splice(t,1)}getContentByIndex(e){return this._cachedItems.find((t=>t.index===e))}destroy(){this._cachedItems.forEach((e=>e.destroy())),this._cachedItems=[]}}export default ContentLoader;