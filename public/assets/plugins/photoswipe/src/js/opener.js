import{setTransform,equalizePoints,decodeImage,toTransformString}from"./util/util.js";const MIN_OPACITY=.003;class Opener{constructor(i){this.pswp=i,this.isClosed=!0,this.isOpen=!1,this.isClosing=!1,this.isOpening=!1,this._duration=void 0,this._useAnimation=!1,this._croppedZoom=!1,this._animateRootOpacity=!1,this._animateBgOpacity=!1,this._placeholder=void 0,this._opacityElement=void 0,this._cropContainer1=void 0,this._cropContainer2=void 0,this._thumbBounds=void 0,this._prepareOpen=this._prepareOpen.bind(this),i.on("firstZoomPan",this._prepareOpen)}open(){this._prepareOpen(),this._start()}close(){if(this.isClosed||this.isClosing||this.isOpening)return;const i=this.pswp.currSlide;this.isOpen=!1,this.isOpening=!1,this.isClosing=!0,this._duration=this.pswp.options.hideAnimationDuration,i&&i.currZoomLevel*i.width>=this.pswp.options.maxWidthToAnimate&&(this._duration=0),this._applyStartProps(),setTimeout((()=>{this._start()}),this._croppedZoom?30:0)}_prepareOpen(){if(this.pswp.off("firstZoomPan",this._prepareOpen),!this.isOpening){const i=this.pswp.currSlide;this.isOpening=!0,this.isClosing=!1,this._duration=this.pswp.options.showAnimationDuration,i&&i.zoomLevels.initial*i.width>=this.pswp.options.maxWidthToAnimate&&(this._duration=0),this._applyStartProps()}}_applyStartProps(){const{pswp:i}=this,t=this.pswp.currSlide,{options:s}=i;if("fade"===s.showHideAnimationType?(s.showHideOpacity=!0,this._thumbBounds=void 0):"none"===s.showHideAnimationType?(s.showHideOpacity=!1,this._duration=0,this._thumbBounds=void 0):this.isOpening&&i._initialThumbBounds?this._thumbBounds=i._initialThumbBounds:this._thumbBounds=this.pswp.getThumbBounds(),this._placeholder=t?.getPlaceholderElement(),i.animations.stopAll(),this._useAnimation=Boolean(this._duration&&this._duration>50),this._animateZoom=Boolean(this._thumbBounds)&&t?.content.usePlaceholder()&&(!this.isClosing||!i.mainScroll.isShifted()),this._animateZoom?this._animateRootOpacity=s.showHideOpacity??!1:(this._animateRootOpacity=!0,this.isOpening&&t&&(t.zoomAndPanToInitial(),t.applyCurrentZoomPan())),this._animateBgOpacity=!this._animateRootOpacity&&this.pswp.options.bgOpacity>.003,this._opacityElement=this._animateRootOpacity?i.element:i.bg,!this._useAnimation)return this._duration=0,this._animateZoom=!1,this._animateBgOpacity=!1,this._animateRootOpacity=!0,void(this.isOpening&&(i.element&&(i.element.style.opacity=String(.003)),i.applyBgOpacity(1)));this._animateZoom&&this._thumbBounds&&this._thumbBounds.innerRect?(this._croppedZoom=!0,this._cropContainer1=this.pswp.container,this._cropContainer2=this.pswp.currSlide?.holderElement,i.container&&(i.container.style.overflow="hidden",i.container.style.width=i.viewportSize.x+"px")):this._croppedZoom=!1,this.isOpening?(this._animateRootOpacity?(i.element&&(i.element.style.opacity=String(.003)),i.applyBgOpacity(1)):(this._animateBgOpacity&&i.bg&&(i.bg.style.opacity=String(.003)),i.element&&(i.element.style.opacity="1")),this._animateZoom&&(this._setClosedStateZoomPan(),this._placeholder&&(this._placeholder.style.willChange="transform",this._placeholder.style.opacity=String(.003)))):this.isClosing&&(i.mainScroll.itemHolders[0]&&(i.mainScroll.itemHolders[0].el.style.display="none"),i.mainScroll.itemHolders[2]&&(i.mainScroll.itemHolders[2].el.style.display="none"),this._croppedZoom&&0!==i.mainScroll.x&&(i.mainScroll.resetPosition(),i.mainScroll.resize()))}_start(){this.isOpening&&this._useAnimation&&this._placeholder&&"IMG"===this._placeholder.tagName?new Promise((i=>{let t=!1,s=!0;decodeImage(this._placeholder).finally((()=>{t=!0,s||i(!0)})),setTimeout((()=>{s=!1,t&&i(!0)}),50),setTimeout(i,250)})).finally((()=>this._initiate())):this._initiate()}_initiate(){this.pswp.element?.style.setProperty("--pswp-transition-duration",this._duration+"ms"),this.pswp.dispatch(this.isOpening?"openingAnimationStart":"closingAnimationStart"),this.pswp.dispatch("initialZoom"+(this.isOpening?"In":"Out")),this.pswp.element?.classList.toggle("pswp--ui-visible",this.isOpening),this.isOpening?(this._placeholder&&(this._placeholder.style.opacity="1"),this._animateToOpenState()):this.isClosing&&this._animateToClosedState(),this._useAnimation||this._onAnimationComplete()}_onAnimationComplete(){const{pswp:i}=this;this.isOpen=this.isOpening,this.isClosed=this.isClosing,this.isOpening=!1,this.isClosing=!1,i.dispatch(this.isOpen?"openingAnimationEnd":"closingAnimationEnd"),i.dispatch("initialZoom"+(this.isOpen?"InEnd":"OutEnd")),this.isClosed?i.destroy():this.isOpen&&(this._animateZoom&&i.container&&(i.container.style.overflow="visible",i.container.style.width="100%"),i.currSlide?.applyCurrentZoomPan())}_animateToOpenState(){const{pswp:i}=this;this._animateZoom&&(this._croppedZoom&&this._cropContainer1&&this._cropContainer2&&(this._animateTo(this._cropContainer1,"transform","translate3d(0,0,0)"),this._animateTo(this._cropContainer2,"transform","none")),i.currSlide&&(i.currSlide.zoomAndPanToInitial(),this._animateTo(i.currSlide.container,"transform",i.currSlide.getCurrentTransform()))),this._animateBgOpacity&&i.bg&&this._animateTo(i.bg,"opacity",String(i.options.bgOpacity)),this._animateRootOpacity&&i.element&&this._animateTo(i.element,"opacity","1")}_animateToClosedState(){const{pswp:i}=this;this._animateZoom&&this._setClosedStateZoomPan(!0),this._animateBgOpacity&&i.bgOpacity>.01&&i.bg&&this._animateTo(i.bg,"opacity","0"),this._animateRootOpacity&&i.element&&this._animateTo(i.element,"opacity","0")}_setClosedStateZoomPan(i){if(!this._thumbBounds)return;const{pswp:t}=this,{innerRect:s}=this._thumbBounds,{currSlide:n,viewportSize:o}=t;if(this._croppedZoom&&s&&this._cropContainer1&&this._cropContainer2){const t=-o.x+(this._thumbBounds.x-s.x)+s.w,n=-o.y+(this._thumbBounds.y-s.y)+s.h,e=o.x-s.w,a=o.y-s.h;i?(this._animateTo(this._cropContainer1,"transform",toTransformString(t,n)),this._animateTo(this._cropContainer2,"transform",toTransformString(e,a))):(setTransform(this._cropContainer1,t,n),setTransform(this._cropContainer2,e,a))}n&&(equalizePoints(n.pan,s||this._thumbBounds),n.currZoomLevel=this._thumbBounds.w/n.width,i?this._animateTo(n.container,"transform",n.getCurrentTransform()):n.applyCurrentZoomPan())}_animateTo(i,t,s){if(!this._duration)return void(i.style[t]=s);const{animations:n}=this.pswp,o={duration:this._duration,easing:this.pswp.options.easing,onComplete:()=>{n.activeAnimations.length||this._onAnimationComplete()},target:i};o[t]=s,n.startTransition(o)}}export default Opener;