#!/usr/bin/env node
var e=!1,n=!1;import r from"fs";import t from"child_process";import i from"path";import o from"chalk";import a from"enquirer";var s,c,u,p,g=a.prompt,l="main",m="win32"===process.platform?"grunt.cmd":"grunt",f="win32"===process.platform?"npm.cmd":"npm",d="README.md",h="package.json",v=i.join("src","version.js"),y="CDN";function j(e){R(m,[],(function(n,r,t){n&&U(n+t),q(r||"(no output)"),e()}))}function b(n,t){var i,o,a,s;O("Updating "+h+" version to "+n),t=t||n,p.version=n,p.author.url=(i=p.author.url,o=t,i.replace(/\/blob\/(?:(\d+\.\d+[^\/]+)|main)/,"/blob/"+o)),a=h,s=p,e?console.log(JSON.stringify(s,null,"  ")):r.writeFileSync(a,JSON.stringify(s,null,"\t")+"\n")}function S(n){var t='\njQuery.migrateVersion = "'+n+'";\n';O("Updating "+t.replace(/\n/g,"")),e||r.writeFileSync(v,t)}function E(e){var n=new RegExp("^//# sourceMappingURL=jquery-migrate.min.map\\n?","m"),r=e.replace(n,"");if(e===r)throw Error("fixMinRef: Unable to find the sourceMappingURL");return r}function w(e,n){var r=JSON.parse(e),t=r.sources;if("../src/migratemute.js,jquery-migrate.js"!==t.join())throw Error("fixMapRef: Unexpected sources entry: "+t);return t[0]="migratemute.js",t[1]=n.replace(/\.map$/,".js"),JSON.stringify(r)}function x(e,n,r){R("git",e,n,r)}function R(n,r,i,a){e||a?(q(o.black.bgBlue("# "+n+" "+r.join(" "))),i()):(q(o.green(n+" "+r.join(" "))),t.execFile(n,r,{env:process.env},(function(e,n,r){e&&U(r||n||e),i()})))}function O(e){console.log(o.black.bgGreen(e))}function q(e){console.log(e)}function U(e){console.error(o.red("ERROR: "+e)),process.exit(1)}!function(){var e=0,n=arguments;!function r(){process.nextTick((function(){n[e++](r)}))}()}((function(t){"-d"===process.argv[2]&&(process.argv.shift(),e=!0,console.warn("=== DRY RUN MODE ==="));"-r"===process.argv[2]&&(process.argv.shift(),n=!0,console.warn("=== SKIPREMOTE MODE ==="));var o,a=/^(\d+)\.(\d+)\.(\d+)(?:-([\dA-Za-z\-]+(?:\.[\dA-Za-z\-]+)*))?$/,g=a.exec(process.argv[2]||"")||[],l=g[1],m=g[2],f=g[3],d=g[4];s=process.argv[2],u=!!d,s||(q("Usage: release [ -d -r ] releaseVersion"),q("       -d  Dry-run; no commands are executed at all"),q("       -r  Skip-remote; nothing is pushed externally"),U("Invalid args"));g.length||U("'"+s+"' is not a valid semver!");"pre"===d&&U("Cannot release a 'pre' version!");(r.existsSync||i.existsSync)(h)||U("No "+h+" in this directory");O("Current version is "+(p=JSON.parse(r.readFileSync(h))).version+"; generating release "+s),g=a.exec(p.version),o=1e4*+g[1]+100*+g[2]+ +g[3],1e4*+l+100*+m+ +f<o&&U("Next version is older than current version!");c=l+"."+m+"."+(u?f:+f+1)+"-pre",t()}),(function(e){t.execFile("git",["status"],(function(n,r){if(n)throw n;var t=((r||"").match(/On branch (\S+)/)||[])[1];t!==l&&U("Branches don't match: Wanted main, got "+t),/Changes to be committed/i.test(r)&&U("Please commit changed files before attemping to push a release."),/Changes not staged for commit/i.test(r)&&U("Please stash files before attempting to push a release."),e()}))}),j,(function(n){S(s),t=r.readFileSync(d,"utf8"),u?O("Skipping "+d+" update (beta release)"):(O("Updating "+d),t=t.replace(/jquery-migrate-\d+\.\d+\.\d+(?:-\w+)?/g,"jquery-migrate-"+s),e||r.writeFileSync(d,t)),b(s),n();var t}),(function(e){x(["commit","-a","--no-verify","-m","Tagging the "+s+" release."],(function(){x(["tag",s],e)}))}),j,(function(n){r.existsSync(y)||r.mkdirSync(y);var t={"jquery-migrate-VER.js":function(e){return e},"jquery-migrate-VER.min.js":E,"jquery-migrate-VER.min.map":w};Object.keys(t).forEach((function(n){var o=n.replace(/-VER/g,""),a=i.join("dist",o),c=n.replace(/VER/g,s),u=i.join(y,c);q("Processing "+a+" => "+u);var p=r.readFileSync(a,"utf8").replace(/\r\n/g,"\n"),g=t[n](p,c);e||r.writeFileSync(u,g)})),n()}),(async function(e){const{input:r}=await g({type:"input",name:"input",message:"Enter one-time password if you have 2FA enabled and press Enter.\nOtherwise, just press Enter."});R(f,u?["publish","--tag","beta",...r?["--otp",r]:[]]:["publish",...r?["--otp",r]:[]],e,n)}),(function(e){S(c),b(c,"main"),x(["commit","-a","--no-verify","-m","Updating the source version to "+c],e)}),(function(e){x(["push","--tags","git@github.com:jquery/jquery-migrate.git",l],e,n)}),(function(e){console.log(o.red("TODO: Update CDN with jquery-migrate."+s+" files (min and regular)")),console.log(o.red("  clone codeorigin.jquery.com, git add files, commit, push")),e()}),(function(e){console.log(o.red("TODO: Update jquery.com download page to "+s)),e()}),(function(){process.exit(0)}));