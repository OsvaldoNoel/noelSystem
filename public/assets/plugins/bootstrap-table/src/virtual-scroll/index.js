const BLOCK_ROWS=50,CLUSTER_BLOCKS=4;class VirtualScroll{constructor(t){this.rows=t.rows,this.scrollEl=t.scrollEl,this.contentEl=t.contentEl,this.callback=t.callback,this.itemHeight=t.itemHeight,this.cache={},this.scrollTop=this.scrollEl.scrollTop,this.initDOM(this.rows,t.fixedScroll),this.scrollEl.scrollTop=this.scrollTop,this.lastCluster=0;const s=()=>{this.lastCluster!==(this.lastCluster=this.getNum())&&(this.initDOM(this.rows),this.callback(this.startIndex,this.endIndex))};this.scrollEl.addEventListener("scroll",s,!1),this.destroy=()=>{this.contentEl.innerHtml="",this.scrollEl.removeEventListener("scroll",s,!1)}}initDOM(t,s){void 0===this.clusterHeight?(this.cache.scrollTop=this.scrollEl.scrollTop,this.cache.data=this.contentEl.innerHTML=t[0]+t[0]+t[0],this.getRowsHeight(t)):0===this.blockHeight&&this.getRowsHeight(t);const e=this.initData(t,this.getNum(s)),i=e.rows.join(""),h=this.checkChanges("data",i),o=this.checkChanges("top",e.topOffset),l=this.checkChanges("bottom",e.bottomOffset),c=[];h&&o?(e.topOffset&&c.push(this.getExtra("top",e.topOffset)),c.push(i),e.bottomOffset&&c.push(this.getExtra("bottom",e.bottomOffset)),this.startIndex=e.start,this.endIndex=e.end,this.contentEl.innerHTML=c.join(""),s&&(this.contentEl.scrollTop=this.cache.scrollTop)):l&&(this.contentEl.lastChild.style.height=`${e.bottomOffset}px`)}getRowsHeight(){if(void 0===this.itemHeight||0===this.itemHeight){const t=this.contentEl.children,s=t[Math.floor(t.length/2)];this.itemHeight=s.offsetHeight}this.blockHeight=50*this.itemHeight,this.clusterRows=200,this.clusterHeight=4*this.blockHeight}getNum(t){return this.scrollTop=t?this.cache.scrollTop:this.scrollEl.scrollTop,Math.floor(this.scrollTop/(this.clusterHeight-this.blockHeight))||0}initData(t,s){if(t.length<50)return{topOffset:0,bottomOffset:0,rowsAbove:0,rows:t};const e=Math.max((this.clusterRows-50)*s,0),i=e+this.clusterRows,h=Math.max(e*this.itemHeight,0),o=Math.max((t.length-i)*this.itemHeight,0),l=[];let c=e;h<1&&c++;for(let s=e;s<i;s++)t[s]&&l.push(t[s]);return{start:e,end:i,topOffset:h,bottomOffset:o,rowsAbove:c,rows:l}}checkChanges(t,s){const e=s!==this.cache[t];return this.cache[t]=s,e}getExtra(t,s){const e=document.createElement("tr");return e.className=`virtual-scroll-${t}`,s&&(e.style.height=`${s}px`),e.outerHTML}}export default VirtualScroll;