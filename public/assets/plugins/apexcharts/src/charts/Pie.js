import Animations from"../modules/Animations";import Fill from"../modules/Fill";import Utils from"../utils/Utils";import Graphics from"../modules/Graphics";import Filters from"../modules/Filters";import Scales from"../modules/Scales";import Helpers from"./common/circle/Helpers";class Pie{constructor(t){this.ctx=t,this.w=t.w;const e=this.w;this.chartType=this.w.config.chart.type,this.initialAnim=this.w.config.chart.animations.enabled,this.dynamicAnim=this.initialAnim&&this.w.config.chart.animations.dynamicAnimation.enabled,this.animBeginArr=[0],this.animDur=0,this.donutDataLabels=this.w.config.plotOptions.pie.donut.labels,this.lineColorArr=void 0!==e.globals.stroke.colors?e.globals.stroke.colors:e.globals.colors,this.defaultSize=Math.min(e.globals.gridWidth,e.globals.gridHeight),this.centerY=this.defaultSize/2,this.centerX=e.globals.gridWidth/2,"radialBar"===e.config.chart.type?this.fullAngle=360:this.fullAngle=Math.abs(e.config.plotOptions.pie.endAngle-e.config.plotOptions.pie.startAngle),this.initialAngle=e.config.plotOptions.pie.startAngle%this.fullAngle,e.globals.radialSize=this.defaultSize/2.05-e.config.stroke.width-(e.config.chart.sparkline.enabled?0:e.config.chart.dropShadow.blur),this.donutSize=e.globals.radialSize*parseInt(e.config.plotOptions.pie.donut.size,10)/100;let a=e.config.plotOptions.pie.customScale,i=e.globals.gridWidth/2,s=e.globals.gridHeight/2;this.translateX=i-i*a,this.translateY=s-s*a,this.dataLabelsGroup=new Graphics(this.ctx).group({class:"apexcharts-datalabels-group",transform:`translate(${this.translateX}, ${this.translateY}) scale(${a})`}),this.maxY=0,this.sliceLabels=[],this.sliceSizes=[],this.prevSectorAngleArr=[]}draw(t){let e=this.w;const a=new Graphics(this.ctx);let i=a.group({class:"apexcharts-pie"});if(e.globals.noData)return i;let s=0;for(let e=0;e<t.length;e++)s+=Utils.negToZero(t[e]);let l=[],n=a.group();0===s&&(s=1e-5),t.forEach((t=>{this.maxY=Math.max(this.maxY,t)})),e.config.yaxis[0].max&&(this.maxY=e.config.yaxis[0].max),"back"===e.config.grid.position&&"polarArea"===this.chartType&&this.drawPolarElements(i);for(let a=0;a<t.length;a++){let i=this.fullAngle*Utils.negToZero(t[a])/s;l.push(i),"polarArea"===this.chartType?(l[a]=this.fullAngle/t.length,this.sliceSizes.push(e.globals.radialSize*t[a]/this.maxY)):this.sliceSizes.push(e.globals.radialSize)}if(e.globals.dataChanged){let t,a=0;for(let t=0;t<e.globals.previousPaths.length;t++)a+=Utils.negToZero(e.globals.previousPaths[t]);for(let i=0;i<e.globals.previousPaths.length;i++)t=this.fullAngle*Utils.negToZero(e.globals.previousPaths[i])/a,this.prevSectorAngleArr.push(t)}if(this.donutSize<0&&(this.donutSize=0),"donut"===this.chartType){const t=a.drawCircle(this.donutSize);t.attr({cx:this.centerX,cy:this.centerY,fill:e.config.plotOptions.pie.donut.background?e.config.plotOptions.pie.donut.background:"transparent"}),n.add(t)}let r=this.drawArcs(l,t);if(this.sliceLabels.forEach((t=>{r.add(t)})),n.attr({transform:`translate(${this.translateX}, ${this.translateY}) scale(${e.config.plotOptions.pie.customScale})`}),n.add(r),i.add(n),this.donutDataLabels.show){let t=this.renderInnerDataLabels(this.dataLabelsGroup,this.donutDataLabels,{hollowSize:this.donutSize,centerX:this.centerX,centerY:this.centerY,opacity:this.donutDataLabels.show});i.add(t)}return"front"===e.config.grid.position&&"polarArea"===this.chartType&&this.drawPolarElements(i),i}drawArcs(t,e){let a=this.w;const i=new Filters(this.ctx);let s=new Graphics(this.ctx),l=new Fill(this.ctx),n=s.group({class:"apexcharts-slices"}),r=this.initialAngle,o=this.initialAngle,h=this.initialAngle,d=this.initialAngle;this.strokeWidth=a.config.stroke.show?a.config.stroke.width:0;for(let c=0;c<t.length;c++){let g=s.group({class:"apexcharts-series apexcharts-pie-series",seriesName:Utils.escapeString(a.globals.seriesNames[c]),rel:c+1,"data:realIndex":c});n.add(g),r=h,o=d,h=r+t[c],d=o+this.prevSectorAngleArr[c];const p=h<r?this.fullAngle+h-r:h-r;let f=l.fillPath({seriesNumber:c,size:this.sliceSizes[c],value:e[c]}),u=this.getChangedPath(o,d),m=s.drawPath({d:u,stroke:Array.isArray(this.lineColorArr)?this.lineColorArr[c]:this.lineColorArr,strokeWidth:0,fill:f,fillOpacity:a.config.fill.opacity,classes:`apexcharts-pie-area apexcharts-${this.chartType.toLowerCase()}-slice-${c}`});if(m.attr({index:0,j:c}),i.setSelectionFilter(m,0,c),a.config.chart.dropShadow.enabled){const t=a.config.chart.dropShadow;i.dropShadow(m,t,c)}this.addListeners(m,this.donutDataLabels),Graphics.setAttrs(m.node,{"data:angle":p,"data:startAngle":r,"data:strokeWidth":this.strokeWidth,"data:value":e[c]});let A={x:0,y:0};"pie"===this.chartType||"polarArea"===this.chartType?A=Utils.polarToCartesian(this.centerX,this.centerY,a.globals.radialSize/1.25+a.config.plotOptions.pie.dataLabels.offset,(r+p/2)%this.fullAngle):"donut"===this.chartType&&(A=Utils.polarToCartesian(this.centerX,this.centerY,(a.globals.radialSize+this.donutSize)/2+a.config.plotOptions.pie.dataLabels.offset,(r+p/2)%this.fullAngle)),g.add(m);let b=0;if(!this.initialAnim||a.globals.resized||a.globals.dataChanged?this.animBeginArr.push(0):(b=p/this.fullAngle*a.config.chart.animations.speed,0===b&&(b=1),this.animDur=b+this.animDur,this.animBeginArr.push(this.animDur)),this.dynamicAnim&&a.globals.dataChanged?this.animatePaths(m,{size:this.sliceSizes[c],endAngle:h,startAngle:r,prevStartAngle:o,prevEndAngle:d,animateStartingPos:!0,i:c,animBeginArr:this.animBeginArr,shouldSetPrevPaths:!0,dur:a.config.chart.animations.dynamicAnimation.speed}):this.animatePaths(m,{size:this.sliceSizes[c],endAngle:h,startAngle:r,i:c,totalItems:t.length-1,animBeginArr:this.animBeginArr,dur:b}),a.config.plotOptions.pie.expandOnClick&&"polarArea"!==this.chartType&&m.node.addEventListener("mouseup",this.pieClicked.bind(this,c)),void 0!==a.globals.selectedDataPoints[0]&&a.globals.selectedDataPoints[0].indexOf(c)>-1&&this.pieClicked(c),a.config.dataLabels.enabled){let e=A.x,l=A.y,n=100*p/this.fullAngle+"%";if(0!==p&&a.config.plotOptions.pie.dataLabels.minAngleToShowLabel<t[c]){let t=a.config.dataLabels.formatter;void 0!==t&&(n=t(a.globals.seriesPercent[c][0],{seriesIndex:c,w:a}));let r=a.globals.dataLabels.style.colors[c];const o=s.group({class:"apexcharts-datalabels"});let h=s.drawText({x:e,y:l,text:n,textAnchor:"middle",fontSize:a.config.dataLabels.style.fontSize,fontFamily:a.config.dataLabels.style.fontFamily,fontWeight:a.config.dataLabels.style.fontWeight,foreColor:r});if(o.add(h),a.config.dataLabels.dropShadow.enabled){const t=a.config.dataLabels.dropShadow;i.dropShadow(h,t)}h.node.classList.add("apexcharts-pie-label"),a.config.chart.animations.animate&&!1===a.globals.resized&&(h.node.classList.add("apexcharts-pie-label-delay"),h.node.style.animationDelay=a.config.chart.animations.speed/940+"s"),this.sliceLabels.push(o)}}}return n}addListeners(t,e){const a=new Graphics(this.ctx);t.node.addEventListener("mouseenter",a.pathMouseEnter.bind(this,t)),t.node.addEventListener("mouseleave",a.pathMouseLeave.bind(this,t)),t.node.addEventListener("mouseleave",this.revertDataLabelsInner.bind(this,t.node,e)),t.node.addEventListener("mousedown",a.pathMouseDown.bind(this,t)),this.donutDataLabels.total.showAlways||(t.node.addEventListener("mouseenter",this.printDataLabelsInner.bind(this,t.node,e)),t.node.addEventListener("mousedown",this.printDataLabelsInner.bind(this,t.node,e)))}animatePaths(t,e){let a=this.w,i=e.endAngle<e.startAngle?this.fullAngle+e.endAngle-e.startAngle:e.endAngle-e.startAngle,s=i,l=e.startAngle,n=e.startAngle;void 0!==e.prevStartAngle&&void 0!==e.prevEndAngle&&(l=e.prevEndAngle,s=e.prevEndAngle<e.prevStartAngle?this.fullAngle+e.prevEndAngle-e.prevStartAngle:e.prevEndAngle-e.prevStartAngle),e.i===a.config.series.length-1&&(i+n>this.fullAngle?e.endAngle=e.endAngle-(i+n):i+n<this.fullAngle&&(e.endAngle=e.endAngle+(this.fullAngle-(i+n)))),i===this.fullAngle&&(i=this.fullAngle-.01),this.animateArc(t,l,n,i,s,e)}animateArc(t,e,a,i,s,l){let n=this;const r=this.w,o=new Animations(this.ctx);let h,d=l.size;(isNaN(e)||isNaN(s))&&(e=a,s=i,l.dur=0);let c=i,g=a,p=e<a?this.fullAngle+e-a:e-a;r.globals.dataChanged&&l.shouldSetPrevPaths&&l.prevEndAngle&&(h=n.getPiePath({me:n,startAngle:l.prevStartAngle,angle:l.prevEndAngle<l.prevStartAngle?this.fullAngle+l.prevEndAngle-l.prevStartAngle:l.prevEndAngle-l.prevStartAngle,size:d}),t.attr({d:h})),0!==l.dur?t.animate(l.dur,r.globals.easing,l.animBeginArr[l.i]).afterAll((function(){"pie"!==n.chartType&&"donut"!==n.chartType&&"polarArea"!==n.chartType||this.animate(r.config.chart.animations.dynamicAnimation.speed).attr({"stroke-width":n.strokeWidth}),l.i===r.config.series.length-1&&o.animationCompleted(t)})).during((r=>{c=p+(i-p)*r,l.animateStartingPos&&(c=s+(i-s)*r,g=e-s+(a-(e-s))*r),h=n.getPiePath({me:n,startAngle:g,angle:c,size:d}),t.node.setAttribute("data:pathOrig",h),t.attr({d:h})})):(h=n.getPiePath({me:n,startAngle:g,angle:i,size:d}),l.isTrack||(r.globals.animationEnded=!0),t.node.setAttribute("data:pathOrig",h),t.attr({d:h,"stroke-width":n.strokeWidth}))}pieClicked(t){let e,a=this.w,i=this,s=i.sliceSizes[t]+(a.config.plotOptions.pie.expandOnClick?4:0),l=a.globals.dom.Paper.select(`.apexcharts-${i.chartType.toLowerCase()}-slice-${t}`).members[0];if("true"===l.attr("data:pieClicked")){l.attr({"data:pieClicked":"false"}),this.revertDataLabelsInner(l.node,this.donutDataLabels);let t=l.attr("data:pathOrig");return void l.attr({d:t})}{let e=a.globals.dom.baseEl.getElementsByClassName("apexcharts-pie-area");Array.prototype.forEach.call(e,(t=>{t.setAttribute("data:pieClicked","false");let e=t.getAttribute("data:pathOrig");e&&t.setAttribute("d",e)})),a.globals.capturedDataPointIndex=t,l.attr("data:pieClicked","true")}let n=parseInt(l.attr("data:startAngle"),10),r=parseInt(l.attr("data:angle"),10);e=i.getPiePath({me:i,startAngle:n,angle:r,size:s}),360!==r&&l.plot(e)}getChangedPath(t,e){let a="";return this.dynamicAnim&&this.w.globals.dataChanged&&(a=this.getPiePath({me:this,startAngle:t,angle:e-t,size:this.size})),a}getPiePath({me:t,startAngle:e,angle:a,size:i}){let s;const l=new Graphics(this.ctx);let n=e,r=Math.PI*(n-90)/180,o=a+e;Math.ceil(o)>=this.fullAngle+this.w.config.plotOptions.pie.startAngle%this.fullAngle&&(o=this.fullAngle+this.w.config.plotOptions.pie.startAngle%this.fullAngle-.01),Math.ceil(o)>this.fullAngle&&(o-=this.fullAngle);let h=Math.PI*(o-90)/180,d=t.centerX+i*Math.cos(r),c=t.centerY+i*Math.sin(r),g=t.centerX+i*Math.cos(h),p=t.centerY+i*Math.sin(h),f=Utils.polarToCartesian(t.centerX,t.centerY,t.donutSize,o),u=Utils.polarToCartesian(t.centerX,t.centerY,t.donutSize,n),m=a>180?1:0;const A=["M",d,c,"A",i,i,0,m,1,g,p];return s="donut"===t.chartType?[...A,"L",f.x,f.y,"A",t.donutSize,t.donutSize,0,m,0,u.x,u.y,"L",d,c,"z"].join(" "):"pie"===t.chartType||"polarArea"===t.chartType?[...A,"L",t.centerX,t.centerY,"L",d,c].join(" "):[...A].join(" "),l.roundPathCorners(s,2*this.strokeWidth)}drawPolarElements(t){const e=this.w,a=new Scales(this.ctx),i=new Graphics(this.ctx),s=new Helpers(this.ctx),l=i.group(),n=i.group(),r=a.niceScale(0,Math.ceil(this.maxY),0),o=r.result.reverse();let h=r.result.length;this.maxY=r.niceMax;let d=e.globals.radialSize,c=d/(h-1);for(let t=0;t<h-1;t++){const a=i.drawCircle(d);if(a.attr({cx:this.centerX,cy:this.centerY,fill:"none","stroke-width":e.config.plotOptions.polarArea.rings.strokeWidth,stroke:e.config.plotOptions.polarArea.rings.strokeColor}),e.config.yaxis[0].show){const a=s.drawYAxisTexts(this.centerX,this.centerY-d+parseInt(e.config.yaxis[0].labels.style.fontSize,10)/2,t,o[t]);n.add(a)}l.add(a),d-=c}this.drawSpokes(t),t.add(l),t.add(n)}renderInnerDataLabels(t,e,a){let i=this.w;const s=new Graphics(this.ctx),l=e.total.show;t.node.innerHTML="",t.node.style.opacity=a.opacity;let n,r,o=a.centerX,h=a.centerY;n=void 0===e.name.color?i.globals.colors[0]:e.name.color;let d=e.name.fontSize,c=e.name.fontFamily,g=e.name.fontWeight;r=void 0===e.value.color?i.config.chart.foreColor:e.value.color;let p=e.value.formatter,f="",u="";if(l?(n=e.total.color,d=e.total.fontSize,c=e.total.fontFamily,g=e.total.fontWeight,u=e.total.label,f=e.total.formatter(i)):1===i.globals.series.length&&(f=p(i.globals.series[0],i),u=i.globals.seriesNames[0]),u&&(u=e.name.formatter(u,e.total.show,i)),e.name.show){let a=s.drawText({x:o,y:h+parseFloat(e.name.offsetY),text:u,textAnchor:"middle",foreColor:n,fontSize:d,fontWeight:g,fontFamily:c});a.node.classList.add("apexcharts-datalabel-label"),t.add(a)}if(e.value.show){let a=e.name.show?parseFloat(e.value.offsetY)+16:e.value.offsetY,i=s.drawText({x:o,y:h+a,text:f,textAnchor:"middle",foreColor:r,fontWeight:e.value.fontWeight,fontSize:e.value.fontSize,fontFamily:e.value.fontFamily});i.node.classList.add("apexcharts-datalabel-value"),t.add(i)}return t}printInnerLabels(t,e,a,i){const s=this.w;let l;i?l=void 0===t.name.color?s.globals.colors[parseInt(i.parentNode.getAttribute("rel"),10)-1]:t.name.color:s.globals.series.length>1&&t.total.show&&(l=t.total.color);let n=s.globals.dom.baseEl.querySelector(".apexcharts-datalabel-label"),r=s.globals.dom.baseEl.querySelector(".apexcharts-datalabel-value");a=(0,t.value.formatter)(a,s),i||"function"!=typeof t.total.formatter||(a=t.total.formatter(s));const o=e===t.total.label;e=t.name.formatter(e,o,s),null!==n&&(n.textContent=e),null!==r&&(r.textContent=a),null!==n&&(n.style.fill=l)}printDataLabelsInner(t,e){let a=this.w,i=t.getAttribute("data:value"),s=a.globals.seriesNames[parseInt(t.parentNode.getAttribute("rel"),10)-1];a.globals.series.length>1&&this.printInnerLabels(e,s,i,t);let l=a.globals.dom.baseEl.querySelector(".apexcharts-datalabels-group");null!==l&&(l.style.opacity=1)}drawSpokes(t){const e=this.w,a=new Graphics(this.ctx),i=e.config.plotOptions.polarArea.spokes;if(0===i.strokeWidth)return;let s=[],l=360/e.globals.series.length;for(let t=0;t<e.globals.series.length;t++)s.push(Utils.polarToCartesian(this.centerX,this.centerY,e.globals.radialSize,e.config.plotOptions.pie.startAngle+l*t));s.forEach(((e,s)=>{const l=a.drawLine(e.x,e.y,this.centerX,this.centerY,Array.isArray(i.connectorColors)?i.connectorColors[s]:i.connectorColors);t.add(l)}))}revertDataLabelsInner(){const t=this.w;if(this.donutDataLabels.show){let e=t.globals.dom.Paper.select(".apexcharts-datalabels-group").members[0],a=this.renderInnerDataLabels(e,this.donutDataLabels,{hollowSize:this.donutSize,centerX:this.centerX,centerY:this.centerY,opacity:this.donutDataLabels.show});t.globals.dom.Paper.select(".apexcharts-radialbar, .apexcharts-pie").members[0].add(a)}}}export default Pie;