import Pie from"./Pie";import Utils from"../utils/Utils";import Fill from"../modules/Fill";import Graphics from"../modules/Graphics";import Filters from"../modules/Filters";class Radial extends Pie{constructor(a){super(a),this.ctx=a,this.w=a.w,this.animBeginArr=[0],this.animDur=0;const t=this.w;this.startAngle=t.config.plotOptions.radialBar.startAngle,this.endAngle=t.config.plotOptions.radialBar.endAngle,this.totalAngle=Math.abs(t.config.plotOptions.radialBar.endAngle-t.config.plotOptions.radialBar.startAngle),this.trackStartAngle=t.config.plotOptions.radialBar.track.startAngle,this.trackEndAngle=t.config.plotOptions.radialBar.track.endAngle,this.barLabels=this.w.config.plotOptions.radialBar.barLabels,this.donutDataLabels=this.w.config.plotOptions.radialBar.dataLabels,this.radialDataLabels=this.donutDataLabels,this.trackStartAngle||(this.trackStartAngle=this.startAngle),this.trackEndAngle||(this.trackEndAngle=this.endAngle),360===this.endAngle&&(this.endAngle=359.99),this.margin=parseInt(t.config.plotOptions.radialBar.track.margin,10),this.onBarLabelClick=this.onBarLabelClick.bind(this)}draw(a){let t=this.w;const e=new Graphics(this.ctx);let i=e.group({class:"apexcharts-radialbar"});if(t.globals.noData)return i;let s=e.group(),r=this.defaultSize/2,l=t.globals.gridWidth/2,o=this.defaultSize/2.05;t.config.chart.sparkline.enabled||(o=o-t.config.stroke.width-t.config.chart.dropShadow.blur);let n=t.globals.fill.colors;if(t.config.plotOptions.radialBar.track.show){let t=this.drawTracks({size:o,centerX:l,centerY:r,colorArr:n,series:a});s.add(t)}let d=this.drawArcs({size:o,centerX:l,centerY:r,colorArr:n,series:a}),h=360;t.config.plotOptions.radialBar.startAngle<0&&(h=this.totalAngle);let c=(360-h)/360;if(t.globals.radialSize=o-o*c,this.radialDataLabels.value.show){let a=Math.max(this.radialDataLabels.value.offsetY,this.radialDataLabels.name.offsetY);t.globals.radialSize+=a*c}return s.add(d.g),"front"===t.config.plotOptions.radialBar.hollow.position&&(d.g.add(d.elHollow),d.dataLabels&&d.g.add(d.dataLabels)),i.add(s),i}drawTracks(a){let t=this.w;const e=new Graphics(this.ctx);let i=e.group({class:"apexcharts-tracks"}),s=new Filters(this.ctx),r=new Fill(this.ctx),l=this.getStrokeWidth(a);a.size=a.size-l/2;for(let o=0;o<a.series.length;o++){let n=e.group({class:"apexcharts-radialbar-track apexcharts-track"});i.add(n),n.attr({rel:o+1}),a.size=a.size-l-this.margin;const d=t.config.plotOptions.radialBar.track;let h=r.fillPath({seriesNumber:0,size:a.size,fillColors:Array.isArray(d.background)?d.background[o]:d.background,solid:!0}),c=this.trackStartAngle,g=this.trackEndAngle;Math.abs(g)+Math.abs(c)>=360&&(g=360-Math.abs(this.startAngle)-.1);let p=e.drawPath({d:"",stroke:h,strokeWidth:l*parseInt(d.strokeWidth,10)/100,fill:"none",strokeOpacity:d.opacity,classes:"apexcharts-radialbar-area"});if(d.dropShadow.enabled){const a=d.dropShadow;s.dropShadow(p,a)}n.add(p),p.attr("id","apexcharts-radialbarTrack-"+o),this.animatePaths(p,{centerX:a.centerX,centerY:a.centerY,endAngle:g,startAngle:c,size:a.size,i:o,totalItems:2,animBeginArr:0,dur:0,isTrack:!0,easing:t.globals.easing})}return i}drawArcs(a){let t=this.w,e=new Graphics(this.ctx),i=new Fill(this.ctx),s=new Filters(this.ctx),r=e.group(),l=this.getStrokeWidth(a);a.size=a.size-l/2;let o=t.config.plotOptions.radialBar.hollow.background,n=a.size-l*a.series.length-this.margin*a.series.length-l*parseInt(t.config.plotOptions.radialBar.track.strokeWidth,10)/100/2,d=n-t.config.plotOptions.radialBar.hollow.margin;void 0!==t.config.plotOptions.radialBar.hollow.image&&(o=this.drawHollowImage(a,r,n,o));let h=this.drawHollow({size:d,centerX:a.centerX,centerY:a.centerY,fill:o||"transparent"});if(t.config.plotOptions.radialBar.hollow.dropShadow.enabled){const a=t.config.plotOptions.radialBar.hollow.dropShadow;s.dropShadow(h,a)}let c=1;!this.radialDataLabels.total.show&&t.globals.series.length>1&&(c=0);let g=null;if(this.radialDataLabels.show){let e=t.globals.dom.Paper.select(".apexcharts-datalabels-group").members[0];g=this.renderInnerDataLabels(e,this.radialDataLabels,{hollowSize:n,centerX:a.centerX,centerY:a.centerY,opacity:c})}"back"===t.config.plotOptions.radialBar.hollow.position&&(r.add(h),g&&r.add(g));let p=!1;t.config.plotOptions.radialBar.inverseOrder&&(p=!0);for(let o=p?a.series.length-1:0;p?o>=0:o<a.series.length;p?o--:o++){let n=e.group({class:"apexcharts-series apexcharts-radial-series",seriesName:Utils.escapeString(t.globals.seriesNames[o])});r.add(n),n.attr({rel:o+1,"data:realIndex":o}),this.ctx.series.addCollapsedClassToSeries(n,o),a.size=a.size-l-this.margin;let d,h=i.fillPath({seriesNumber:o,size:a.size,value:a.series[o]}),c=this.startAngle;const g=Utils.negToZero(a.series[o]>100?100:a.series[o])/100;let p,f=Math.round(this.totalAngle*g)+this.startAngle;t.globals.dataChanged&&(d=this.startAngle,p=Math.round(this.totalAngle*Utils.negToZero(t.globals.previousPaths[o])/100)+d);Math.abs(f)+Math.abs(c)>=360&&(f-=.01);Math.abs(p)+Math.abs(d)>=360&&(p-=.01);let b=f-c;const m=Array.isArray(t.config.stroke.dashArray)?t.config.stroke.dashArray[o]:t.config.stroke.dashArray;let w=e.drawPath({d:"",stroke:h,strokeWidth:l,fill:"none",fillOpacity:t.config.fill.opacity,classes:"apexcharts-radialbar-area apexcharts-radialbar-slice-"+o,strokeDashArray:m});if(Graphics.setAttrs(w.node,{"data:angle":b,"data:value":a.series[o]}),t.config.chart.dropShadow.enabled){const a=t.config.chart.dropShadow;s.dropShadow(w,a,o)}if(s.setSelectionFilter(w,0,o),this.addListeners(w,this.radialDataLabels),n.add(w),w.attr({index:0,j:o}),this.barLabels.enabled){let i=Utils.polarToCartesian(a.centerX,a.centerY,a.size,c),s=this.barLabels.formatter(t.globals.seriesNames[o],{seriesIndex:o,w:t}),r=["apexcharts-radialbar-label"];this.barLabels.onClick||r.push("apexcharts-no-click");let l=this.barLabels.useSeriesColors?t.globals.colors[o]:t.config.chart.foreColor;l||(l=t.config.chart.foreColor);const d=i.x-this.barLabels.margin,h=i.y;let g=e.drawText({x:d,y:h,text:s,textAnchor:"end",dominantBaseline:"middle",fontFamily:this.barLabels.fontFamily,fontWeight:this.barLabels.fontWeight,fontSize:this.barLabels.fontSize,foreColor:l,cssClass:r.join(" ")});g.on("click",this.onBarLabelClick),g.attr({rel:o+1}),0!==c&&g.attr({"transform-origin":`${d} ${h}`,transform:`rotate(${c} 0 0)`}),n.add(g)}let A=0;!this.initialAnim||t.globals.resized||t.globals.dataChanged||(A=t.config.chart.animations.speed),t.globals.dataChanged&&(A=t.config.chart.animations.dynamicAnimation.speed),this.animDur=A/(1.2*a.series.length)+this.animDur,this.animBeginArr.push(this.animDur),this.animatePaths(w,{centerX:a.centerX,centerY:a.centerY,endAngle:f,startAngle:c,prevEndAngle:p,prevStartAngle:d,size:a.size,i:o,totalItems:2,animBeginArr:this.animBeginArr,dur:A,shouldSetPrevPaths:!0,easing:t.globals.easing})}return{g:r,elHollow:h,dataLabels:g}}drawHollow(a){let t=new Graphics(this.ctx).drawCircle(2*a.size);return t.attr({class:"apexcharts-radialbar-hollow",cx:a.centerX,cy:a.centerY,r:a.size,fill:a.fill}),t}drawHollowImage(a,t,e,i){const s=this.w;let r=new Fill(this.ctx),l=Utils.randomId(),o=s.config.plotOptions.radialBar.hollow.image;if(s.config.plotOptions.radialBar.hollow.imageClipped)r.clippedImgArea({width:e,height:e,image:o,patternID:`pattern${s.globals.cuid}${l}`}),i=`url(#pattern${s.globals.cuid}${l})`;else{const e=s.config.plotOptions.radialBar.hollow.imageWidth,i=s.config.plotOptions.radialBar.hollow.imageHeight;if(void 0===e&&void 0===i){let e=s.globals.dom.Paper.image(o).loaded((function(t){this.move(a.centerX-t.width/2+s.config.plotOptions.radialBar.hollow.imageOffsetX,a.centerY-t.height/2+s.config.plotOptions.radialBar.hollow.imageOffsetY)}));t.add(e)}else{let r=s.globals.dom.Paper.image(o).loaded((function(t){this.move(a.centerX-e/2+s.config.plotOptions.radialBar.hollow.imageOffsetX,a.centerY-i/2+s.config.plotOptions.radialBar.hollow.imageOffsetY),this.size(e,i)}));t.add(r)}}return i}getStrokeWidth(a){const t=this.w;return a.size*(100-parseInt(t.config.plotOptions.radialBar.hollow.size,10))/100/(a.series.length+1)-this.margin}onBarLabelClick(a){let t=parseInt(a.target.getAttribute("rel"),10)-1;const e=this.barLabels.onClick,i=this.w;e&&e(i.globals.seriesNames[t],{w:i,seriesIndex:t})}}export default Radial;