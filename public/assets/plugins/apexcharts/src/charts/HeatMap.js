import Animations from"../modules/Animations";import Graphics from"../modules/Graphics";import Fill from"../modules/Fill";import Utils from"../utils/Utils";import Helpers from"./common/treemap/Helpers";import Filters from"../modules/Filters";export default class HeatMap{constructor(t,e){this.ctx=t,this.w=t.w,this.xRatio=e.xRatio,this.yRatio=e.yRatio,this.dynamicAnim=this.w.config.chart.animations.dynamicAnimation,this.helpers=new Helpers(t),this.rectRadius=this.w.config.plotOptions.heatmap.radius,this.strokeWidth=this.w.config.stroke.show?this.w.config.stroke.width:0}draw(t){let e=this.w;const i=new Graphics(this.ctx);let s=i.group({class:"apexcharts-heatmap"});s.attr("clip-path",`url(#gridRectMask${e.globals.cuid})`);let a=e.globals.gridWidth/e.globals.dataPoints,l=e.globals.gridHeight/e.globals.series.length,o=0,r=!1;this.negRange=this.helpers.checkColorRange();let h=t.slice();e.config.yaxis[0].reversed&&(r=!0,h.reverse());for(let n=r?0:h.length-1;r?n<h.length:n>=0;r?n++:n--){let r=i.group({class:"apexcharts-series apexcharts-heatmap-series",seriesName:Utils.escapeString(e.globals.seriesNames[n]),rel:n+1,"data:realIndex":n});if(this.ctx.series.addCollapsedClassToSeries(r,n),e.config.chart.dropShadow.enabled){const t=e.config.chart.dropShadow;new Filters(this.ctx).dropShadow(r,t,n)}let c=0,d=e.config.plotOptions.heatmap.shadeIntensity;for(let s=0;s<h[n].length;s++){let g=this.helpers.getShadeColor(e.config.chart.type,n,s,this.negRange),p=g.color,m=g.colorProps;if("image"===e.config.fill.type){p=new Fill(this.ctx).fillPath({seriesNumber:n,dataPointIndex:s,opacity:e.globals.hasNegs?m.percent<0?1-(1+m.percent/100):d+m.percent/100:m.percent/100,patternID:Utils.randomId(),width:e.config.fill.image.width?e.config.fill.image.width:a,height:e.config.fill.image.height?e.config.fill.image.height:l})}let f=this.rectRadius,x=i.drawRect(c,o,a,l,f);if(x.attr({cx:c,cy:o}),x.node.classList.add("apexcharts-heatmap-rect"),r.add(x),x.attr({fill:p,i:n,index:n,j:s,val:t[n][s],"stroke-width":this.strokeWidth,stroke:e.config.plotOptions.heatmap.useFillColorAsStroke?p:e.globals.stroke.colors[0],color:p}),this.helpers.addListeners(x),e.config.chart.animations.enabled&&!e.globals.dataChanged){let t=1;e.globals.resized||(t=e.config.chart.animations.speed),this.animateHeatMap(x,c,o,a,l,t)}if(e.globals.dataChanged){let t=1;if(this.dynamicAnim.enabled&&e.globals.shouldAnimate){t=this.dynamicAnim.speed;let i=e.globals.previousPaths[n]&&e.globals.previousPaths[n][s]&&e.globals.previousPaths[n][s].color;i||(i="rgba(255, 255, 255, 0)"),this.animateHeatColor(x,Utils.isColorHex(i)?i:Utils.rgb2hex(i),Utils.isColorHex(p)?p:Utils.rgb2hex(p),t)}}let b=(0,e.config.dataLabels.formatter)(e.globals.series[n][s],{value:e.globals.series[n][s],seriesIndex:n,dataPointIndex:s,w:e}),u=this.helpers.calculateDataLabels({text:b,x:c+a/2,y:o+l/2,i:n,j:s,colorProps:m,series:h});null!==u&&r.add(u),c+=a}o+=l,s.add(r)}let n=e.globals.yAxisScale[0].result.slice();return e.config.yaxis[0].reversed?n.unshift(""):n.push(""),e.globals.yAxisScale[0].result=n,s}animateHeatMap(t,e,i,s,a,l){const o=new Animations(this.ctx);o.animateRect(t,{x:e+s/2,y:i+a/2,width:0,height:0},{x:e,y:i,width:s,height:a},l,(()=>{o.animationCompleted(t)}))}animateHeatColor(t,e,i,s){t.attr({fill:e}).animate(s).attr({fill:i})}}