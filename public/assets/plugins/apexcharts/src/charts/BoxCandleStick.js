import CoreUtils from"../modules/CoreUtils";import Bar from"./Bar";import Fill from"../modules/Fill";import Graphics from"../modules/Graphics";import Utils from"../utils/Utils";class BoxCandleStick extends Bar{draw(i,e,s){let l=this.w,t=new Graphics(this.ctx),o=l.globals.comboCharts?e:l.config.chart.type,r=new Fill(this.ctx);this.candlestickOptions=this.w.config.plotOptions.candlestick,this.boxOptions=this.w.config.plotOptions.boxPlot,this.isHorizontal=l.config.plotOptions.bar.horizontal;const a=new CoreUtils(this.ctx,l);i=a.getLogSeries(i),this.series=i,this.yRatio=a.getLogYRatios(this.yRatio),this.barHelpers.initVariables(i);let n=t.group({class:`apexcharts-${o}-series apexcharts-plot-series`});for(let e=0;e<i.length;e++){let o,a,h,c,p,d;this.isBoxPlot="boxPlot"===l.config.chart.type||"boxPlot"===l.config.series[e].type;let x=[],b=[],g=l.globals.comboCharts?s[e]:e,{columnGroupIndex:m}=this.barHelpers.getGroupIndex(g),u=t.group({class:"apexcharts-series",seriesName:Utils.escapeString(l.globals.seriesNames[g]),rel:e+1,"data:realIndex":g});this.ctx.series.addCollapsedClassToSeries(u,g),i[e].length>0&&(this.visibleI=this.visibleI+1);let v=0,P=0,C=0;this.yRatio.length>1&&(this.yaxisIndex=l.globals.seriesYAxisReverseMap[g][0],C=g);let w=this.barHelpers.initialPositions();a=w.y,v=w.barHeight,c=w.yDivision,d=w.zeroW,o=w.x,P=w.barWidth,h=w.xDivision,p=w.zeroH,b.push(o+P/2);let y=t.group({class:"apexcharts-datalabels","data:realIndex":g});for(let s=0;s<l.globals.dataPoints;s++){const t=this.barHelpers.getStrokeWidth(e,s,g);let n=null;const w={indexes:{i:e,j:s,realIndex:g,translationsIndex:C},x:o,y:a,strokeWidth:t,elSeries:u};n=this.isHorizontal?this.drawHorizontalBoxPaths({...w,yDivision:c,barHeight:v,zeroW:d}):this.drawVerticalBoxPaths({...w,xDivision:h,barWidth:P,zeroH:p}),a=n.y,o=n.x,s>0&&b.push(o+P/2),x.push(a),n.pathTo.forEach(((h,c)=>{let p=!this.isBoxPlot&&this.candlestickOptions.wick.useFillColor?n.color[c]:l.globals.stroke.colors[e],d=r.fillPath({seriesNumber:g,dataPointIndex:s,color:n.color[c],value:i[e][s]});this.renderSeries({realIndex:g,pathFill:d,lineFill:p,j:s,i:e,pathFrom:n.pathFrom,pathTo:h,strokeWidth:t,elSeries:u,x:o,y:a,series:i,columnGroupIndex:m,barHeight:v,barWidth:P,elDataLabelsWrap:y,visibleSeries:this.visibleI,type:l.config.chart.type})}))}l.globals.seriesXvalues[g]=b,l.globals.seriesYvalues[g]=x,n.add(u)}return n}drawVerticalBoxPaths({indexes:i,x:e,y:s,xDivision:l,barWidth:t,zeroH:o,strokeWidth:r}){let a=this.w,n=new Graphics(this.ctx),h=i.i,c=i.j,p=!0,d=a.config.plotOptions.candlestick.colors.upward,x=a.config.plotOptions.candlestick.colors.downward,b="";this.isBoxPlot&&(b=[this.boxOptions.colors.lower,this.boxOptions.colors.upper]);const g=this.yRatio[i.translationsIndex];let m=i.realIndex;const u=this.getOHLCValue(m,c);let v=o,P=o;u.o>u.c&&(p=!1);let C=Math.min(u.o,u.c),w=Math.max(u.o,u.c),y=u.m;a.globals.isXNumeric&&(e=(a.globals.seriesX[m][c]-a.globals.minX)/this.xRatio-t/2);let H=e+t*this.visibleI;void 0===this.series[h][c]||null===this.series[h][c]?(C=o,w=o):(C=o-C/g,w=o-w/g,v=o-u.h/g,P=o-u.l/g,y=o-u.m/g);let f=n.move(H,o),B=n.move(H+t/2,C);return a.globals.previousPaths.length>0&&(B=this.getPreviousPath(m,c,!0)),f=this.isBoxPlot?[n.move(H,C)+n.line(H+t/2,C)+n.line(H+t/2,v)+n.line(H+t/4,v)+n.line(H+t-t/4,v)+n.line(H+t/2,v)+n.line(H+t/2,C)+n.line(H+t,C)+n.line(H+t,y)+n.line(H,y)+n.line(H,C+r/2),n.move(H,y)+n.line(H+t,y)+n.line(H+t,w)+n.line(H+t/2,w)+n.line(H+t/2,P)+n.line(H+t-t/4,P)+n.line(H+t/4,P)+n.line(H+t/2,P)+n.line(H+t/2,w)+n.line(H,w)+n.line(H,y)+"z"]:[n.move(H,w)+n.line(H+t/2,w)+n.line(H+t/2,v)+n.line(H+t/2,w)+n.line(H+t,w)+n.line(H+t,C)+n.line(H+t/2,C)+n.line(H+t/2,P)+n.line(H+t/2,C)+n.line(H,C)+n.line(H,w-r/2)],B+=n.move(H,C),a.globals.isXNumeric||(e+=l),{pathTo:f,pathFrom:B,x:e,y:w,barXPosition:H,color:this.isBoxPlot?b:p?[d]:[x]}}drawHorizontalBoxPaths({indexes:i,x:e,y:s,yDivision:l,barHeight:t,zeroW:o,strokeWidth:r}){let a=this.w,n=new Graphics(this.ctx),h=i.i,c=i.j,p=this.boxOptions.colors.lower;this.isBoxPlot&&(p=[this.boxOptions.colors.lower,this.boxOptions.colors.upper]);const d=this.invertedYRatio;let x=i.realIndex;const b=this.getOHLCValue(x,c);let g=o,m=o,u=Math.min(b.o,b.c),v=Math.max(b.o,b.c),P=b.m;a.globals.isXNumeric&&(s=(a.globals.seriesX[x][c]-a.globals.minX)/this.invertedXRatio-t/2);let C=s+t*this.visibleI;void 0===this.series[h][c]||null===this.series[h][c]?(u=o,v=o):(u=o+u/d,v=o+v/d,g=o+b.h/d,m=o+b.l/d,P=o+b.m/d);let w=n.move(o,C),y=n.move(u,C+t/2);return a.globals.previousPaths.length>0&&(y=this.getPreviousPath(x,c,!0)),w=[n.move(u,C)+n.line(u,C+t/2)+n.line(g,C+t/2)+n.line(g,C+t/2-t/4)+n.line(g,C+t/2+t/4)+n.line(g,C+t/2)+n.line(u,C+t/2)+n.line(u,C+t)+n.line(P,C+t)+n.line(P,C)+n.line(u+r/2,C),n.move(P,C)+n.line(P,C+t)+n.line(v,C+t)+n.line(v,C+t/2)+n.line(m,C+t/2)+n.line(m,C+t-t/4)+n.line(m,C+t/4)+n.line(m,C+t/2)+n.line(v,C+t/2)+n.line(v,C)+n.line(P,C)+"z"],y+=n.move(u,C),a.globals.isXNumeric||(s+=l),{pathTo:w,pathFrom:y,x:v,y:s,barYPosition:C,color:p}}getOHLCValue(i,e){const s=this.w;return{o:this.isBoxPlot?s.globals.seriesCandleH[i][e]:s.globals.seriesCandleO[i][e],h:this.isBoxPlot?s.globals.seriesCandleO[i][e]:s.globals.seriesCandleH[i][e],m:s.globals.seriesCandleM[i][e],l:this.isBoxPlot?s.globals.seriesCandleC[i][e]:s.globals.seriesCandleL[i][e],c:this.isBoxPlot?s.globals.seriesCandleL[i][e]:s.globals.seriesCandleC[i][e]}}}export default BoxCandleStick;