import Graphics from"../../../modules/Graphics";import DataLabels from"../../../modules/DataLabels";export default class BarDataLabels{constructor(t){this.w=t.w,this.barCtx=t,this.totalFormatter=this.w.config.plotOptions.bar.dataLabels.total.formatter,this.totalFormatter||(this.totalFormatter=this.w.config.dataLabels.formatter)}handleBarDataLabels(t){let a,e,{x:s,y:i,y1:r,y2:o,i:l,j:b,realIndex:n,columnGroupIndex:h,series:d,barHeight:c,barWidth:g,barXPosition:x,barYPosition:f,visibleSeries:L,renderedPath:p}=t,C=this.w,u=new Graphics(this.barCtx.ctx),w=Array.isArray(this.barCtx.strokeWidth)?this.barCtx.strokeWidth[n]:this.barCtx.strokeWidth;C.globals.isXNumeric&&!C.globals.isBarHorizontal?(a=s+parseFloat(g*(L+1)),e=i+parseFloat(c*(L+1))-w):(a=s+parseFloat(g*L),e=i+parseFloat(c*L));let D=null,m=null,y=s,W=i,v={},I=C.config.dataLabels,G=this.barCtx.barOptions.dataLabels,X=this.barCtx.barOptions.dataLabels.total;void 0!==f&&this.barCtx.isRangeBar&&(e=f,W=f),void 0!==x&&this.barCtx.isVerticalGroupedRangeBar&&(a=x,y=x);const k=I.offsetX,H=I.offsetY;let A={width:0,height:0};if(C.config.dataLabels.enabled){const t=this.barCtx.series[l][b];A=u.getTextRects(C.globals.yLabelFormatters[0](t),parseFloat(I.style.fontSize))}const B={x:s,y:i,i:l,j:b,realIndex:n,columnGroupIndex:h,renderedPath:p,bcx:a,bcy:e,barHeight:c,barWidth:g,textRects:A,strokeWidth:w,dataLabelsX:y,dataLabelsY:W,dataLabelsConfig:I,barDataLabelsConfig:G,barTotalDataLabelsConfig:X,offX:k,offY:H};return v=this.barCtx.isHorizontal?this.calculateBarsDataLabelsPosition(B):this.calculateColumnsDataLabelsPosition(B),p.attr({cy:v.bcy,cx:v.bcx,j:b,val:d[l][b],barHeight:c,barWidth:g}),D=this.drawCalculatedDataLabels({x:v.dataLabelsX,y:v.dataLabelsY,val:this.barCtx.isRangeBar?[r,o]:d[l][b],i:n,j:b,barWidth:g,barHeight:c,textRects:A,dataLabelsConfig:I}),C.config.chart.stacked&&X.enabled&&(m=this.drawTotalDataLabels({x:v.totalDataLabelsX,y:v.totalDataLabelsY,barWidth:g,barHeight:c,realIndex:n,textAnchor:v.totalDataLabelsAnchor,val:this.getStackedTotalDataLabel({realIndex:n,j:b}),dataLabelsConfig:I,barTotalDataLabelsConfig:X})),{dataLabels:D,totalDataLabels:m}}getStackedTotalDataLabel({realIndex:t,j:a}){const e=this.w;let s=this.barCtx.stackedSeriesTotals[a];return this.totalFormatter&&(s=this.totalFormatter(s,{...e,seriesIndex:t,dataPointIndex:a,w:e})),s}calculateColumnsDataLabelsPosition(t){const a=this.w;let e,s,{i,j:r,realIndex:o,columnGroupIndex:l,y:b,bcx:n,barWidth:h,barHeight:d,textRects:c,dataLabelsX:g,dataLabelsY:x,dataLabelsConfig:f,barDataLabelsConfig:L,barTotalDataLabelsConfig:p,strokeWidth:C,offX:u,offY:w}=t,D=n;d=Math.abs(d);let m="vertical"===a.config.plotOptions.bar.dataLabels.orientation;const{zeroEncounters:y}=this.barCtx.barHelpers.getZeroValueEncounters({i,j:r});n=n-C/2+l*h;let W=a.globals.gridWidth/a.globals.dataPoints;if(this.barCtx.isVerticalGroupedRangeBar?g+=h/2:(g=a.globals.isXNumeric?n-h/2+u:n-W+h/2+u,y>0&&a.config.plotOptions.bar.hideZeroBarsWhenGrouped&&(g-=h*y)),m){const t=2;g=g+c.height/2-C/2-t}let v=this.barCtx.series[i][r]<0,I=b;switch(this.barCtx.isReversed&&(I=b+(v?d:-d),b-=d),L.position){case"center":x=m?v?I-d/2+w:I+d/2-w:v?I-d/2+c.height/2+w:I+d/2+c.height/2-w;break;case"bottom":x=m?v?I-d+w:I+d-w:v?I-d+c.height+C+w:I+d-c.height/2+C-w;break;case"top":x=m?v?I+w:I-w:v?I-c.height/2-w:I+c.height+w}if(this.barCtx.lastActiveBarSerieIndex===o&&p.enabled){const t=18,i=new Graphics(this.barCtx.ctx).getTextRects(this.getStackedTotalDataLabel({realIndex:o,j:r}),f.fontSize);e=v?I-i.height/2-w-p.offsetY+t:I+i.height+w+p.offsetY-t;let l=a.globals.gridWidth/a.globals.dataPoints;s=D+h*(a.globals.barGroups.length-.5)-(a.globals.isXNumeric?h:l)+p.offsetX}return a.config.chart.stacked||(x<0?x=0+C:x+c.height/3>a.globals.gridHeight&&(x=a.globals.gridHeight-C)),{bcx:n,bcy:b,dataLabelsX:g,dataLabelsY:x,totalDataLabelsX:s,totalDataLabelsY:e,totalDataLabelsAnchor:"middle"}}calculateBarsDataLabelsPosition(t){const a=this.w;let{x:e,i:s,j:i,realIndex:r,columnGroupIndex:o,bcy:l,barHeight:b,barWidth:n,textRects:h,dataLabelsX:d,strokeWidth:c,dataLabelsConfig:g,barDataLabelsConfig:x,barTotalDataLabelsConfig:f,offX:L,offY:p}=t,C=a.globals.gridHeight/a.globals.dataPoints;n=Math.abs(n),l+=o*b;let u,w,D=l-(this.barCtx.isRangeBar?0:C)+b/2+h.height/2+p-3,m="start",y=this.barCtx.series[s][i]<0,W=e;switch(this.barCtx.isReversed&&(W=e+(y?-n:n),e=a.globals.gridWidth-n,m=y?"start":"end"),x.position){case"center":d=y?W+n/2-L:Math.max(h.width/2,W-n/2)+L;break;case"bottom":d=y?W+n-c-Math.round(h.width/2)-L:W-n+c+Math.round(h.width/2)+L;break;case"top":d=y?W-c+Math.round(h.width/2)-L:W-c-Math.round(h.width/2)+L}if(this.barCtx.lastActiveBarSerieIndex===r&&f.enabled){const t=new Graphics(this.barCtx.ctx).getTextRects(this.getStackedTotalDataLabel({realIndex:r,j:i}),g.fontSize);y?(u=W-c-L-f.offsetX,m="end"):u=W+L+f.offsetX+(this.barCtx.isReversed?-(n+c):c),w=D-h.height/2+t.height/2+f.offsetY+c}return a.config.chart.stacked||(d<0?d=d+h.width+c:d+h.width/2>a.globals.gridWidth&&(d=a.globals.gridWidth-h.width-c)),{bcx:e,bcy:l,dataLabelsX:d,dataLabelsY:D,totalDataLabelsX:u,totalDataLabelsY:w,totalDataLabelsAnchor:m}}drawCalculatedDataLabels({x:t,y:a,val:e,i:s,j:i,textRects:r,barHeight:o,barWidth:l,dataLabelsConfig:b}){const n=this.w;let h="rotate(0)";"vertical"===n.config.plotOptions.bar.dataLabels.orientation&&(h=`rotate(-90, ${t}, ${a})`);const d=new DataLabels(this.barCtx.ctx),c=new Graphics(this.barCtx.ctx),g=b.formatter;let x=null;const f=n.globals.collapsedSeriesIndices.indexOf(s)>-1;if(b.enabled&&!f){x=c.group({class:"apexcharts-data-labels",transform:h});let f="";void 0!==e&&(f=g(e,{...n,seriesIndex:s,dataPointIndex:i,w:n})),!e&&n.config.plotOptions.bar.hideZeroBarsWhenGrouped&&(f="");let L=n.globals.series[s][i]<0,p=n.config.plotOptions.bar.dataLabels.position;if("vertical"===n.config.plotOptions.bar.dataLabels.orientation&&("top"===p&&(b.textAnchor=L?"end":"start"),"center"===p&&(b.textAnchor="middle"),"bottom"===p&&(b.textAnchor=L?"end":"start")),this.barCtx.isRangeBar&&this.barCtx.barOptions.dataLabels.hideOverflowingLabels){l<c.getTextRects(f,parseFloat(b.style.fontSize)).width&&(f="")}n.config.chart.stacked&&this.barCtx.barOptions.dataLabels.hideOverflowingLabels&&(this.barCtx.isHorizontal?r.width/1.6>Math.abs(l)&&(f=""):r.height/1.6>Math.abs(o)&&(f=""));let C={...b};this.barCtx.isHorizontal&&e<0&&("start"===b.textAnchor?C.textAnchor="end":"end"===b.textAnchor&&(C.textAnchor="start")),d.plotDataLabelsText({x:t,y:a,text:f,i:s,j:i,parent:x,dataLabelsConfig:C,alwaysDrawDataLabel:!0,offsetCorrection:!0})}return x}drawTotalDataLabels({x:t,y:a,val:e,barWidth:s,barHeight:i,realIndex:r,textAnchor:o,barTotalDataLabelsConfig:l}){const b=this.w,n=new Graphics(this.barCtx.ctx);let h;return l.enabled&&void 0!==t&&void 0!==a&&this.barCtx.lastActiveBarSerieIndex===r&&(h=n.drawText({x:t-(!b.globals.isBarHorizontal&&b.globals.barGroups.length?s*(b.globals.barGroups.length-1)/2:0),y:a-(b.globals.isBarHorizontal&&b.globals.barGroups.length?i*(b.globals.barGroups.length-1)/2:0),foreColor:l.style.color,text:e,textAnchor:o,fontFamily:l.style.fontFamily,fontSize:l.style.fontSize,fontWeight:l.style.fontWeight})),h}}