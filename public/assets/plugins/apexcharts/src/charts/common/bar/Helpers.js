import Fill from"../../../modules/Fill";import Graphics from"../../../modules/Graphics";import Series from"../../../modules/Series";import Utils from"../../../utils/Utils";export default class Helpers{constructor(t){this.w=t.w,this.barCtx=t}initVariables(t){const r=this.w;this.barCtx.series=t,this.barCtx.totalItems=0,this.barCtx.seriesLen=0,this.barCtx.visibleI=-1,this.barCtx.visibleItems=1;for(let s=0;s<t.length;s++)if(t[s].length>0&&(this.barCtx.seriesLen=this.barCtx.seriesLen+1,this.barCtx.totalItems+=t[s].length),r.globals.isXNumeric)for(let i=0;i<t[s].length;i++)r.globals.seriesX[s][i]>r.globals.minX&&r.globals.seriesX[s][i]<r.globals.maxX&&this.barCtx.visibleItems++;else this.barCtx.visibleItems=r.globals.dataPoints;0===this.barCtx.seriesLen&&(this.barCtx.seriesLen=1),this.barCtx.zeroSerieses=[],r.globals.comboCharts||this.checkZeroSeries({series:t})}initialPositions(){let t,r,s,i,e,a,o,l,n=this.w,h=n.globals.dataPoints;this.barCtx.isRangeBar&&(h=n.globals.labels.length);let b=this.barCtx.seriesLen;if(n.config.plotOptions.bar.rangeBarGroupRows&&(b=1),this.barCtx.isHorizontal)s=n.globals.gridHeight/h,e=s/b,n.globals.isXNumeric&&(s=n.globals.gridHeight/this.barCtx.totalItems,e=s/this.barCtx.seriesLen),e=e*parseInt(this.barCtx.barOptions.barHeight,10)/100,-1===String(this.barCtx.barOptions.barHeight).indexOf("%")&&(e=parseInt(this.barCtx.barOptions.barHeight,10)),l=this.barCtx.baseLineInvertedY+n.globals.padHorizontal+(this.barCtx.isReversed?n.globals.gridWidth:0)-(this.barCtx.isReversed?2*this.barCtx.baseLineInvertedY:0),this.barCtx.isFunnel&&(l=n.globals.gridWidth/2),r=(s-e*this.barCtx.seriesLen)/2;else{if(i=n.globals.gridWidth/this.barCtx.visibleItems,n.config.xaxis.convertedCatToNumeric&&(i=n.globals.gridWidth/n.globals.dataPoints),a=i/b*parseInt(this.barCtx.barOptions.columnWidth,10)/100,n.globals.isXNumeric){let t=this.barCtx.xRatio;n.globals.minXDiff&&.5!==n.globals.minXDiff&&n.globals.minXDiff/t>0&&(i=n.globals.minXDiff/t),a=i/b*parseInt(this.barCtx.barOptions.columnWidth,10)/100,a<1&&(a=1)}-1===String(this.barCtx.barOptions.columnWidth).indexOf("%")&&(a=parseInt(this.barCtx.barOptions.columnWidth,10)),o=n.globals.gridHeight-this.barCtx.baseLineY[this.barCtx.translationsIndex]-(this.barCtx.isReversed?n.globals.gridHeight:0)+(this.barCtx.isReversed?2*this.barCtx.baseLineY[this.barCtx.translationsIndex]:0),t=n.globals.padHorizontal+(i-a*this.barCtx.seriesLen)/2}return n.globals.barHeight=e,n.globals.barWidth=a,{x:t,y:r,yDivision:s,xDivision:i,barHeight:e,barWidth:a,zeroH:o,zeroW:l}}initializeStackedPrevVars(t){t.w.globals.seriesGroups.forEach((r=>{t[r]||(t[r]={}),t[r].prevY=[],t[r].prevX=[],t[r].prevYF=[],t[r].prevXF=[],t[r].prevYVal=[],t[r].prevXVal=[]}))}initializeStackedXYVars(t){t.w.globals.seriesGroups.forEach((r=>{t[r]||(t[r]={}),t[r].xArrj=[],t[r].xArrjF=[],t[r].xArrjVal=[],t[r].yArrj=[],t[r].yArrjF=[],t[r].yArrjVal=[]}))}getPathFillColor(t,r,s,i){const e=this.w;let a=new Fill(this.barCtx.ctx),o=null,l=this.barCtx.barOptions.distributed?s:r;if(this.barCtx.barOptions.colors.ranges.length>0){this.barCtx.barOptions.colors.ranges.map((i=>{t[r][s]>=i.from&&t[r][s]<=i.to&&(o=i.color)}))}return e.config.series[r].data[s]&&e.config.series[r].data[s].fillColor&&(o=e.config.series[r].data[s].fillColor),a.fillPath({seriesNumber:this.barCtx.barOptions.distributed?l:i,dataPointIndex:s,color:o,value:t[r][s],fillConfig:e.config.series[r].data[s]?.fill,fillType:e.config.series[r].data[s]?.fill?.type?e.config.series[r].data[s]?.fill.type:Array.isArray(e.config.fill.type)?e.config.fill.type[r]:e.config.fill.type})}getStrokeWidth(t,r,s){let i=0;const e=this.w;return void 0===this.barCtx.series[t][r]||null===this.barCtx.series[t][r]?this.barCtx.isNullValue=!0:this.barCtx.isNullValue=!1,e.config.stroke.show&&(this.barCtx.isNullValue||(i=Array.isArray(this.barCtx.strokeWidth)?this.barCtx.strokeWidth[s]:this.barCtx.strokeWidth)),i}shouldApplyRadius(t){const r=this.w;let s=!1;return r.config.plotOptions.bar.borderRadius>0&&(r.config.chart.stacked&&"last"===r.config.plotOptions.bar.borderRadiusWhenStacked?this.barCtx.lastActiveBarSerieIndex===t&&(s=!0):s=!0),s}barBackground({j:t,i:r,x1:s,x2:i,y1:e,y2:a,elSeries:o}){const l=this.w,n=new Graphics(this.barCtx.ctx);let h=new Series(this.barCtx.ctx).getActiveConfigSeriesIndex();if(this.barCtx.barOptions.colors.backgroundBarColors.length>0&&h===r){t>=this.barCtx.barOptions.colors.backgroundBarColors.length&&(t%=this.barCtx.barOptions.colors.backgroundBarColors.length);let r=this.barCtx.barOptions.colors.backgroundBarColors[t],h=n.drawRect(void 0!==s?s:0,void 0!==e?e:0,void 0!==i?i:l.globals.gridWidth,void 0!==a?a:l.globals.gridHeight,this.barCtx.barOptions.colors.backgroundBarRadius,r,this.barCtx.barOptions.colors.backgroundBarOpacity);o.add(h),h.node.classList.add("apexcharts-backgroundBar")}}getColumnPaths({barWidth:t,barXPosition:r,y1:s,y2:i,strokeWidth:e,seriesGroup:a,realIndex:o,i:l,j:n,w:h}){const b=new Graphics(this.barCtx.ctx);(e=Array.isArray(e)?e[o]:e)||(e=0);let d=t,g=r;h.config.series[o].data[n]?.columnWidthOffset&&(g=r-h.config.series[o].data[n].columnWidthOffset/2,d=t+h.config.series[o].data[n].columnWidthOffset);let c=e/2;const x=g+c,p=g+d-c;s+=.001-c,i+=.001+c;let u=b.move(x,s),C=b.move(x,s);const f=b.line(p,s);if(h.globals.previousPaths.length>0&&(C=this.barCtx.getPreviousPath(o,n,!1)),u=u+b.line(x,i)+b.line(p,i)+b.line(p,s)+("around"===h.config.plotOptions.bar.borderRadiusApplication?" Z":" z"),C=C+b.line(x,s)+f+f+f+f+f+b.line(x,s)+("around"===h.config.plotOptions.bar.borderRadiusApplication?" Z":" z"),this.shouldApplyRadius(o)&&(u=b.roundPathCorners(u,h.config.plotOptions.bar.borderRadius)),h.config.chart.stacked){let t=this.barCtx;t=this.barCtx[a],t.yArrj.push(i-c),t.yArrjF.push(Math.abs(s-i+e)),t.yArrjVal.push(this.barCtx.series[l][n])}return{pathTo:u,pathFrom:C}}getBarpaths({barYPosition:t,barHeight:r,x1:s,x2:i,strokeWidth:e,seriesGroup:a,realIndex:o,i:l,j:n,w:h}){const b=new Graphics(this.barCtx.ctx);(e=Array.isArray(e)?e[o]:e)||(e=0);let d=t,g=r;h.config.series[o].data[n]?.barHeightOffset&&(d=t-h.config.series[o].data[n].barHeightOffset/2,g=r+h.config.series[o].data[n].barHeightOffset);let c=e/2;const x=d+c,p=d+g-c;s+=.001-c,i+=.001+c;let u=b.move(s,x),C=b.move(s,x);h.globals.previousPaths.length>0&&(C=this.barCtx.getPreviousPath(o,n,!1));const f=b.line(s,p);if(u=u+b.line(i,x)+b.line(i,p)+f+("around"===h.config.plotOptions.bar.borderRadiusApplication?" Z":" z"),C=C+b.line(s,x)+f+f+f+f+f+b.line(s,x)+("around"===h.config.plotOptions.bar.borderRadiusApplication?" Z":" z"),this.shouldApplyRadius(o)&&(u=b.roundPathCorners(u,h.config.plotOptions.bar.borderRadius)),h.config.chart.stacked){let t=this.barCtx;t=this.barCtx[a],t.xArrj.push(i+c),t.xArrjF.push(Math.abs(s-i)),t.xArrjVal.push(this.barCtx.series[l][n])}return{pathTo:u,pathFrom:C}}checkZeroSeries({series:t}){let r=this.w;for(let s=0;s<t.length;s++){let i=0;for(let e=0;e<t[r.globals.maxValsInArrayIndex].length;e++)i+=t[s][e];0===i&&this.barCtx.zeroSerieses.push(s)}}getXForValue(t,r,s=!0){let i=s?r:null;return null!=t&&(i=r+t/this.barCtx.invertedYRatio-2*(this.barCtx.isReversed?t/this.barCtx.invertedYRatio:0)),i}getYForValue(t,r,s,i=!0){let e=i?r:null;return null!=t&&(e=r-t/this.barCtx.yRatio[s]+2*(this.barCtx.isReversed?t/this.barCtx.yRatio[s]:0)),e}getGoalValues(t,r,s,i,e,a){const o=this.w;let l=[];const n=(i,e)=>{l.push({[t]:"x"===t?this.getXForValue(i,r,!1):this.getYForValue(i,s,a,!1),attrs:e})};if(o.globals.seriesGoals[i]&&o.globals.seriesGoals[i][e]&&Array.isArray(o.globals.seriesGoals[i][e])&&o.globals.seriesGoals[i][e].forEach((t=>{n(t.value,t)})),this.barCtx.barOptions.isDumbbell&&o.globals.seriesRange.length){let r=this.barCtx.barOptions.dumbbellColors?this.barCtx.barOptions.dumbbellColors:o.globals.colors;const s={strokeHeight:"x"===t?0:o.globals.markers.size[i],strokeWidth:"x"===t?o.globals.markers.size[i]:0,strokeDashArray:0,strokeLineCap:"round",strokeColor:Array.isArray(r[i])?r[i][0]:r[i]};n(o.globals.seriesRangeStart[i][e],s),n(o.globals.seriesRangeEnd[i][e],{...s,strokeColor:Array.isArray(r[i])?r[i][1]:r[i]})}return l}drawGoalLine({barXPosition:t,barYPosition:r,goalX:s,goalY:i,barWidth:e,barHeight:a}){let o=new Graphics(this.barCtx.ctx);const l=o.group({className:"apexcharts-bar-goals-groups"});l.node.classList.add("apexcharts-element-hidden"),this.barCtx.w.globals.delayedElements.push({el:l.node}),l.attr("clip-path",`url(#gridRectMarkerMask${this.barCtx.w.globals.cuid})`);let n=null;return this.barCtx.isHorizontal?Array.isArray(s)&&s.forEach((t=>{if(t.x>=-1&&t.x<=o.w.globals.gridWidth+1){let s=void 0!==t.attrs.strokeHeight?t.attrs.strokeHeight:a/2,i=r+s+a/2;n=o.drawLine(t.x,i-2*s,t.x,i,t.attrs.strokeColor?t.attrs.strokeColor:void 0,t.attrs.strokeDashArray,t.attrs.strokeWidth?t.attrs.strokeWidth:2,t.attrs.strokeLineCap),l.add(n)}})):Array.isArray(i)&&i.forEach((r=>{if(r.y>=-1&&r.y<=o.w.globals.gridHeight+1){let s=void 0!==r.attrs.strokeWidth?r.attrs.strokeWidth:e/2,i=t+s+e/2;n=o.drawLine(i-2*s,r.y,i,r.y,r.attrs.strokeColor?r.attrs.strokeColor:void 0,r.attrs.strokeDashArray,r.attrs.strokeHeight?r.attrs.strokeHeight:2,r.attrs.strokeLineCap),l.add(n)}})),l}drawBarShadow({prevPaths:t,currPaths:r,color:s}){const i=this.w,{x:e,x1:a,barYPosition:o}=t,{x:l,x1:n,barYPosition:h}=r,b=o+r.barHeight,d=new Graphics(this.barCtx.ctx),g=new Utils,c=d.move(a,b)+d.line(e,b)+d.line(l,h)+d.line(n,h)+d.line(a,b)+("around"===i.config.plotOptions.bar.borderRadiusApplication?" Z":" z");return d.drawPath({d:c,fill:g.shadeColor(.5,Utils.rgb2hex(s)),stroke:"none",strokeWidth:0,fillOpacity:1,classes:"apexcharts-bar-shadows"})}getZeroValueEncounters({i:t,j:r}){const s=this.w;let i=0,e=0;return(s.config.plotOptions.bar.horizontal?s.globals.series.map(((t,r)=>r)):s.globals.columnSeries?.i.map((t=>t))||[]).forEach((a=>{let o=s.globals.seriesPercent[a][r];o&&i++,a<t&&0===o&&e++})),{nonZeroColumns:i,zeroEncounters:e}}getGroupIndex(t){const r=this.w;let s=r.globals.seriesGroups.findIndex((s=>s.indexOf(r.globals.seriesNames[t])>-1)),i=this.barCtx.columnGroupIndices,e=i.indexOf(s);return e<0&&(i.push(s),e=i.length-1),{groupIndex:s,columnGroupIndex:e}}}