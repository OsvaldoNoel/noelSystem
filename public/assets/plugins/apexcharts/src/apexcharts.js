import Annotations from"./modules/annotations/Annotations";import Base from"./modules/Base";import CoreUtils from"./modules/CoreUtils";import DataLabels from"./modules/DataLabels";import Defaults from"./modules/settings/Defaults";import Exports from"./modules/Exports";import Grid from"./modules/axes/Grid";import Markers from"./modules/Markers";import Range from"./modules/Range";import Utils from"./utils/Utils";import XAxis from"./modules/axes/XAxis";import YAxis from"./modules/axes/YAxis";import InitCtxVariables from"./modules/helpers/InitCtxVariables";import Destroy from"./modules/helpers/Destroy";import{addResizeListener,removeResizeListener}from"./utils/Resize";import apexCSS from"./assets/apexcharts.css";export default class ApexCharts{constructor(e,t){this.opts=t,this.ctx=this,this.w=new Base(t).init(),this.el=e,this.w.globals.cuid=Utils.randomId(),this.w.globals.chartID=this.w.config.chart.id?Utils.escapeString(this.w.config.chart.id):this.w.globals.cuid;new InitCtxVariables(this).initModules(),this.create=Utils.bind(this.create,this),this.windowResizeHandler=this._windowResizeHandler.bind(this),this.parentResizeHandler=this._parentResizeCallback.bind(this)}render(){return new Promise(((e,t)=>{if(null!==this.el){void 0===Apex._chartInstances&&(Apex._chartInstances=[]),this.w.config.chart.id&&Apex._chartInstances.push({id:this.w.globals.chartID,group:this.w.config.chart.group,chart:this}),this.setLocale(this.w.config.chart.defaultLocale);const s=this.w.config.chart.events.beforeMount;"function"==typeof s&&s(this,this.w),this.events.fireEvent("beforeMount",[this,this.w]),window.addEventListener("resize",this.windowResizeHandler),addResizeListener(this.el.parentNode,this.parentResizeHandler);let i=this.el.getRootNode&&this.el.getRootNode(),o=Utils.is("ShadowRoot",i),a=this.el.ownerDocument,r=o?i.getElementById("apexcharts-css"):a.getElementById("apexcharts-css");if(!r){r=document.createElement("style"),r.id="apexcharts-css",r.textContent=apexCSS;const e=this.opts.chart?.nonce||this.w.config.chart.nonce;e&&r.setAttribute("nonce",e),o?i.prepend(r):a.head.appendChild(r)}let n=this.create(this.w.config.series,{});if(!n)return e(this);this.mount(n).then((()=>{"function"==typeof this.w.config.chart.events.mounted&&this.w.config.chart.events.mounted(this,this.w),this.events.fireEvent("mounted",[this,this.w]),e(n)})).catch((e=>{t(e)}))}else t(new Error("Element not found"))}))}create(e,t){let s=this.w;new InitCtxVariables(this).initModules();let i=this.w.globals;if(i.noData=!1,i.animationEnded=!1,this.responsive.checkResponsiveConfig(t),s.config.xaxis.convertedCatToNumeric){new Defaults(s.config).convertCatToNumericXaxis(s.config,this.ctx)}if(null===this.el)return i.animationEnded=!0,null;if(this.core.setupElements(),"treemap"===s.config.chart.type&&(s.config.grid.show=!1,s.config.yaxis[0].show=!1),0===i.svgWidth)return i.animationEnded=!0,null;const o=CoreUtils.checkComboSeries(e,s.config.chart.type);i.comboCharts=o.comboCharts,i.comboBarCount=o.comboBarCount;const a=e.every((e=>e.data&&0===e.data.length));(0===e.length||a&&i.collapsedSeries.length<1)&&this.series.handleNoData(),this.events.setupEventHandlers(),this.data.parseData(e),this.theme.init();new Markers(this).setGlobalMarkerSize(),this.formatters.setLabelFormatters(),this.titleSubtitle.draw(),i.noData&&i.collapsedSeries.length!==i.series.length&&!s.config.legend.showForSingleSeries||this.legend.init(),this.series.hasAllSeriesEqualX(),i.axisCharts&&(this.core.coreCalculations(),"category"!==s.config.xaxis.type&&this.formatters.setLabelFormatters(),this.ctx.toolbar.minX=s.globals.minX,this.ctx.toolbar.maxX=s.globals.maxX),this.formatters.heatmapLabelFormatters();new CoreUtils(this).getLargestMarkerSize(),this.dimensions.plotCoords();const r=this.core.xySettings();this.grid.createGridMask();const n=this.core.plotChartType(e,r),l=new DataLabels(this);l.bringForward(),s.config.dataLabels.background.enabled&&l.dataLabelsBackground(),this.core.shiftGraphPosition();return{elGraph:n,xyRatios:r,dimensions:{plot:{left:s.globals.translateX,top:s.globals.translateY,width:s.globals.gridWidth,height:s.globals.gridHeight}}}}mount(e=null){let t=this,s=t.w;return new Promise(((i,o)=>{if(null===t.el)return o(new Error("Not enough data to display or target element not found"));(null===e||s.globals.allSeriesCollapsed)&&t.series.handleNoData(),t.grid=new Grid(t);let a=t.grid.drawGrid();if(t.annotations=new Annotations(t),t.annotations.drawImageAnnos(),t.annotations.drawTextAnnos(),"back"===s.config.grid.position&&(a&&s.globals.dom.elGraphical.add(a.el),a?.elGridBorders?.node&&s.globals.dom.elGraphical.add(a.elGridBorders)),Array.isArray(e.elGraph))for(let t=0;t<e.elGraph.length;t++)s.globals.dom.elGraphical.add(e.elGraph[t]);else s.globals.dom.elGraphical.add(e.elGraph);"front"===s.config.grid.position&&(a&&s.globals.dom.elGraphical.add(a.el),a?.elGridBorders?.node&&s.globals.dom.elGraphical.add(a.elGridBorders)),"front"===s.config.xaxis.crosshairs.position&&t.crosshairs.drawXCrosshairs(),"front"===s.config.yaxis[0].crosshairs.position&&t.crosshairs.drawYCrosshairs(),"treemap"!==s.config.chart.type&&t.axes.drawAxis(s.config.chart.type,a);let r=new XAxis(this.ctx,a),n=new YAxis(this.ctx,a);if(null!==a&&(r.xAxisLabelCorrections(a.xAxisTickWidth),n.setYAxisTextAlignments(),s.config.yaxis.map(((e,t)=>{-1===s.globals.ignoreYAxisIndexes.indexOf(t)&&n.yAxisTitleRotate(t,e.opposite)}))),t.annotations.drawAxesAnnotations(),!s.globals.noData){if(s.config.tooltip.enabled&&!s.globals.noData&&t.w.globals.tooltip.drawTooltip(e.xyRatios),s.globals.axisCharts&&(s.globals.isXNumeric||s.config.xaxis.convertedCatToNumeric||s.globals.isRangeBar))(s.config.chart.zoom.enabled||s.config.chart.selection&&s.config.chart.selection.enabled||s.config.chart.pan&&s.config.chart.pan.enabled)&&t.zoomPanSelection.init({xyRatios:e.xyRatios});else{const e=s.config.chart.toolbar.tools;["zoom","zoomin","zoomout","selection","pan","reset"].forEach((t=>{e[t]=!1}))}s.config.chart.toolbar.show&&!s.globals.allSeriesCollapsed&&t.toolbar.createToolbar()}s.globals.memory.methodsToExec.length>0&&s.globals.memory.methodsToExec.forEach((e=>{e.method(e.params,!1,e.context)})),s.globals.axisCharts||s.globals.noData||t.core.resizeNonAxisCharts(),i(t)}))}destroy(){window.removeEventListener("resize",this.windowResizeHandler),removeResizeListener(this.el.parentNode,this.parentResizeHandler);const e=this.w.config.chart.id;e&&Apex._chartInstances.forEach(((t,s)=>{t.id===Utils.escapeString(e)&&Apex._chartInstances.splice(s,1)})),new Destroy(this.ctx).clear({isUpdating:!1})}updateOptions(e,t=!1,s=!0,i=!0,o=!0){const a=this.w;return a.globals.selection=void 0,e.series&&(this.series.resetSeries(!1,!0,!1),e.series.length&&e.series[0].data&&(e.series=e.series.map(((e,t)=>this.updateHelpers._extendSeries(e,t)))),this.updateHelpers.revertDefaultAxisMinMax()),e.xaxis&&(e=this.updateHelpers.forceXAxisUpdate(e)),e.yaxis&&(e=this.updateHelpers.forceYAxisUpdate(e)),a.globals.collapsedSeriesIndices.length>0&&this.series.clearPreviousPaths(),e.theme&&(e=this.theme.updateThemeOptions(e)),this.updateHelpers._updateOptions(e,t,s,i,o)}updateSeries(e=[],t=!0,s=!0){return this.series.resetSeries(!1),this.updateHelpers.revertDefaultAxisMinMax(),this.updateHelpers._updateSeries(e,t,s)}appendSeries(e,t=!0,s=!0){const i=this.w.config.series.slice();return i.push(e),this.series.resetSeries(!1),this.updateHelpers.revertDefaultAxisMinMax(),this.updateHelpers._updateSeries(i,t,s)}appendData(e,t=!0){let s=this;s.w.globals.dataChanged=!0,s.series.getPreviousPaths();let i=s.w.config.series.slice();for(let t=0;t<i.length;t++)if(null!==e[t]&&void 0!==e[t])for(let s=0;s<e[t].data.length;s++)i[t].data.push(e[t].data[s]);return s.w.config.series=i,t&&(s.w.globals.initialSeries=Utils.clone(s.w.config.series)),this.update()}update(e){return new Promise(((t,s)=>{new Destroy(this.ctx).clear({isUpdating:!0});const i=this.create(this.w.config.series,e);if(!i)return t(this);this.mount(i).then((()=>{"function"==typeof this.w.config.chart.events.updated&&this.w.config.chart.events.updated(this,this.w),this.events.fireEvent("updated",[this,this.w]),this.w.globals.isDirty=!0,t(this)})).catch((e=>{s(e)}))}))}getSyncedCharts(){const e=this.getGroupedCharts();let t=[this];return e.length&&(t=[],e.forEach((e=>{t.push(e)}))),t}getGroupedCharts(){return Apex._chartInstances.filter((e=>{if(e.group)return!0})).map((e=>this.w.config.chart.group===e.group?e.chart:this))}static getChartByID(e){const t=Utils.escapeString(e);if(!Apex._chartInstances)return;const s=Apex._chartInstances.filter((e=>e.id===t))[0];return s&&s.chart}static initOnLoad(){const e=document.querySelectorAll("[data-apexcharts]");for(let t=0;t<e.length;t++){const s=e[t],i=JSON.parse(e[t].getAttribute("data-options"));new ApexCharts(s,i).render()}}static exec(e,t,...s){const i=this.getChartByID(e);if(!i)return;i.w.globals.isExecCalled=!0;let o=null;return-1!==i.publicMethods.indexOf(t)&&(o=i[t](...s)),o}static merge(e,t){return Utils.extend(e,t)}toggleSeries(e){return this.series.toggleSeries(e)}highlightSeriesOnLegendHover(e,t){return this.series.toggleSeriesOnHover(e,t)}showSeries(e){this.series.showSeries(e)}hideSeries(e){this.series.hideSeries(e)}isSeriesHidden(e){this.series.isSeriesHidden(e)}resetSeries(e=!0,t=!0){this.series.resetSeries(e,t)}addEventListener(e,t){this.events.addEventListener(e,t)}removeEventListener(e,t){this.events.removeEventListener(e,t)}addXaxisAnnotation(e,t=!0,s=void 0){let i=this;s&&(i=s),i.annotations.addXaxisAnnotationExternal(e,t,i)}addYaxisAnnotation(e,t=!0,s=void 0){let i=this;s&&(i=s),i.annotations.addYaxisAnnotationExternal(e,t,i)}addPointAnnotation(e,t=!0,s=void 0){let i=this;s&&(i=s),i.annotations.addPointAnnotationExternal(e,t,i)}clearAnnotations(e=void 0){let t=this;e&&(t=e),t.annotations.clearAnnotations(t)}removeAnnotation(e,t=void 0){let s=this;t&&(s=t),s.annotations.removeAnnotation(s,e)}getChartArea(){return this.w.globals.dom.baseEl.querySelector(".apexcharts-inner")}getSeriesTotalXRange(e,t){return this.coreUtils.getSeriesTotalsXRange(e,t)}getHighestValueInSeries(e=0){return new Range(this.ctx).getMinYMaxY(e).highestY}getLowestValueInSeries(e=0){return new Range(this.ctx).getMinYMaxY(e).lowestY}getSeriesTotal(){return this.w.globals.seriesTotals}toggleDataPointSelection(e,t){return this.updateHelpers.toggleDataPointSelection(e,t)}zoomX(e,t){this.ctx.toolbar.zoomUpdateOptions(e,t)}setLocale(e){this.localization.setCurrentLocaleValues(e)}dataURI(e){return new Exports(this.ctx).dataURI(e)}exportToCSV(e={}){return new Exports(this.ctx).exportToCSV(e)}paper(){return this.w.globals.dom.Paper}_parentResizeCallback(){this.w.globals.animationEnded&&this.w.config.chart.redrawOnParentResize&&this._windowResize()}_windowResize(){clearTimeout(this.w.globals.resizeTimer),this.w.globals.resizeTimer=window.setTimeout((()=>{this.w.globals.resized=!0,this.w.globals.dataChanged=!1,this.ctx.update()}),150)}_windowResizeHandler(){let{redrawOnWindowResize:e}=this.w.config.chart;"function"==typeof e&&(e=e()),e&&this._windowResize()}}