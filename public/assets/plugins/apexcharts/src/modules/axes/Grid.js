import Graphics from"../Graphics";import XAxis from"./XAxis";import AxesUtils from"./AxesUtils";class Grid{constructor(i){this.ctx=i,this.w=i.w;const s=this.w;this.xaxisLabels=s.globals.labels.slice(),this.axesUtils=new AxesUtils(i),this.isRangeBar=s.globals.seriesRange.length&&s.globals.isBarHorizontal,s.globals.timescaleLabels.length>0&&(this.xaxisLabels=s.globals.timescaleLabels.slice())}drawGridArea(i=null){let s=this.w,e=new Graphics(this.ctx);null===i&&(i=e.group({class:"apexcharts-grid"}));let t=e.drawLine(s.globals.padHorizontal,1,s.globals.padHorizontal,s.globals.gridHeight,"transparent"),a=e.drawLine(s.globals.padHorizontal,s.globals.gridHeight,s.globals.gridWidth,s.globals.gridHeight,"transparent");return i.add(a),i.add(t),i}drawGrid(){let i=null;return this.w.globals.axisCharts&&(i=this.renderGrid(),this.drawGridArea(i.el)),i}createGridMask(){let i=this.w,s=i.globals;const e=new Graphics(this.ctx);let t=Array.isArray(i.config.stroke.width)?0:i.config.stroke.width;if(Array.isArray(i.config.stroke.width)){let s=0;i.config.stroke.width.forEach((i=>{s=Math.max(s,i)})),t=s}s.dom.elGridRectMask=document.createElementNS(s.SVGNS,"clipPath"),s.dom.elGridRectMask.setAttribute("id",`gridRectMask${s.cuid}`),s.dom.elGridRectMarkerMask=document.createElementNS(s.SVGNS,"clipPath"),s.dom.elGridRectMarkerMask.setAttribute("id",`gridRectMarkerMask${s.cuid}`),s.dom.elForecastMask=document.createElementNS(s.SVGNS,"clipPath"),s.dom.elForecastMask.setAttribute("id",`forecastMask${s.cuid}`),s.dom.elNonForecastMask=document.createElementNS(s.SVGNS,"clipPath"),s.dom.elNonForecastMask.setAttribute("id",`nonForecastMask${s.cuid}`);const a=i.config.chart.type;let r=0,l=0;("bar"===a||"rangeBar"===a||"candlestick"===a||"boxPlot"===a||i.globals.comboBarCount>0)&&i.globals.isXNumeric&&!i.globals.isBarHorizontal&&(r=i.config.grid.padding.left,l=i.config.grid.padding.right,s.barPadForNumericAxis>r&&(r=s.barPadForNumericAxis,l=s.barPadForNumericAxis)),s.dom.elGridRect=e.drawRect(-t/2-r-2,-t/2-2,s.gridWidth+t+l+r+4,s.gridHeight+t+4,0,"#fff");let o=i.globals.markers.largestSize+1;s.dom.elGridRectMarker=e.drawRect(2*-o,2*-o,s.gridWidth+4*o,s.gridHeight+4*o,0,"#fff"),s.dom.elGridRectMask.appendChild(s.dom.elGridRect.node),s.dom.elGridRectMarkerMask.appendChild(s.dom.elGridRectMarker.node);let d=s.dom.baseEl.querySelector("defs");d.appendChild(s.dom.elGridRectMask),d.appendChild(s.dom.elForecastMask),d.appendChild(s.dom.elNonForecastMask),d.appendChild(s.dom.elGridRectMarkerMask)}_drawGridLines({i,x1:s,y1:e,x2:t,y2:a,xCount:r,parent:l}){const o=this.w;if(!(0===i&&o.globals.skipFirstTimelinelabel||i===r-1&&o.globals.skipLastTimelinelabel&&!o.config.xaxis.labels.formatter||"radar"===o.config.chart.type)){o.config.grid.xaxis.lines.show&&this._drawGridLine({i,x1:s,y1:e,x2:t,y2:a,xCount:r,parent:l});let d=0;if(o.globals.hasXaxisGroups&&"between"===o.config.xaxis.tickPlacement){const s=o.globals.groups;if(s){let e=0;for(let t=0;e<i&&t<s.length;t++)e+=s[t].cols;e===i&&(d=.6*o.globals.xAxisLabelsHeight)}}new XAxis(this.ctx).drawXaxisTicks(s,d,o.globals.dom.elGraphical)}}_drawGridLine({i,x1:s,y1:e,x2:t,y2:a,xCount:r,parent:l}){const o=this.w;let d=!1;const n=l.node.classList.contains("apexcharts-gridlines-horizontal");let g=o.config.grid.strokeDashArray;const c=o.globals.barPadForNumericAxis;(0===e&&0===a||0===s&&0===t)&&(d=!0),e===o.globals.gridHeight&&a===o.globals.gridHeight&&(d=!0),!o.globals.isBarHorizontal||0!==i&&i!==r-1||(d=!0);let h=new Graphics(this).drawLine(s-(n?c:0),e,t+(n?c:0),a,o.config.grid.borderColor,g);h.node.classList.add("apexcharts-gridline"),d&&o.config.grid.show?this.elGridBorders.add(h):l.add(h)}_drawGridBandRect({c:i,x1:s,y1:e,x2:t,y2:a,type:r}){const l=this.w,o=new Graphics(this.ctx),d=l.globals.barPadForNumericAxis;if("column"===r&&"datetime"===l.config.xaxis.type)return;const n=l.config.grid[r].colors[i];let g=o.drawRect(s-("row"===r?d:0),e,t+("row"===r?2*d:0),a,0,n,l.config.grid[r].opacity);this.elg.add(g),g.attr("clip-path",`url(#gridRectMask${l.globals.cuid})`),g.node.classList.add(`apexcharts-grid-${r}`)}_drawXYLines({xCount:i,tickAmount:s}){const e=this.w,t=({xC:s,x1:e,y1:t,x2:a,y2:r})=>{for(let l=0;l<s;l++)e=this.xaxisLabels[l].position,a=this.xaxisLabels[l].position,this._drawGridLines({i:l,x1:e,y1:t,x2:a,y2:r,xCount:i,parent:this.elgridLinesV})},a=({xC:s,x1:t,y1:a,x2:r,y2:l})=>{for(let o=0;o<s+(e.globals.isXNumeric?0:1);o++)0===o&&1===s&&1===e.globals.dataPoints&&(r=t=e.globals.gridWidth/2),this._drawGridLines({i:o,x1:t,y1:a,x2:r,y2:l,xCount:i,parent:this.elgridLinesV}),r=t+=e.globals.gridWidth/(e.globals.isXNumeric?s-1:s)};if(e.config.grid.xaxis.lines.show||e.config.xaxis.axisTicks.show){let s,r=e.globals.padHorizontal,l=0,o=e.globals.gridHeight;e.globals.timescaleLabels.length?t({xC:i,x1:r,y1:l,x2:s,y2:o}):(e.globals.isXNumeric&&(i=e.globals.xAxisScale.result.length),a({xC:i,x1:r,y1:l,x2:s,y2:o}))}if(e.config.grid.yaxis.lines.show){let i=0,t=0,a=0,r=e.globals.gridWidth,l=s+1;this.isRangeBar&&(l=e.globals.labels.length);for(let o=0;o<l+(this.isRangeBar?1:0);o++)this._drawGridLine({i:o,xCount:l+(this.isRangeBar?1:0),x1:i,y1:t,x2:r,y2:a,parent:this.elgridLinesH}),t+=e.globals.gridHeight/(this.isRangeBar?l:s),a=t}}_drawInvertedXYLines({xCount:i}){const s=this.w;if(s.config.grid.xaxis.lines.show||s.config.xaxis.axisTicks.show){let e,t=s.globals.padHorizontal,a=0,r=s.globals.gridHeight;for(let l=0;l<i+1;l++){s.config.grid.xaxis.lines.show&&this._drawGridLine({i:l,xCount:i+1,x1:t,y1:a,x2:e,y2:r,parent:this.elgridLinesV}),new XAxis(this.ctx).drawXaxisTicks(t,0,s.globals.dom.elGraphical),t+=s.globals.gridWidth/i,e=t}}if(s.config.grid.yaxis.lines.show){let i=0,e=0,t=0,a=s.globals.gridWidth;for(let r=0;r<s.globals.dataPoints+1;r++)this._drawGridLine({i:r,xCount:s.globals.dataPoints+1,x1:i,y1:e,x2:a,y2:t,parent:this.elgridLinesH}),e+=s.globals.gridHeight/s.globals.dataPoints,t=e}}renderGrid(){let i=this.w;const s=i.globals;let e=new Graphics(this.ctx);this.elg=e.group({class:"apexcharts-grid"}),this.elgridLinesH=e.group({class:"apexcharts-gridlines-horizontal"}),this.elgridLinesV=e.group({class:"apexcharts-gridlines-vertical"}),this.elGridBorders=e.group({class:"apexcharts-grid-borders"}),this.elg.add(this.elgridLinesH),this.elg.add(this.elgridLinesV),i.config.grid.show||(this.elgridLinesV.hide(),this.elgridLinesH.hide(),this.elGridBorders.hide());let t=0;for(;t<s.seriesYAxisMap.length&&-1!==s.ignoreYAxisIndexes.indexOf(t);)t++;t===s.seriesYAxisMap.length&&(t=0);let a,r=s.yAxisScale[t].result.length-1;return!s.isBarHorizontal||this.isRangeBar?(a=this.xaxisLabels.length,this.isRangeBar&&(r=s.labels.length,i.config.xaxis.tickAmount&&i.config.xaxis.labels.formatter&&(a=i.config.xaxis.tickAmount),s.yAxisScale?.[t]?.result?.length>0&&"datetime"!==i.config.xaxis.type&&(a=s.yAxisScale[t].result.length-1)),this._drawXYLines({xCount:a,tickAmount:r})):(a=r,r=s.xTickAmount,this._drawInvertedXYLines({xCount:a,tickAmount:r})),this.drawGridBands(a,r),{el:this.elg,elGridBorders:this.elGridBorders,xAxisTickWidth:s.gridWidth/a}}drawGridBands(i,s){const e=this.w;if(void 0!==e.config.grid.row.colors&&e.config.grid.row.colors.length>0){let i=0,t=0,a=e.globals.gridHeight/s,r=e.globals.gridWidth;for(let l=0,o=0;l<s;l++,o++)o>=e.config.grid.row.colors.length&&(o=0),this._drawGridBandRect({c:o,x1:i,y1:t,x2:r,y2:a,type:"row"}),t+=e.globals.gridHeight/s}if(void 0!==e.config.grid.column.colors&&e.config.grid.column.colors.length>0){const s=e.globals.isBarHorizontal||"on"!==e.config.xaxis.tickPlacement||"category"!==e.config.xaxis.type&&!e.config.xaxis.convertedCatToNumeric?i:i-1;let t=e.globals.padHorizontal,a=0,r=e.globals.padHorizontal+e.globals.gridWidth/s,l=e.globals.gridHeight;for(let o=0,d=0;o<i;o++,d++)d>=e.config.grid.column.colors.length&&(d=0),this._drawGridBandRect({c:d,x1:t,y1:a,x2:r,y2:l,type:"column"}),t+=e.globals.gridWidth/s}}}export default Grid;