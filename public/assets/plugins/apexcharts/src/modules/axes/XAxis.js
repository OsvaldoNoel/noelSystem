import Graphics from"../Graphics";import AxesUtils from"./AxesUtils";export default class XAxis{constructor(t,s){this.ctx=t,this.elgrid=s,this.w=t.w;const i=this.w;this.axesUtils=new AxesUtils(t),this.xaxisLabels=i.globals.labels.slice(),i.globals.timescaleLabels.length>0&&!i.globals.isBarHorizontal&&(this.xaxisLabels=i.globals.timescaleLabels.slice()),i.config.xaxis.overwriteCategories&&(this.xaxisLabels=i.config.xaxis.overwriteCategories),this.drawnLabels=[],this.drawnLabelsRects=[],"top"===i.config.xaxis.position?this.offY=0:this.offY=i.globals.gridHeight,this.offY=this.offY+i.config.xaxis.axisBorder.offsetY,this.isCategoryBarHorizontal="bar"===i.config.chart.type&&i.config.plotOptions.bar.horizontal,this.xaxisFontSize=i.config.xaxis.labels.style.fontSize,this.xaxisFontFamily=i.config.xaxis.labels.style.fontFamily,this.xaxisForeColors=i.config.xaxis.labels.style.colors,this.xaxisBorderWidth=i.config.xaxis.axisBorder.width,this.isCategoryBarHorizontal&&(this.xaxisBorderWidth=i.config.yaxis[0].axisBorder.width.toString()),this.xaxisBorderWidth.indexOf("%")>-1?this.xaxisBorderWidth=i.globals.gridWidth*parseInt(this.xaxisBorderWidth,10)/100:this.xaxisBorderWidth=parseInt(this.xaxisBorderWidth,10),this.xaxisBorderHeight=i.config.xaxis.axisBorder.height,this.yaxis=i.config.yaxis[0]}drawXaxis(){let t=this.w,s=new Graphics(this.ctx),i=s.group({class:"apexcharts-xaxis",transform:`translate(${t.config.xaxis.offsetX}, ${t.config.xaxis.offsetY})`}),e=s.group({class:"apexcharts-xaxis-texts-g",transform:`translate(${t.globals.translateXAxisX}, ${t.globals.translateXAxisY})`});i.add(e);let a=[];for(let t=0;t<this.xaxisLabels.length;t++)a.push(this.xaxisLabels[t]);if(this.drawXAxisLabelAndGroup(!0,s,e,a,t.globals.isXNumeric,((t,s)=>s)),t.globals.hasXaxisGroups){let i=t.globals.groups;a=[];for(let t=0;t<i.length;t++)a.push(i[t].title);let o={};t.config.xaxis.group.style&&(o.xaxisFontSize=t.config.xaxis.group.style.fontSize,o.xaxisFontFamily=t.config.xaxis.group.style.fontFamily,o.xaxisForeColors=t.config.xaxis.group.style.colors,o.fontWeight=t.config.xaxis.group.style.fontWeight,o.cssClass=t.config.xaxis.group.style.cssClass),this.drawXAxisLabelAndGroup(!1,s,e,a,!1,((t,s)=>i[t].cols*s),o)}if(void 0!==t.config.xaxis.title.text){let e=s.group({class:"apexcharts-xaxis-title"}),a=s.drawText({x:t.globals.gridWidth/2+t.config.xaxis.title.offsetX,y:this.offY+parseFloat(this.xaxisFontSize)+("bottom"===t.config.xaxis.position?t.globals.xAxisLabelsHeight:-t.globals.xAxisLabelsHeight-10)+t.config.xaxis.title.offsetY,text:t.config.xaxis.title.text,textAnchor:"middle",fontSize:t.config.xaxis.title.style.fontSize,fontFamily:t.config.xaxis.title.style.fontFamily,fontWeight:t.config.xaxis.title.style.fontWeight,foreColor:t.config.xaxis.title.style.color,cssClass:"apexcharts-xaxis-title-text "+t.config.xaxis.title.style.cssClass});e.add(a),i.add(e)}if(t.config.xaxis.axisBorder.show){const e=t.globals.barPadForNumericAxis;let a=s.drawLine(t.globals.padHorizontal+t.config.xaxis.axisBorder.offsetX-e,this.offY,this.xaxisBorderWidth+e,this.offY,t.config.xaxis.axisBorder.color,0,this.xaxisBorderHeight);this.elgrid&&this.elgrid.elGridBorders&&t.config.grid.show?this.elgrid.elGridBorders.add(a):i.add(a)}return i}drawXAxisLabelAndGroup(t,s,i,e,a,o,l={}){let x=[],r=[],n=this.w;const g=l.xaxisFontSize||this.xaxisFontSize,f=l.xaxisFontFamily||this.xaxisFontFamily,c=l.xaxisForeColors||this.xaxisForeColors,h=l.fontWeight||n.config.xaxis.labels.style.fontWeight,d=l.cssClass||n.config.xaxis.labels.style.cssClass;let b,y=n.globals.padHorizontal,p=e.length,m="category"===n.config.xaxis.type?n.globals.dataPoints:p;if(0===m&&p>m&&(m=p),a){let t=m>1?m-1:m;b=n.globals.gridWidth/Math.min(t,p-1),y=y+o(0,b)/2+n.config.xaxis.labels.offsetX}else b=n.globals.gridWidth/m,y=y+o(0,b)+n.config.xaxis.labels.offsetX;for(let a=0;a<=p-1;a++){let l=y-o(a,b)/2+n.config.xaxis.labels.offsetX;0===a&&1===p&&b/2===y&&1===m&&(l=n.globals.gridWidth/2);let A=this.axesUtils.getLabel(e,n.globals.timescaleLabels,l,a,x,g,t),u=28;n.globals.rotateXLabels&&t&&(u=22),n.config.xaxis.title.text&&"top"===n.config.xaxis.position&&(u+=parseFloat(n.config.xaxis.title.style.fontSize)+2),t||(u=u+parseFloat(g)+(n.globals.xAxisLabelsHeight-n.globals.xAxisGroupLabelsHeight)+(n.globals.rotateXLabels?10:0));A=void 0!==n.config.xaxis.tickAmount&&"dataPoints"!==n.config.xaxis.tickAmount&&"datetime"!==n.config.xaxis.type?this.axesUtils.checkLabelBasedOnTickamount(a,A,p):this.axesUtils.checkForOverflowingLabels(a,A,p,x,r);const w=()=>t&&n.config.xaxis.convertedCatToNumeric?c[n.globals.minX+a-1]:c[a];if(n.config.xaxis.labels.show){let e=s.drawText({x:A.x,y:this.offY+n.config.xaxis.labels.offsetY+u-("top"===n.config.xaxis.position?n.globals.xAxisHeight+n.config.xaxis.axisTicks.height-2:0),text:A.text,textAnchor:"middle",fontWeight:A.isBold?600:h,fontSize:g,fontFamily:f,foreColor:Array.isArray(c)?w():c,isPlainText:!1,cssClass:(t?"apexcharts-xaxis-label ":"apexcharts-xaxis-group-label ")+d});if(i.add(e),e.on("click",(t=>{if("function"==typeof n.config.chart.events.xAxisLabelClick){const s=Object.assign({},n,{labelIndex:a});n.config.chart.events.xAxisLabelClick(t,this.ctx,s)}})),t){let t=document.createElementNS(n.globals.SVGNS,"title");t.textContent=Array.isArray(A.text)?A.text.join(" "):A.text,e.node.appendChild(t),""!==A.text&&(x.push(A.text),r.push(A))}}a<p-1&&(y+=o(a+1,b))}}drawXaxisInversed(t){let s,i,e=this.w,a=new Graphics(this.ctx),o=e.config.yaxis[0].opposite?e.globals.translateYAxisX[t]:0,l=a.group({class:"apexcharts-yaxis apexcharts-xaxis-inversed",rel:t}),x=a.group({class:"apexcharts-yaxis-texts-g apexcharts-xaxis-inversed-texts-g",transform:"translate("+o+", 0)"});l.add(x);let r=[];if(e.config.yaxis[t].show)for(let t=0;t<this.xaxisLabels.length;t++)r.push(this.xaxisLabels[t]);s=e.globals.gridHeight/r.length,i=-s/2.2;let n=e.globals.yLabelFormatters[0];const g=e.config.yaxis[0].labels;if(g.show)for(let o=0;o<=r.length-1;o++){let l=void 0===r[o]?"":r[o];l=n(l,{seriesIndex:t,dataPointIndex:o,w:e});const f=this.axesUtils.getYAxisForeColor(g.style.colors,t),c=()=>Array.isArray(f)?f[o]:f;let h=0;Array.isArray(l)&&(h=l.length/2*parseInt(g.style.fontSize,10));let d=g.offsetX-15,b="end";this.yaxis.opposite&&(b="start"),"left"===e.config.yaxis[0].labels.align?(d=g.offsetX,b="start"):"center"===e.config.yaxis[0].labels.align?(d=g.offsetX,b="middle"):"right"===e.config.yaxis[0].labels.align&&(b="end");let y=a.drawText({x:d,y:i+s+g.offsetY-h,text:l,textAnchor:b,foreColor:c(),fontSize:g.style.fontSize,fontFamily:g.style.fontFamily,fontWeight:g.style.fontWeight,isPlainText:!1,cssClass:"apexcharts-yaxis-label "+g.style.cssClass,maxWidth:g.maxWidth});x.add(y),y.on("click",(t=>{if("function"==typeof e.config.chart.events.xAxisLabelClick){const s=Object.assign({},e,{labelIndex:o});e.config.chart.events.xAxisLabelClick(t,this.ctx,s)}}));let p=document.createElementNS(e.globals.SVGNS,"title");if(p.textContent=Array.isArray(l)?l.join(" "):l,y.node.appendChild(p),0!==e.config.yaxis[t].labels.rotate){let s=a.rotateAroundCenter(y.node);y.node.setAttribute("transform",`rotate(${e.config.yaxis[t].labels.rotate} 0 ${s.y})`)}i+=s}if(void 0!==e.config.yaxis[0].title.text){let t=a.group({class:"apexcharts-yaxis-title apexcharts-xaxis-title-inversed",transform:"translate("+o+", 0)"}),s=a.drawText({x:e.config.yaxis[0].title.offsetX,y:e.globals.gridHeight/2+e.config.yaxis[0].title.offsetY,text:e.config.yaxis[0].title.text,textAnchor:"middle",foreColor:e.config.yaxis[0].title.style.color,fontSize:e.config.yaxis[0].title.style.fontSize,fontWeight:e.config.yaxis[0].title.style.fontWeight,fontFamily:e.config.yaxis[0].title.style.fontFamily,cssClass:"apexcharts-yaxis-title-text "+e.config.yaxis[0].title.style.cssClass});t.add(s),l.add(t)}let f=0;this.isCategoryBarHorizontal&&e.config.yaxis[0].opposite&&(f=e.globals.gridWidth);const c=e.config.xaxis.axisBorder;if(c.show){let t=a.drawLine(e.globals.padHorizontal+c.offsetX+f,1+c.offsetY,e.globals.padHorizontal+c.offsetX+f,e.globals.gridHeight+c.offsetY,c.color,0);this.elgrid&&this.elgrid.elGridBorders&&e.config.grid.show?this.elgrid.elGridBorders.add(t):l.add(t)}return e.config.yaxis[0].axisTicks.show&&this.axesUtils.drawYAxisTicks(f,r.length,e.config.yaxis[0].axisBorder,e.config.yaxis[0].axisTicks,0,s,l),l}drawXaxisTicks(t,s,i){let e=this.w,a=t;if(t<0||t-2>e.globals.gridWidth)return;let o=this.offY+e.config.xaxis.axisTicks.offsetY;if(s=s+o+e.config.xaxis.axisTicks.height,"top"===e.config.xaxis.position&&(s=o-e.config.xaxis.axisTicks.height),e.config.xaxis.axisTicks.show){let l=new Graphics(this.ctx).drawLine(t+e.config.xaxis.axisTicks.offsetX,o+e.config.xaxis.offsetY,a+e.config.xaxis.axisTicks.offsetX,s+e.config.xaxis.offsetY,e.config.xaxis.axisTicks.color);i.add(l),l.node.classList.add("apexcharts-xaxis-tick")}}getXAxisTicksPositions(){const t=this.w;let s=[];const i=this.xaxisLabels.length;let e=t.globals.padHorizontal;if(t.globals.timescaleLabels.length>0)for(let t=0;t<i;t++)e=this.xaxisLabels[t].position,s.push(e);else{let a=i;for(let i=0;i<a;i++){let i=a;t.globals.isXNumeric&&"bar"!==t.config.chart.type&&(i-=1),e+=t.globals.gridWidth/i,s.push(e)}}return s}xAxisLabelCorrections(){let t=this.w,s=new Graphics(this.ctx),i=t.globals.dom.baseEl.querySelector(".apexcharts-xaxis-texts-g"),e=t.globals.dom.baseEl.querySelectorAll(".apexcharts-xaxis-texts-g text:not(.apexcharts-xaxis-group-label)"),a=t.globals.dom.baseEl.querySelectorAll(".apexcharts-yaxis-inversed text"),o=t.globals.dom.baseEl.querySelectorAll(".apexcharts-xaxis-inversed-texts-g text tspan");if(t.globals.rotateXLabels||t.config.xaxis.labels.rotateAlways)for(let a=0;a<e.length;a++){let o=s.rotateAroundCenter(e[a]);o.y=o.y-1,o.x=o.x+1,e[a].setAttribute("transform",`rotate(${t.config.xaxis.labels.rotate} ${o.x} ${o.y})`),e[a].setAttribute("text-anchor","end");let l=10;i.setAttribute("transform",`translate(0, ${-l})`);let x=e[a].childNodes;t.config.xaxis.labels.trim&&Array.prototype.forEach.call(x,(i=>{s.placeTextWithEllipsis(i,i.textContent,t.globals.xAxisLabelsHeight-("bottom"===t.config.legend.position?20:10))}))}else{let i=t.globals.gridWidth/(t.globals.labels.length+1);for(let a=0;a<e.length;a++){let o=e[a].childNodes;t.config.xaxis.labels.trim&&"datetime"!==t.config.xaxis.type&&Array.prototype.forEach.call(o,(t=>{s.placeTextWithEllipsis(t,t.textContent,i)}))}}if(a.length>0){let i=a[a.length-1].getBBox(),e=a[0].getBBox();i.x<-20&&a[a.length-1].parentNode.removeChild(a[a.length-1]),e.x+e.width>t.globals.gridWidth&&!t.globals.isBarHorizontal&&a[0].parentNode.removeChild(a[0]);for(let i=0;i<o.length;i++)s.placeTextWithEllipsis(o[i],o[i].textContent,t.config.yaxis[0].labels.maxWidth-(t.config.yaxis[0].title.text?2*parseFloat(t.config.yaxis[0].title.style.fontSize):0)-15)}}}