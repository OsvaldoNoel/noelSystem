import Graphics from"./Graphics";import Exports from"./Exports";import Scales from"./Scales";import Utils from"./../utils/Utils";import icoPan from"./../assets/ico-pan-hand.svg";import icoZoom from"./../assets/ico-zoom-in.svg";import icoReset from"./../assets/ico-home.svg";import icoZoomIn from"./../assets/ico-plus.svg";import icoZoomOut from"./../assets/ico-minus.svg";import icoSelect from"./../assets/ico-select.svg";import icoMenu from"./../assets/ico-menu.svg";export default class Toolbar{constructor(t){this.ctx=t,this.w=t.w;const e=this.w;this.ev=this.w.config.chart.events,this.selectedClass="apexcharts-selected",this.localeValues=this.w.globals.locale.toolbar,this.minX=e.globals.minX,this.maxX=e.globals.maxX}createToolbar(){let t=this.w;const e=()=>document.createElement("div"),s=e();if(s.setAttribute("class","apexcharts-toolbar"),s.style.top=t.config.chart.toolbar.offsetY+"px",s.style.right=3-t.config.chart.toolbar.offsetX+"px",t.globals.dom.elWrap.appendChild(s),this.elZoom=e(),this.elZoomIn=e(),this.elZoomOut=e(),this.elPan=e(),this.elSelection=e(),this.elZoomReset=e(),this.elMenuIcon=e(),this.elMenu=e(),this.elCustomIcons=[],this.t=t.config.chart.toolbar.tools,Array.isArray(this.t.customIcons))for(let t=0;t<this.t.customIcons.length;t++)this.elCustomIcons.push(e());let o=[];const i=(e,s,i)=>{const l=e.toLowerCase();this.t[l]&&t.config.chart.zoom.enabled&&o.push({el:s,icon:"string"==typeof this.t[l]?this.t[l]:i,title:this.localeValues[e],class:`apexcharts-${l}-icon`})};i("zoomIn",this.elZoomIn,icoZoomIn),i("zoomOut",this.elZoomOut,icoZoomOut);const l=e=>{this.t[e]&&t.config.chart[e].enabled&&o.push({el:"zoom"===e?this.elZoom:this.elSelection,icon:"string"==typeof this.t[e]?this.t[e]:"zoom"===e?icoZoom:icoSelect,title:this.localeValues["zoom"===e?"selectionZoom":"selection"],class:t.globals.isTouchDevice?"apexcharts-element-hidden":`apexcharts-${e}-icon`})};l("zoom"),l("selection"),this.t.pan&&t.config.chart.zoom.enabled&&o.push({el:this.elPan,icon:"string"==typeof this.t.pan?this.t.pan:icoPan,title:this.localeValues.pan,class:t.globals.isTouchDevice?"apexcharts-element-hidden":"apexcharts-pan-icon"}),i("reset",this.elZoomReset,icoReset),this.t.download&&o.push({el:this.elMenuIcon,icon:"string"==typeof this.t.download?this.t.download:icoMenu,title:this.localeValues.menu,class:"apexcharts-menu-icon"});for(let t=0;t<this.elCustomIcons.length;t++)o.push({el:this.elCustomIcons[t],icon:this.t.customIcons[t].icon,title:this.t.customIcons[t].title,index:this.t.customIcons[t].index,class:"apexcharts-toolbar-custom-icon "+this.t.customIcons[t].class});o.forEach(((t,e)=>{t.index&&Utils.moveIndexInArray(o,e,t.index)}));for(let t=0;t<o.length;t++)Graphics.setAttrs(o[t].el,{class:o[t].class,title:o[t].title}),o[t].el.innerHTML=o[t].icon,s.appendChild(o[t].el);this._createHamburgerMenu(s),t.globals.zoomEnabled?this.elZoom.classList.add(this.selectedClass):t.globals.panEnabled?this.elPan.classList.add(this.selectedClass):t.globals.selectionEnabled&&this.elSelection.classList.add(this.selectedClass),this.addToolbarEventListeners()}_createHamburgerMenu(t){this.elMenuItems=[],t.appendChild(this.elMenu),Graphics.setAttrs(this.elMenu,{class:"apexcharts-menu"});const e=[{name:"exportSVG",title:this.localeValues.exportToSVG},{name:"exportPNG",title:this.localeValues.exportToPNG},{name:"exportCSV",title:this.localeValues.exportToCSV}];for(let t=0;t<e.length;t++)this.elMenuItems.push(document.createElement("div")),this.elMenuItems[t].innerHTML=e[t].title,Graphics.setAttrs(this.elMenuItems[t],{class:`apexcharts-menu-item ${e[t].name}`,title:e[t].title}),this.elMenu.appendChild(this.elMenuItems[t])}addToolbarEventListeners(){this.elZoomReset.addEventListener("click",this.handleZoomReset.bind(this)),this.elSelection.addEventListener("click",this.toggleZoomSelection.bind(this,"selection")),this.elZoom.addEventListener("click",this.toggleZoomSelection.bind(this,"zoom")),this.elZoomIn.addEventListener("click",this.handleZoomIn.bind(this)),this.elZoomOut.addEventListener("click",this.handleZoomOut.bind(this)),this.elPan.addEventListener("click",this.togglePanning.bind(this)),this.elMenuIcon.addEventListener("click",this.toggleMenu.bind(this)),this.elMenuItems.forEach((t=>{t.classList.contains("exportSVG")?t.addEventListener("click",this.handleDownload.bind(this,"svg")):t.classList.contains("exportPNG")?t.addEventListener("click",this.handleDownload.bind(this,"png")):t.classList.contains("exportCSV")&&t.addEventListener("click",this.handleDownload.bind(this,"csv"))}));for(let t=0;t<this.t.customIcons.length;t++)this.elCustomIcons[t].addEventListener("click",this.t.customIcons[t].click.bind(this,this.ctx,this.ctx.w))}toggleZoomSelection(t){this.ctx.getSyncedCharts().forEach((e=>{e.ctx.toolbar.toggleOtherControls();let s="selection"===t?e.ctx.toolbar.elSelection:e.ctx.toolbar.elZoom,o="selection"===t?"selectionEnabled":"zoomEnabled";e.w.globals[o]=!e.w.globals[o],s.classList.contains(e.ctx.toolbar.selectedClass)?s.classList.remove(e.ctx.toolbar.selectedClass):s.classList.add(e.ctx.toolbar.selectedClass)}))}getToolbarIconsReference(){const t=this.w;this.elZoom||(this.elZoom=t.globals.dom.baseEl.querySelector(".apexcharts-zoom-icon")),this.elPan||(this.elPan=t.globals.dom.baseEl.querySelector(".apexcharts-pan-icon")),this.elSelection||(this.elSelection=t.globals.dom.baseEl.querySelector(".apexcharts-selection-icon"))}enableZoomPanFromToolbar(t){this.toggleOtherControls(),"pan"===t?this.w.globals.panEnabled=!0:this.w.globals.zoomEnabled=!0;const e="pan"===t?this.elPan:this.elZoom,s="pan"===t?this.elZoom:this.elPan;e&&e.classList.add(this.selectedClass),s&&s.classList.remove(this.selectedClass)}togglePanning(){this.ctx.getSyncedCharts().forEach((t=>{t.ctx.toolbar.toggleOtherControls(),t.w.globals.panEnabled=!t.w.globals.panEnabled,t.ctx.toolbar.elPan.classList.contains(t.ctx.toolbar.selectedClass)?t.ctx.toolbar.elPan.classList.remove(t.ctx.toolbar.selectedClass):t.ctx.toolbar.elPan.classList.add(t.ctx.toolbar.selectedClass)}))}toggleOtherControls(){const t=this.w;t.globals.panEnabled=!1,t.globals.zoomEnabled=!1,t.globals.selectionEnabled=!1,this.getToolbarIconsReference();[this.elPan,this.elSelection,this.elZoom].forEach((t=>{t&&t.classList.remove(this.selectedClass)}))}handleZoomIn(){const t=this.w;t.globals.isRangeBar&&(this.minX=t.globals.minY,this.maxX=t.globals.maxY);const e=(this.minX+this.maxX)/2;let s=(this.minX+e)/2,o=(this.maxX+e)/2;const i=this._getNewMinXMaxX(s,o);t.globals.disableZoomIn||this.zoomUpdateOptions(i.minX,i.maxX)}handleZoomOut(){const t=this.w;if(t.globals.isRangeBar&&(this.minX=t.globals.minY,this.maxX=t.globals.maxY),"datetime"===t.config.xaxis.type&&new Date(this.minX).getUTCFullYear()<1e3)return;const e=(this.minX+this.maxX)/2;let s=this.minX-(e-this.minX),o=this.maxX-(e-this.maxX);const i=this._getNewMinXMaxX(s,o);t.globals.disableZoomOut||this.zoomUpdateOptions(i.minX,i.maxX)}_getNewMinXMaxX(t,e){const s=this.w.config.xaxis.convertedCatToNumeric;return{minX:s?Math.floor(t):t,maxX:s?Math.floor(e):e}}zoomUpdateOptions(t,e){const s=this.w;if(void 0===t&&void 0===e)return void this.handleZoomReset();if(s.config.xaxis.convertedCatToNumeric&&(t<1&&(t=1,e=s.globals.dataPoints),e-t<2))return;let o={min:t,max:e};const i=this.getBeforeZoomRange(o);i&&(o=i.xaxis);let l={xaxis:o},a=Utils.clone(s.globals.initialConfig.yaxis);s.config.chart.group||(l.yaxis=a),this.w.globals.zoomed=!0,this.ctx.updateHelpers._updateOptions(l,!1,this.w.config.chart.animations.dynamicAnimation.enabled),this.zoomCallback(o,a)}zoomCallback(t,e){"function"==typeof this.ev.zoomed&&this.ev.zoomed(this.ctx,{xaxis:t,yaxis:e})}getBeforeZoomRange(t,e){let s=null;return"function"==typeof this.ev.beforeZoom&&(s=this.ev.beforeZoom(this,{xaxis:t,yaxis:e})),s}toggleMenu(){window.setTimeout((()=>{this.elMenu.classList.contains("apexcharts-menu-open")?this.elMenu.classList.remove("apexcharts-menu-open"):this.elMenu.classList.add("apexcharts-menu-open")}),0)}handleDownload(t){const e=this.w,s=new Exports(this.ctx);switch(t){case"svg":s.exportToSVG(this.ctx);break;case"png":s.exportToPng(this.ctx);break;case"csv":s.exportToCSV({series:e.config.series,columnDelimiter:e.config.chart.toolbar.export.csv.columnDelimiter})}}handleZoomReset(t){this.ctx.getSyncedCharts().forEach((t=>{let e=t.w;if(e.globals.lastXAxis.min=e.globals.initialConfig.xaxis.min,e.globals.lastXAxis.max=e.globals.initialConfig.xaxis.max,t.updateHelpers.revertDefaultAxisMinMax(),"function"==typeof e.config.chart.events.beforeResetZoom){const s=e.config.chart.events.beforeResetZoom(t,e);s&&t.updateHelpers.revertDefaultAxisMinMax(s)}"function"==typeof e.config.chart.events.zoomed&&t.ctx.toolbar.zoomCallback({min:e.config.xaxis.min,max:e.config.xaxis.max}),e.globals.zoomed=!1;let s=t.ctx.series.emptyCollapsedSeries(Utils.clone(e.globals.initialSeries));t.updateHelpers._updateSeries(s,e.config.chart.animations.dynamicAnimation.enabled)}))}destroy(){this.elZoom=null,this.elZoomIn=null,this.elZoomOut=null,this.elPan=null,this.elSelection=null,this.elZoomReset=null,this.elMenuIcon=null}}