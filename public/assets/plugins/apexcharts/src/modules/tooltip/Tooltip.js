import Labels from"./Labels";import Position from"./Position";import Marker from"./Marker";import Intersect from"./Intersect";import AxesTooltip from"./AxesTooltip";import Graphics from"../Graphics";import Series from"../Series";import XAxis from"./../axes/XAxis";import Utils from"./Utils";export default class Tooltip{constructor(t){this.ctx=t,this.w=t.w;const e=this.w;this.tConfig=e.config.tooltip,this.tooltipUtil=new Utils(this),this.tooltipLabels=new Labels(this),this.tooltipPosition=new Position(this),this.marker=new Marker(this),this.intersect=new Intersect(this),this.axesTooltip=new AxesTooltip(this),this.showOnIntersect=this.tConfig.intersect,this.showTooltipTitle=this.tConfig.x.show,this.fixedTooltip=this.tConfig.fixed.enabled,this.xaxisTooltip=null,this.yaxisTTEls=null,this.isBarShared=!e.globals.isBarHorizontal&&this.tConfig.shared,this.lastHoverTime=Date.now()}getElTooltip(t){return t||(t=this),t.w.globals.dom.baseEl?t.w.globals.dom.baseEl.querySelector(".apexcharts-tooltip"):null}getElXCrosshairs(){return this.w.globals.dom.baseEl.querySelector(".apexcharts-xcrosshairs")}getElGrid(){return this.w.globals.dom.baseEl.querySelector(".apexcharts-grid")}drawTooltip(t){let e=this.w;this.xyRatios=t,this.isXAxisTooltipEnabled=e.config.xaxis.tooltip.enabled&&e.globals.axisCharts,this.yaxisTooltips=e.config.yaxis.map(((t,s)=>!!(t.show&&t.tooltip.enabled&&e.globals.axisCharts))),this.allTooltipSeriesGroups=[],e.globals.axisCharts||(this.showTooltipTitle=!1);const s=document.createElement("div");if(s.classList.add("apexcharts-tooltip"),e.config.tooltip.cssClass&&s.classList.add(e.config.tooltip.cssClass),s.classList.add(`apexcharts-theme-${this.tConfig.theme}`),e.globals.dom.elWrap.appendChild(s),e.globals.axisCharts){this.axesTooltip.drawXaxisTooltip(),this.axesTooltip.drawYaxisTooltip(),this.axesTooltip.setXCrosshairWidth(),this.axesTooltip.handleYCrosshair();let t=new XAxis(this.ctx);this.xAxisTicksPositions=t.getXAxisTicksPositions()}if(!e.globals.comboCharts&&!this.tConfig.intersect&&"rangeBar"!==e.config.chart.type||this.tConfig.shared||(this.showOnIntersect=!0),0!==e.config.markers.size&&0!==e.globals.markers.largestSize||this.marker.drawDynamicPoints(this),e.globals.collapsedSeries.length===e.globals.series.length)return;this.dataPointsDividedHeight=e.globals.gridHeight/e.globals.dataPoints,this.dataPointsDividedWidth=e.globals.gridWidth/e.globals.dataPoints,this.showTooltipTitle&&(this.tooltipTitle=document.createElement("div"),this.tooltipTitle.classList.add("apexcharts-tooltip-title"),this.tooltipTitle.style.fontFamily=this.tConfig.style.fontFamily||e.config.chart.fontFamily,this.tooltipTitle.style.fontSize=this.tConfig.style.fontSize,s.appendChild(this.tooltipTitle));let i=e.globals.series.length;(e.globals.xyCharts||e.globals.comboCharts)&&this.tConfig.shared&&(i=this.showOnIntersect?1:e.globals.series.length),this.legendLabels=e.globals.dom.baseEl.querySelectorAll(".apexcharts-legend-text"),this.ttItems=this.createTTElements(i),this.addSVGEvents()}createTTElements(t){const e=this.w;let s=[];const i=this.getElTooltip();for(let o=0;o<t;o++){let a=document.createElement("div");a.classList.add("apexcharts-tooltip-series-group"),a.style.order=e.config.tooltip.inverseOrder?t-o:o+1,this.tConfig.shared&&this.tConfig.enabledOnSeries&&Array.isArray(this.tConfig.enabledOnSeries)&&this.tConfig.enabledOnSeries.indexOf(o)<0&&a.classList.add("apexcharts-tooltip-series-group-hidden");let l=document.createElement("span");l.classList.add("apexcharts-tooltip-marker"),l.style.backgroundColor=e.globals.colors[o],a.appendChild(l);const r=document.createElement("div");r.classList.add("apexcharts-tooltip-text"),r.style.fontFamily=this.tConfig.style.fontFamily||e.config.chart.fontFamily,r.style.fontSize=this.tConfig.style.fontSize,["y","goals","z"].forEach((t=>{const e=document.createElement("div");e.classList.add(`apexcharts-tooltip-${t}-group`);let s=document.createElement("span");s.classList.add(`apexcharts-tooltip-text-${t}-label`),e.appendChild(s);let i=document.createElement("span");i.classList.add(`apexcharts-tooltip-text-${t}-value`),e.appendChild(i),r.appendChild(e)})),a.appendChild(r),i.appendChild(a),s.push(a)}return s}addSVGEvents(){const t=this.w;let e=t.config.chart.type;const s=this.getElTooltip(),i=!("bar"!==e&&"candlestick"!==e&&"boxPlot"!==e&&"rangeBar"!==e),o="area"===e||"line"===e||"scatter"===e||"bubble"===e||"radar"===e;let a=t.globals.dom.Paper.node;const l=this.getElGrid();l&&(this.seriesBound=l.getBoundingClientRect());let r,h=[],n=[],c={hoverArea:a,elGrid:l,tooltipEl:s,tooltipY:h,tooltipX:n,ttItems:this.ttItems};if(t.globals.axisCharts&&(o?r=t.globals.dom.baseEl.querySelectorAll(".apexcharts-series[data\\:longestSeries='true'] .apexcharts-marker"):i?r=t.globals.dom.baseEl.querySelectorAll(".apexcharts-series .apexcharts-bar-area, .apexcharts-series .apexcharts-candlestick-area, .apexcharts-series .apexcharts-boxPlot-area, .apexcharts-series .apexcharts-rangebar-area"):"heatmap"!==e&&"treemap"!==e||(r=t.globals.dom.baseEl.querySelectorAll(".apexcharts-series .apexcharts-heatmap, .apexcharts-series .apexcharts-treemap")),r&&r.length))for(let t=0;t<r.length;t++)h.push(r[t].getAttribute("cy")),n.push(r[t].getAttribute("cx"));if(t.globals.xyCharts&&!this.showOnIntersect||t.globals.comboCharts&&!this.showOnIntersect||i&&this.tooltipUtil.hasBars()&&this.tConfig.shared)this.addPathsEventListeners([a],c);else if(i&&!t.globals.comboCharts||o&&this.showOnIntersect)this.addDatapointEventsListeners(c);else if(!t.globals.axisCharts||"heatmap"===e||"treemap"===e){let e=t.globals.dom.baseEl.querySelectorAll(".apexcharts-series");this.addPathsEventListeners(e,c)}if(this.showOnIntersect){let e=t.globals.dom.baseEl.querySelectorAll(".apexcharts-line-series .apexcharts-marker, .apexcharts-area-series .apexcharts-marker");e.length>0&&this.addPathsEventListeners(e,c),this.tooltipUtil.hasBars()&&!this.tConfig.shared&&this.addDatapointEventsListeners(c)}}drawFixedTooltipRect(){let t=this.w;const e=this.getElTooltip();let s=e.getBoundingClientRect(),i=s.width+10,o=s.height+10,a=this.tConfig.fixed.offsetX,l=this.tConfig.fixed.offsetY;const r=this.tConfig.fixed.position.toLowerCase();return r.indexOf("right")>-1&&(a=a+t.globals.svgWidth-i+10),r.indexOf("bottom")>-1&&(l=l+t.globals.svgHeight-o-10),e.style.left=a+"px",e.style.top=l+"px",{x:a,y:l,ttWidth:i,ttHeight:o}}addDatapointEventsListeners(t){let e=this.w.globals.dom.baseEl.querySelectorAll(".apexcharts-series-markers .apexcharts-marker, .apexcharts-bar-area, .apexcharts-candlestick-area, .apexcharts-boxPlot-area, .apexcharts-rangebar-area");this.addPathsEventListeners(e,t)}addPathsEventListeners(t,e){let s=this;for(let i=0;i<t.length;i++){let o={paths:t[i],tooltipEl:e.tooltipEl,tooltipY:e.tooltipY,tooltipX:e.tooltipX,elGrid:e.elGrid,hoverArea:e.hoverArea,ttItems:e.ttItems};["mousemove","mouseup","touchmove","mouseout","touchend"].map((e=>t[i].addEventListener(e,s.onSeriesHover.bind(s,o),{capture:!1,passive:!0})))}}onSeriesHover(t,e){const s=Date.now()-this.lastHoverTime;s>=100?this.seriesHover(t,e):(clearTimeout(this.seriesHoverTimeout),this.seriesHoverTimeout=setTimeout((()=>{this.seriesHover(t,e)}),100-s))}seriesHover(t,e){this.lastHoverTime=Date.now();let s=[];const i=this.w;i.config.chart.group&&(s=this.ctx.getGroupedCharts()),i.globals.axisCharts&&(i.globals.minX===-1/0&&i.globals.maxX===1/0||0===i.globals.dataPoints)||(s.length?s.forEach((s=>{const i=this.getElTooltip(s),o={paths:t.paths,tooltipEl:i,tooltipY:t.tooltipY,tooltipX:t.tooltipX,elGrid:t.elGrid,hoverArea:t.hoverArea,ttItems:s.w.globals.tooltip.ttItems};s.w.globals.minX===this.w.globals.minX&&s.w.globals.maxX===this.w.globals.maxX&&s.w.globals.tooltip.seriesHoverByContext({chartCtx:s,ttCtx:s.w.globals.tooltip,opt:o,e})})):this.seriesHoverByContext({chartCtx:this.ctx,ttCtx:this.w.globals.tooltip,opt:t,e}))}seriesHoverByContext({chartCtx:t,ttCtx:e,opt:s,e:i}){let o=t.w;const a=this.getElTooltip();if(a){if(e.tooltipRect={x:0,y:0,ttWidth:a.getBoundingClientRect().width,ttHeight:a.getBoundingClientRect().height},e.e=i,e.tooltipUtil.hasBars()&&!o.globals.comboCharts&&!e.isBarShared&&this.tConfig.onDatasetHover.highlightDataSeries){new Series(t).toggleSeriesOnHover(i,i.target.parentNode)}e.fixedTooltip&&e.drawFixedTooltipRect(),o.globals.axisCharts?e.axisChartsTooltips({e:i,opt:s,tooltipRect:e.tooltipRect}):e.nonAxisChartsTooltips({e:i,opt:s,tooltipRect:e.tooltipRect})}}axisChartsTooltips({e:t,opt:e}){let s,i,o=this.w,a=e.elGrid.getBoundingClientRect();const l="touchmove"===t.type?t.touches[0].clientX:t.clientX,r="touchmove"===t.type?t.touches[0].clientY:t.clientY;if(this.clientY=r,this.clientX=l,o.globals.capturedSeriesIndex=-1,o.globals.capturedDataPointIndex=-1,r<a.top||r>a.top+a.height)return void this.handleMouseOut(e);if(Array.isArray(this.tConfig.enabledOnSeries)&&!o.config.tooltip.shared){const t=parseInt(e.paths.getAttribute("index"),10);if(this.tConfig.enabledOnSeries.indexOf(t)<0)return void this.handleMouseOut(e)}const h=this.getElTooltip(),n=this.getElXCrosshairs();let c=o.globals.xyCharts||"bar"===o.config.chart.type&&!o.globals.isBarHorizontal&&this.tooltipUtil.hasBars()&&this.tConfig.shared||o.globals.comboCharts&&this.tooltipUtil.hasBars();if("mousemove"===t.type||"touchmove"===t.type||"mouseup"===t.type){if(o.globals.collapsedSeries.length+o.globals.ancillaryCollapsedSeries.length===o.globals.series.length)return;null!==n&&n.classList.add("apexcharts-active");const a=this.yaxisTooltips.filter((t=>!0===t));if(null!==this.ycrosshairs&&a.length&&this.ycrosshairs.classList.add("apexcharts-active"),c&&!this.showOnIntersect)this.handleStickyTooltip(t,l,r,e);else if("heatmap"===o.config.chart.type||"treemap"===o.config.chart.type){let a=this.intersect.handleHeatTreeTooltip({e:t,opt:e,x:s,y:i,type:o.config.chart.type});s=a.x,i=a.y,h.style.left=s+"px",h.style.top=i+"px"}else this.tooltipUtil.hasBars()&&this.intersect.handleBarTooltip({e:t,opt:e}),this.tooltipUtil.hasMarkers()&&this.intersect.handleMarkerTooltip({e:t,opt:e,x:s,y:i});if(this.yaxisTooltips.length)for(let t=0;t<o.config.yaxis.length;t++)this.axesTooltip.drawYaxisTooltipText(t,r,this.xyRatios);e.tooltipEl.classList.add("apexcharts-active")}else"mouseout"!==t.type&&"touchend"!==t.type||this.handleMouseOut(e)}nonAxisChartsTooltips({e:t,opt:e,tooltipRect:s}){let i=this.w,o=e.paths.getAttribute("rel");const a=this.getElTooltip();let l=i.globals.dom.elWrap.getBoundingClientRect();if("mousemove"===t.type||"touchmove"===t.type){a.classList.add("apexcharts-active"),this.tooltipLabels.drawSeriesTexts({ttItems:e.ttItems,i:parseInt(o,10)-1,shared:!1});let t=i.globals.clientX-l.left-s.ttWidth/2,r=i.globals.clientY-l.top-s.ttHeight-10;if(a.style.left=t+"px",a.style.top=r+"px",i.config.legend.tooltipHoverFormatter){const t=o-1;let e=(0,i.config.legend.tooltipHoverFormatter)(this.legendLabels[t].getAttribute("data:default-text"),{seriesIndex:t,dataPointIndex:t,w:i});this.legendLabels[t].innerHTML=e}}else"mouseout"!==t.type&&"touchend"!==t.type||(a.classList.remove("apexcharts-active"),i.config.legend.tooltipHoverFormatter&&this.legendLabels.forEach((t=>{const e=t.getAttribute("data:default-text");t.innerHTML=decodeURIComponent(e)})))}handleStickyTooltip(t,e,s,i){const o=this.w;let a=this.tooltipUtil.getNearestValues({context:this,hoverArea:i.hoverArea,elGrid:i.elGrid,clientX:e,clientY:s}),l=a.j,r=a.capturedSeries;o.globals.collapsedSeriesIndices.includes(r)&&(r=null);const h=i.elGrid.getBoundingClientRect();if(a.hoverX<0||a.hoverX>h.width)this.handleMouseOut(i);else if(null!==r)this.handleStickyCapturedSeries(t,r,i,l);else if(this.tooltipUtil.isXoverlap(l)||o.globals.isBarHorizontal){const e=o.globals.series.findIndex(((t,e)=>!o.globals.collapsedSeriesIndices.includes(e)));this.create(t,this,e,l,i.ttItems)}}handleStickyCapturedSeries(t,e,s,i){const o=this.w;if(!this.tConfig.shared){if(null===o.globals.series[e][i])return void this.handleMouseOut(s)}if(void 0!==o.globals.series[e][i])this.tConfig.shared&&this.tooltipUtil.isXoverlap(i)&&this.tooltipUtil.isInitialSeriesSameLen()?this.create(t,this,e,i,s.ttItems):this.create(t,this,e,i,s.ttItems,!1);else if(this.tooltipUtil.isXoverlap(i)){const e=o.globals.series.findIndex(((t,e)=>!o.globals.collapsedSeriesIndices.includes(e)));this.create(t,this,e,i,s.ttItems)}}deactivateHoverFilter(){let t=this.w,e=new Graphics(this.ctx),s=t.globals.dom.Paper.select(".apexcharts-bar-area");for(let t=0;t<s.length;t++)e.pathMouseLeave(s[t])}handleMouseOut(t){const e=this.w,s=this.getElXCrosshairs();if(t.tooltipEl.classList.remove("apexcharts-active"),this.deactivateHoverFilter(),"bubble"!==e.config.chart.type&&this.marker.resetPointsSize(),null!==s&&s.classList.remove("apexcharts-active"),null!==this.ycrosshairs&&this.ycrosshairs.classList.remove("apexcharts-active"),this.isXAxisTooltipEnabled&&this.xaxisTooltip.classList.remove("apexcharts-active"),this.yaxisTooltips.length){null===this.yaxisTTEls&&(this.yaxisTTEls=e.globals.dom.baseEl.querySelectorAll(".apexcharts-yaxistooltip"));for(let t=0;t<this.yaxisTTEls.length;t++)this.yaxisTTEls[t].classList.remove("apexcharts-active")}e.config.legend.tooltipHoverFormatter&&this.legendLabels.forEach((t=>{const e=t.getAttribute("data:default-text");t.innerHTML=decodeURIComponent(e)}))}markerClick(t,e,s){const i=this.w;"function"==typeof i.config.chart.events.markerClick&&i.config.chart.events.markerClick(t,this.ctx,{seriesIndex:e,dataPointIndex:s,w:i}),this.ctx.events.fireEvent("markerClick",[t,this.ctx,{seriesIndex:e,dataPointIndex:s,w:i}])}create(t,e,s,i,o,a=null){let l=this.w,r=e;"mouseup"===t.type&&this.markerClick(t,s,i),null===a&&(a=this.tConfig.shared);const h=this.tooltipUtil.hasMarkers(s),n=this.tooltipUtil.getElBars();if(l.config.legend.tooltipHoverFormatter){let t=l.config.legend.tooltipHoverFormatter,e=Array.from(this.legendLabels);e.forEach((t=>{const e=t.getAttribute("data:default-text");t.innerHTML=decodeURIComponent(e)}));for(let o=0;o<e.length;o++){const r=e[o],h=parseInt(r.getAttribute("i"),10),n=decodeURIComponent(r.getAttribute("data:default-text"));let c=t(n,{seriesIndex:a?h:s,dataPointIndex:i,w:l});if(a)r.innerHTML=l.globals.collapsedSeriesIndices.indexOf(h)<0?c:n;else if(r.innerHTML=h===s?c:n,s===h)break}}const c={ttItems:o,i:s,j:i,...void 0!==l.globals.seriesRange?.[s]?.[i]?.y[0]?.y1&&{y1:l.globals.seriesRange?.[s]?.[i]?.y[0]?.y1},...void 0!==l.globals.seriesRange?.[s]?.[i]?.y[0]?.y2&&{y2:l.globals.seriesRange?.[s]?.[i]?.y[0]?.y2}};if(a){if(r.tooltipLabels.drawSeriesTexts({...c,shared:!this.showOnIntersect&&this.tConfig.shared}),h)l.globals.markers.largestSize>0?r.marker.enlargePoints(i):r.tooltipPosition.moveDynamicPointsOnHover(i);else if(this.tooltipUtil.hasBars()&&(this.barSeriesHeight=this.tooltipUtil.getBarsHeight(n),this.barSeriesHeight>0)){let t=new Graphics(this.ctx),e=l.globals.dom.Paper.select(`.apexcharts-bar-area[j='${i}']`);this.deactivateHoverFilter(),this.tooltipPosition.moveStickyTooltipOverBars(i,s);for(let s=0;s<e.length;s++)t.pathMouseEnter(e[s])}}else r.tooltipLabels.drawSeriesTexts({shared:!1,...c}),this.tooltipUtil.hasBars()&&r.tooltipPosition.moveStickyTooltipOverBars(i,s),h&&r.tooltipPosition.moveMarkers(s,i)}}