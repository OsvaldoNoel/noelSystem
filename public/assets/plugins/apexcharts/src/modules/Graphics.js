import Animations from"./Animations";import Filters from"./Filters";import Utils from"../utils/Utils";class Graphics{constructor(t){this.ctx=t,this.w=t.w}roundPathCorners(t,e){function i(t,e,i){var o=e.x-t.x,r=e.y-t.y,n=Math.sqrt(o*o+r*r);return a(t,e,Math.min(1,i/n))}function a(t,e,i){return{x:t.x+(e.x-t.x)*i,y:t.y+(e.y-t.y)*i}}function o(t,e){t.length>2&&(t[t.length-2]=e.x,t[t.length-1]=e.y)}function r(t){return{x:parseFloat(t[t.length-2]),y:parseFloat(t[t.length-1])}}t.indexOf("NaN")>-1&&(t="");var n=t.split(/[,\s]/).reduce((function(t,e){var i=e.match("([a-zA-Z])(.+)");return i?(t.push(i[1]),t.push(i[2])):t.push(e),t}),[]).reduce((function(t,e){return parseFloat(e)==e&&t.length?t[t.length-1].push(e):t.push([e]),t}),[]),s=[];if(n.length>1){var l=r(n[0]),d=null;"Z"==n[n.length-1][0]&&n[0].length>2&&(d=["L",l.x,l.y],n[n.length-1]=d),s.push(n[0]);for(var h=1;h<n.length;h++){var c=s[s.length-1],p=n[h],u=p==d?n[1]:n[h+1];if(u&&c&&c.length>2&&"L"==p[0]&&u.length>2&&"L"==u[0]){var f,g,y=r(c),x=r(p),b=r(u);f=i(x,y,e),g=i(x,b,e),o(p,f),p.origPoint=x,s.push(p);var w=a(f,x,.5),m=a(x,g,.5),k=["C",w.x,w.y,m.x,m.y,g.x,g.y];k.origPoint=x,s.push(k)}else s.push(p)}if(d){var v=r(s[s.length-1]);s.push(["Z"]),o(s[0],v)}}else s=n;return s.reduce((function(t,e){return t+e.join(" ")+" "}),"")}drawLine(t,e,i,a,o="#a8a8a8",r=0,n=null,s="butt"){return this.w.globals.dom.Paper.line().attr({x1:t,y1:e,x2:i,y2:a,stroke:o,"stroke-dasharray":r,"stroke-width":n,"stroke-linecap":s})}drawRect(t=0,e=0,i=0,a=0,o=0,r="#fefefe",n=1,s=null,l=null,d=0){let h=this.w.globals.dom.Paper.rect();return h.attr({x:t,y:e,width:i>0?i:0,height:a>0?a:0,rx:o,ry:o,opacity:n,"stroke-width":null!==s?s:0,stroke:null!==l?l:"none","stroke-dasharray":d}),h.node.setAttribute("fill",r),h}drawPolygon(t,e="#e1e1e1",i=1,a="none"){return this.w.globals.dom.Paper.polygon(t).attr({fill:a,stroke:e,"stroke-width":i})}drawCircle(t,e=null){t<0&&(t=0);const i=this.w.globals.dom.Paper.circle(2*t);return null!==e&&i.attr(e),i}drawPath({d:t="",stroke:e="#a8a8a8",strokeWidth:i=1,fill:a,fillOpacity:o=1,strokeOpacity:r=1,classes:n,strokeLinecap:s=null,strokeDashArray:l=0}){let d=this.w;return null===s&&(s=d.config.stroke.lineCap),(t.indexOf("undefined")>-1||t.indexOf("NaN")>-1)&&(t=`M 0 ${d.globals.gridHeight}`),d.globals.dom.Paper.path(t).attr({fill:a,"fill-opacity":o,stroke:e,"stroke-opacity":r,"stroke-linecap":s,"stroke-width":i,"stroke-dasharray":l,class:n})}group(t=null){const e=this.w.globals.dom.Paper.group();return null!==t&&e.attr(t),e}move(t,e){return["M",t,e].join(" ")}line(t,e,i=null){let a=null;return null===i?a=[" L",t,e].join(" "):"H"===i?a=[" H",t].join(" "):"V"===i&&(a=[" V",e].join(" ")),a}curve(t,e,i,a,o,r){return["C",t,e,i,a,o,r].join(" ")}quadraticCurve(t,e,i,a){return["Q",t,e,i,a].join(" ")}arc(t,e,i,a,o,r,n,s=!1){let l="A";return s&&(l="a"),[l,t,e,i,a,o,r,n].join(" ")}renderPaths({j:t,realIndex:e,pathFrom:i,pathTo:a,stroke:o,strokeWidth:r,strokeLinecap:n,fill:s,animationDelay:l,initialSpeed:d,dataChangeSpeed:h,className:c,shouldClipToGrid:p=!0,bindEventsOnPaths:u=!0,drawShadow:f=!0}){let g=this.w;const y=new Filters(this.ctx),x=new Animations(this.ctx);let b,w=this.w.config.chart.animations.enabled,m=w&&this.w.config.chart.animations.dynamicAnimation.enabled,k=!!(w&&!g.globals.resized||m&&g.globals.dataChanged&&g.globals.shouldAnimate);k?b=i:(b=a,g.globals.animationEnded=!0);let v=g.config.stroke.dashArray,P=0;P=Array.isArray(v)?v[e]:g.config.stroke.dashArray;let A=this.drawPath({d:b,stroke:o,strokeWidth:r,fill:s,fillOpacity:1,classes:c,strokeLinecap:n,strokeDashArray:P});if(A.attr("index",e),p&&A.attr({"clip-path":`url(#gridRectMask${g.globals.cuid})`}),"none"!==g.config.states.normal.filter.type)y.getDefaultFilter(A,e);else if(g.config.chart.dropShadow.enabled&&f){const t=g.config.chart.dropShadow;y.dropShadow(A,t,e)}u&&(A.node.addEventListener("mouseenter",this.pathMouseEnter.bind(this,A)),A.node.addEventListener("mouseleave",this.pathMouseLeave.bind(this,A)),A.node.addEventListener("mousedown",this.pathMouseDown.bind(this,A))),A.attr({pathTo:a,pathFrom:i});const S={el:A,j:t,realIndex:e,pathFrom:i,pathTo:a,fill:s,strokeWidth:r,delay:l};return!w||g.globals.resized||g.globals.dataChanged?!g.globals.resized&&g.globals.dataChanged||x.showDelayedElements():x.animatePathsGradually({...S,speed:d}),g.globals.dataChanged&&m&&k&&x.animatePathsGradually({...S,speed:h}),A}drawPattern(t,e,i,a="#a8a8a8",o=0,r=1){return this.w.globals.dom.Paper.pattern(e,i,(r=>{"horizontalLines"===t?r.line(0,0,i,0).stroke({color:a,width:o+1}):"verticalLines"===t?r.line(0,0,0,e).stroke({color:a,width:o+1}):"slantedLines"===t?r.line(0,0,e,i).stroke({color:a,width:o}):"squares"===t?r.rect(e,i).fill("none").stroke({color:a,width:o}):"circles"===t&&r.circle(e).fill("none").stroke({color:a,width:o})}))}drawGradient(t,e,i,a,o,r=null,n=null,s=null,l=0){let d,h=this.w;e.length<9&&0===e.indexOf("#")&&(e=Utils.hexToRgba(e,a)),i.length<9&&0===i.indexOf("#")&&(i=Utils.hexToRgba(i,o));let c=0,p=1,u=1,f=null;null!==n&&(c=void 0!==n[0]?n[0]/100:0,p=void 0!==n[1]?n[1]/100:1,u=void 0!==n[2]?n[2]/100:1,f=void 0!==n[3]?n[3]/100:null);let g=!("donut"!==h.config.chart.type&&"pie"!==h.config.chart.type&&"polarArea"!==h.config.chart.type&&"bubble"!==h.config.chart.type);if(d=null===s||0===s.length?h.globals.dom.Paper.gradient(g?"radial":"linear",(t=>{t.at(c,e,a),t.at(p,i,o),t.at(u,i,o),null!==f&&t.at(f,e,a)})):h.globals.dom.Paper.gradient(g?"radial":"linear",(t=>{(Array.isArray(s[l])?s[l]:s).forEach((e=>{t.at(e.offset/100,e.color,e.opacity)}))})),g){let t=h.globals.gridWidth/2,e=h.globals.gridHeight/2;"bubble"!==h.config.chart.type?d.attr({gradientUnits:"userSpaceOnUse",cx:t,cy:e,r}):d.attr({cx:.5,cy:.5,r:.8,fx:.2,fy:.2})}else"vertical"===t?d.from(0,0).to(0,1):"diagonal"===t?d.from(0,0).to(1,1):"horizontal"===t?d.from(0,1).to(1,1):"diagonal2"===t&&d.from(1,0).to(0,1);return d}getTextBasedOnMaxWidth({text:t,maxWidth:e,fontSize:i,fontFamily:a}){const o=this.getTextRects(t,i,a),r=o.width/t.length,n=Math.floor(e/r);return e<o.width?t.slice(0,n-3)+"...":t}drawText({x:t,y:e,text:i,textAnchor:a,fontSize:o,fontFamily:r,fontWeight:n,foreColor:s,opacity:l,maxWidth:d,cssClass:h="",isPlainText:c=!0,dominantBaseline:p="auto"}){let u=this.w;void 0===i&&(i="");let f=i;a||(a="start"),s&&s.length||(s=u.config.chart.foreColor),r=r||u.config.chart.fontFamily,n=n||"regular";const g={maxWidth:d,fontSize:o=o||"11px",fontFamily:r};let y;return Array.isArray(i)?y=u.globals.dom.Paper.text((t=>{for(let e=0;e<i.length;e++)f=i[e],d&&(f=this.getTextBasedOnMaxWidth({text:i[e],...g})),0===e?t.tspan(f):t.tspan(f).newLine()})):(d&&(f=this.getTextBasedOnMaxWidth({text:i,...g})),y=c?u.globals.dom.Paper.plain(i):u.globals.dom.Paper.text((t=>t.tspan(f)))),y.attr({x:t,y:e,"text-anchor":a,"dominant-baseline":p,"font-size":o,"font-family":r,"font-weight":n,fill:s,class:"apexcharts-text "+h}),y.node.style.fontFamily=r,y.node.style.opacity=l,y}createGroupWithAttributes(t,e,i,a){let o=this.group();return i.forEach((t=>o.add(t))),o.attr({class:a.class?a.class:"",cy:e,cx:t}),o}drawPlus(t,e,i,a){let o=i/2,r=this.drawLine(t,e-o,t,e+o,a.pointStrokeColor,a.pointStrokeDashArray,a.pointStrokeWidth,a.pointStrokeLineCap),n=this.drawLine(t-o,e,t+o,e,a.pointStrokeColor,a.pointStrokeDashArray,a.pointStrokeWidth,a.pointStrokeLineCap);return this.createGroupWithAttributes(t,e,[r,n],a)}drawX(t,e,i,a){let o=i/2,r=this.drawLine(t-o,e-o,t+o,e+o,a.pointStrokeColor,a.pointStrokeDashArray,a.pointStrokeWidth,a.pointStrokeLineCap),n=this.drawLine(t-o,e+o,t+o,e-o,a.pointStrokeColor,a.pointStrokeDashArray,a.pointStrokeWidth,a.pointStrokeLineCap);return this.createGroupWithAttributes(t,e,[r,n],a)}drawMarker(t,e,i){t=t||0;let a=i.pSize||0,o=null;if("X"===i?.shape||"x"===i?.shape)o=this.drawX(t,e,a,i);else if("plus"===i?.shape||"+"===i?.shape)o=this.drawPlus(t,e,a,i);else if("square"===i.shape||"rect"===i.shape){let r=void 0===i.pRadius?a/2:i.pRadius;null!==e&&a||(a=0,r=0);let n=1.2*a+r,s=this.drawRect(n,n,n,n,r);s.attr({x:t-n/2,y:e-n/2,cx:t,cy:e,class:i.class?i.class:"",fill:i.pointFillColor,"fill-opacity":i.pointFillOpacity?i.pointFillOpacity:1,stroke:i.pointStrokeColor,"stroke-width":i.pointStrokeWidth?i.pointStrokeWidth:0,"stroke-opacity":i.pointStrokeOpacity?i.pointStrokeOpacity:1}),o=s}else"circle"!==i.shape&&i.shape||(Utils.isNumber(e)||(a=0,e=0),o=this.drawCircle(a,{cx:t,cy:e,class:i.class?i.class:"",stroke:i.pointStrokeColor,fill:i.pointFillColor,"fill-opacity":i.pointFillOpacity?i.pointFillOpacity:1,"stroke-width":i.pointStrokeWidth?i.pointStrokeWidth:0,"stroke-opacity":i.pointStrokeOpacity?i.pointStrokeOpacity:1}));return o}pathMouseEnter(t,e){let i=this.w;const a=new Filters(this.ctx),o=parseInt(t.node.getAttribute("index"),10),r=parseInt(t.node.getAttribute("j"),10);if("function"==typeof i.config.chart.events.dataPointMouseEnter&&i.config.chart.events.dataPointMouseEnter(e,this.ctx,{seriesIndex:o,dataPointIndex:r,w:i}),this.ctx.events.fireEvent("dataPointMouseEnter",[e,this.ctx,{seriesIndex:o,dataPointIndex:r,w:i}]),("none"===i.config.states.active.filter.type||"true"!==t.node.getAttribute("selected"))&&"none"!==i.config.states.hover.filter.type&&!i.globals.isTouchDevice){let e=i.config.states.hover.filter;a.applyFilter(t,o,e.type,e.value)}}pathMouseLeave(t,e){let i=this.w;const a=new Filters(this.ctx),o=parseInt(t.node.getAttribute("index"),10),r=parseInt(t.node.getAttribute("j"),10);"function"==typeof i.config.chart.events.dataPointMouseLeave&&i.config.chart.events.dataPointMouseLeave(e,this.ctx,{seriesIndex:o,dataPointIndex:r,w:i}),this.ctx.events.fireEvent("dataPointMouseLeave",[e,this.ctx,{seriesIndex:o,dataPointIndex:r,w:i}]),"none"!==i.config.states.active.filter.type&&"true"===t.node.getAttribute("selected")||"none"!==i.config.states.hover.filter.type&&a.getDefaultFilter(t,o)}pathMouseDown(t,e){let i=this.w;const a=new Filters(this.ctx),o=parseInt(t.node.getAttribute("index"),10),r=parseInt(t.node.getAttribute("j"),10);let n="false";if("true"===t.node.getAttribute("selected")){if(t.node.setAttribute("selected","false"),i.globals.selectedDataPoints[o].indexOf(r)>-1){let t=i.globals.selectedDataPoints[o].indexOf(r);i.globals.selectedDataPoints[o].splice(t,1)}}else{if(!i.config.states.active.allowMultipleDataPointsSelection&&i.globals.selectedDataPoints.length>0){i.globals.selectedDataPoints=[];const t=i.globals.dom.Paper.select(".apexcharts-series path").members,e=i.globals.dom.Paper.select(".apexcharts-series circle, .apexcharts-series rect").members,r=t=>{Array.prototype.forEach.call(t,(t=>{t.node.setAttribute("selected","false"),a.getDefaultFilter(t,o)}))};r(t),r(e)}t.node.setAttribute("selected","true"),n="true",void 0===i.globals.selectedDataPoints[o]&&(i.globals.selectedDataPoints[o]=[]),i.globals.selectedDataPoints[o].push(r)}if("true"===n){let e=i.config.states.active.filter;if("none"!==e)a.applyFilter(t,o,e.type,e.value);else if("none"!==i.config.states.hover.filter&&!i.globals.isTouchDevice){var s=i.config.states.hover.filter;a.applyFilter(t,o,s.type,s.value)}}else if("none"!==i.config.states.active.filter.type)if("none"===i.config.states.hover.filter.type||i.globals.isTouchDevice)a.getDefaultFilter(t,o);else{s=i.config.states.hover.filter;a.applyFilter(t,o,s.type,s.value)}"function"==typeof i.config.chart.events.dataPointSelection&&i.config.chart.events.dataPointSelection(e,this.ctx,{selectedDataPoints:i.globals.selectedDataPoints,seriesIndex:o,dataPointIndex:r,w:i}),e&&this.ctx.events.fireEvent("dataPointSelection",[e,this.ctx,{selectedDataPoints:i.globals.selectedDataPoints,seriesIndex:o,dataPointIndex:r,w:i}])}rotateAroundCenter(t){let e={};return t&&"function"==typeof t.getBBox&&(e=t.getBBox()),{x:e.x+e.width/2,y:e.y+e.height/2}}static setAttrs(t,e){for(let i in e)e.hasOwnProperty(i)&&t.setAttribute(i,e[i])}getTextRects(t,e,i,a,o=!0){let r=this.w,n=this.drawText({x:-200,y:-200,text:t,textAnchor:"start",fontSize:e,fontFamily:i,foreColor:"#fff",opacity:0});a&&n.attr("transform",a),r.globals.dom.Paper.add(n);let s=n.bbox();return o||(s=n.node.getBoundingClientRect()),n.remove(),{width:s.width,height:s.height}}placeTextWithEllipsis(t,e,i){if("function"==typeof t.getComputedTextLength&&(t.textContent=e,e.length>0&&t.getComputedTextLength()>=i/1.1)){for(let a=e.length-3;a>0;a-=3)if(t.getSubStringLength(0,a)<=i/1.1)return void(t.textContent=e.substring(0,a)+"...");t.textContent="."}}}export default Graphics;