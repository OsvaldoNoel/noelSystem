import CoreUtils from"../CoreUtils";import Dimensions from"../dimensions/Dimensions";import Graphics from"../Graphics";import Series from"../Series";import Utils from"../../utils/Utils";import Helpers from"./Helpers";class Legend{constructor(e){this.ctx=e,this.w=e.w,this.onLegendClick=this.onLegendClick.bind(this),this.onLegendHovered=this.onLegendHovered.bind(this),this.isBarsDistributed="bar"===this.w.config.chart.type&&this.w.config.plotOptions.bar.distributed&&1===this.w.config.series.length,this.legendHelpers=new Helpers(this)}init(){const e=this.w,t=e.globals,s=e.config;if((s.legend.showForSingleSeries&&1===t.series.length||this.isBarsDistributed||t.series.length>1||!t.axisCharts)&&s.legend.show){for(;t.dom.elLegendWrap.firstChild;)t.dom.elLegendWrap.removeChild(t.dom.elLegendWrap.firstChild);this.drawLegends(),Utils.isIE11()?document.getElementsByTagName("head")[0].appendChild(this.legendHelpers.getLegendStyles()):this.legendHelpers.appendToForeignObject(),"bottom"===s.legend.position||"top"===s.legend.position?this.legendAlignHorizontal():"right"!==s.legend.position&&"left"!==s.legend.position||this.legendAlignVertical()}}drawLegends(){let e=this,t=this.w,s=t.config.legend.fontFamily,i=t.globals.seriesNames,l=t.globals.colors.slice();if("heatmap"===t.config.chart.type){const e=t.config.plotOptions.heatmap.colorScale.ranges;i=e.map((e=>e.name?e.name:e.from+" - "+e.to)),l=e.map((e=>e.color))}else this.isBarsDistributed&&(i=t.globals.labels.slice());t.config.legend.customLegendItems.length&&(i=t.config.legend.customLegendItems);let n=t.globals.legendFormatter,o=t.config.legend.inverseOrder;for(let e=o?i.length-1:0;o?e>=0:e<=i.length-1;o?e--:e++){let o=n(i[e],{seriesIndex:e,w:t}),r=!1,a=!1;if(t.globals.collapsedSeries.length>0)for(let s=0;s<t.globals.collapsedSeries.length;s++)t.globals.collapsedSeries[s].index===e&&(r=!0);if(t.globals.ancillaryCollapsedSeriesIndices.length>0)for(let s=0;s<t.globals.ancillaryCollapsedSeriesIndices.length;s++)t.globals.ancillaryCollapsedSeriesIndices[s]===e&&(a=!0);let g=document.createElement("span");g.classList.add("apexcharts-legend-marker");let d=t.config.legend.markers.offsetX,c=t.config.legend.markers.offsetY,h=t.config.legend.markers.height,p=t.config.legend.markers.width,f=t.config.legend.markers.strokeWidth,m=t.config.legend.markers.strokeColor,b=t.config.legend.markers.radius,x=g.style;x.background=l[e],x.color=l[e],x.setProperty("background",l[e],"important"),t.config.legend.markers.fillColors&&t.config.legend.markers.fillColors[e]&&(x.background=t.config.legend.markers.fillColors[e]),void 0!==t.globals.seriesColors[e]&&(x.background=t.globals.seriesColors[e],x.color=t.globals.seriesColors[e]),x.height=Array.isArray(h)?parseFloat(h[e])+"px":parseFloat(h)+"px",x.width=Array.isArray(p)?parseFloat(p[e])+"px":parseFloat(p)+"px",x.left=(Array.isArray(d)?parseFloat(d[e]):parseFloat(d))+"px",x.top=(Array.isArray(c)?parseFloat(c[e]):parseFloat(c))+"px",x.borderWidth=Array.isArray(f)?f[e]:f,x.borderColor=Array.isArray(m)?m[e]:m,x.borderRadius=Array.isArray(b)?parseFloat(b[e])+"px":parseFloat(b)+"px",t.config.legend.markers.customHTML&&(Array.isArray(t.config.legend.markers.customHTML)?t.config.legend.markers.customHTML[e]&&(g.innerHTML=t.config.legend.markers.customHTML[e]()):g.innerHTML=t.config.legend.markers.customHTML()),Graphics.setAttrs(g,{rel:e+1,"data:collapsed":r||a}),(r||a)&&g.classList.add("apexcharts-inactive-legend");let L=document.createElement("div"),y=document.createElement("span");y.classList.add("apexcharts-legend-text"),y.innerHTML=Array.isArray(o)?o.join(" "):o;let u=t.config.legend.labels.useSeriesColors?t.globals.colors[e]:Array.isArray(t.config.legend.labels.colors)?t.config.legend.labels.colors?.[e]:t.config.legend.labels.colors;u||(u=t.config.chart.foreColor),y.style.color=u,y.style.fontSize=parseFloat(t.config.legend.fontSize)+"px",y.style.fontWeight=t.config.legend.fontWeight,y.style.fontFamily=s||t.config.chart.fontFamily,Graphics.setAttrs(y,{rel:e+1,i:e,"data:default-text":encodeURIComponent(o),"data:collapsed":r||a}),L.appendChild(g),L.appendChild(y);const C=new CoreUtils(this.ctx);if(!t.config.legend.showForZeroSeries){0===C.getSeriesTotalByIndex(e)&&C.seriesHaveSameValues(e)&&!C.isSeriesNull(e)&&-1===t.globals.collapsedSeriesIndices.indexOf(e)&&-1===t.globals.ancillaryCollapsedSeriesIndices.indexOf(e)&&L.classList.add("apexcharts-hidden-zero-series")}t.config.legend.showForNullSeries||C.isSeriesNull(e)&&-1===t.globals.collapsedSeriesIndices.indexOf(e)&&-1===t.globals.ancillaryCollapsedSeriesIndices.indexOf(e)&&L.classList.add("apexcharts-hidden-null-series"),t.globals.dom.elLegendWrap.appendChild(L),t.globals.dom.elLegendWrap.classList.add(`apexcharts-align-${t.config.legend.horizontalAlign}`),t.globals.dom.elLegendWrap.classList.add("apx-legend-position-"+t.config.legend.position),L.classList.add("apexcharts-legend-series"),L.style.margin=`${t.config.legend.itemMargin.vertical}px ${t.config.legend.itemMargin.horizontal}px`,t.globals.dom.elLegendWrap.style.width=t.config.legend.width?t.config.legend.width+"px":"",t.globals.dom.elLegendWrap.style.height=t.config.legend.height?t.config.legend.height+"px":"",Graphics.setAttrs(L,{rel:e+1,seriesName:Utils.escapeString(i[e]),"data:collapsed":r||a}),(r||a)&&L.classList.add("apexcharts-inactive-legend"),t.config.legend.onItemClick.toggleDataSeries||L.classList.add("apexcharts-no-click")}t.globals.dom.elWrap.addEventListener("click",e.onLegendClick,!0),t.config.legend.onItemHover.highlightDataSeries&&0===t.config.legend.customLegendItems.length&&(t.globals.dom.elWrap.addEventListener("mousemove",e.onLegendHovered,!0),t.globals.dom.elWrap.addEventListener("mouseout",e.onLegendHovered,!0))}setLegendWrapXY(e,t){let s=this.w,i=s.globals.dom.elLegendWrap;const l=i.getBoundingClientRect();let n=0,o=0;if("bottom"===s.config.legend.position)o+=s.globals.svgHeight-l.height/2;else if("top"===s.config.legend.position){const e=new Dimensions(this.ctx),t=e.dimHelpers.getTitleSubtitleCoords("title").height,s=e.dimHelpers.getTitleSubtitleCoords("subtitle").height;o=o+(t>0?t-10:0)+(s>0?s-10:0)}i.style.position="absolute",n=n+e+s.config.legend.offsetX,o=o+t+s.config.legend.offsetY,i.style.left=n+"px",i.style.top=o+"px","bottom"===s.config.legend.position?(i.style.top="auto",i.style.bottom=5-s.config.legend.offsetY+"px"):"right"===s.config.legend.position&&(i.style.left="auto",i.style.right=25+s.config.legend.offsetX+"px");["width","height"].forEach((e=>{i.style[e]&&(i.style[e]=parseInt(s.config.legend[e],10)+"px")}))}legendAlignHorizontal(){let e=this.w;e.globals.dom.elLegendWrap.style.right=0;let t=this.legendHelpers.getLegendBBox(),s=new Dimensions(this.ctx),i=s.dimHelpers.getTitleSubtitleCoords("title"),l=s.dimHelpers.getTitleSubtitleCoords("subtitle"),n=0;"bottom"===e.config.legend.position?n=-t.clwh/1.8:"top"===e.config.legend.position&&(n=i.height+l.height+e.config.title.margin+e.config.subtitle.margin-10),this.setLegendWrapXY(20,n)}legendAlignVertical(){let e=this.w,t=this.legendHelpers.getLegendBBox(),s=0;"left"===e.config.legend.position&&(s=20),"right"===e.config.legend.position&&(s=e.globals.svgWidth-t.clww-10),this.setLegendWrapXY(s,20)}onLegendHovered(e){const t=this.w,s=e.target.classList.contains("apexcharts-legend-series")||e.target.classList.contains("apexcharts-legend-text")||e.target.classList.contains("apexcharts-legend-marker");if("heatmap"===t.config.chart.type||this.isBarsDistributed){if(s){let t=parseInt(e.target.getAttribute("rel"),10)-1;this.ctx.events.fireEvent("legendHover",[this.ctx,t,this.w]),new Series(this.ctx).highlightRangeInSeries(e,e.target)}}else if(!e.target.classList.contains("apexcharts-inactive-legend")&&s){new Series(this.ctx).toggleSeriesOnHover(e,e.target)}}onLegendClick(e){const t=this.w;if(!t.config.legend.customLegendItems.length&&(e.target.classList.contains("apexcharts-legend-series")||e.target.classList.contains("apexcharts-legend-text")||e.target.classList.contains("apexcharts-legend-marker"))){let s=parseInt(e.target.getAttribute("rel"),10)-1,i="true"===e.target.getAttribute("data:collapsed");const l=this.w.config.chart.events.legendClick;"function"==typeof l&&l(this.ctx,s,this.w),this.ctx.events.fireEvent("legendClick",[this.ctx,s,this.w]);const n=this.w.config.legend.markers.onClick;"function"==typeof n&&e.target.classList.contains("apexcharts-legend-marker")&&(n(this.ctx,s,this.w),this.ctx.events.fireEvent("legendMarkerClick",[this.ctx,s,this.w]));"treemap"!==t.config.chart.type&&"heatmap"!==t.config.chart.type&&!this.isBarsDistributed&&t.config.legend.onItemClick.toggleDataSeries&&this.legendHelpers.toggleDataSeries(s,i)}}}export default Legend;