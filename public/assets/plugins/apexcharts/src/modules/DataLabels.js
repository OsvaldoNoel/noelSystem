import Scatter from"./../charts/Scatter";import Graphics from"./Graphics";import Filters from"./Filters";class DataLabels{constructor(t){this.ctx=t,this.w=t.w}dataLabelsCorrection(t,e,a,s,l,o,r){let i=this.w,n=!1,d=new Graphics(this.ctx).getTextRects(a,r),c=d.width,b=d.height;e<0&&(e=0),e>i.globals.gridHeight+b&&(e=i.globals.gridHeight+b/2),void 0===i.globals.dataLabelsRects[s]&&(i.globals.dataLabelsRects[s]=[]),i.globals.dataLabelsRects[s].push({x:t,y:e,width:c,height:b});let g=i.globals.dataLabelsRects[s].length-2,h=void 0!==i.globals.lastDrawnDataLabelsIndexes[s]?i.globals.lastDrawnDataLabelsIndexes[s][i.globals.lastDrawnDataLabelsIndexes[s].length-1]:0;if(void 0!==i.globals.dataLabelsRects[s][g]){let a=i.globals.dataLabelsRects[s][h];(t>a.x+a.width||e>a.y+a.height||e+b<a.y||t+c<a.x)&&(n=!0)}return(0===l||o)&&(n=!0),{x:t,y:e,textRects:d,drawnextLabel:n}}drawDataLabel({type:t,pos:e,i:a,j:s,isRangeStart:l,strokeWidth:o=2}){let r=this.w;const i=new Graphics(this.ctx);let n=r.config.dataLabels,d=0,c=0,b=s,g=null;if(-1!==r.globals.collapsedSeriesIndices.indexOf(a)||!n.enabled||!Array.isArray(e.x))return g;g=i.group({class:"apexcharts-data-labels"});for(let i=0;i<e.x.length;i++)if(d=e.x[i]+n.offsetX,c=e.y[i]+n.offsetY+o,!isNaN(d)){1===s&&0===i&&(b=0),1===s&&1===i&&(b=1);let o=r.globals.series[a][b];"rangeArea"===t&&(o=l?r.globals.seriesRangeStart[a][b]:r.globals.seriesRangeEnd[a][b]);let n="";const h=t=>r.config.dataLabels.formatter(t,{ctx:this.ctx,seriesIndex:a,dataPointIndex:b,w:r});if("bubble"===r.config.chart.type){o=r.globals.seriesZ[a][b],n=h(o),c=e.y[i];c=new Scatter(this.ctx).centerTextInBubble(c,a,b).y}else void 0!==o&&(n=h(o));let f=r.config.dataLabels.textAnchor;r.globals.isSlopeChart&&(f=0===b?"end":b===r.config.series[a].data.length-1?"start":"middle"),this.plotDataLabelsText({x:d,y:c,text:n,i:a,j:b,parent:g,offsetCorrection:!0,dataLabelsConfig:r.config.dataLabels,textAnchor:f})}return g}plotDataLabelsText(t){let e=this.w,a=new Graphics(this.ctx),{x:s,y:l,i:o,j:r,text:i,textAnchor:n,fontSize:d,parent:c,dataLabelsConfig:b,color:g,alwaysDrawDataLabel:h,offsetCorrection:f,className:x}=t,p=null;if(Array.isArray(e.config.dataLabels.enabledOnSeries)&&e.config.dataLabels.enabledOnSeries.indexOf(o)<0)return p;let w={x:s,y:l,drawnextLabel:!0,textRects:null};f&&(w=this.dataLabelsCorrection(s,l,i,o,r,h,parseInt(b.style.fontSize,10))),e.globals.zoomed||(s=w.x,l=w.y),w.textRects&&(s<-20-w.textRects.width||s>e.globals.gridWidth+w.textRects.width+30)&&(i="");let y=e.globals.dataLabels.style.colors[o];(("bar"===e.config.chart.type||"rangeBar"===e.config.chart.type)&&e.config.plotOptions.bar.distributed||e.config.dataLabels.distributed)&&(y=e.globals.dataLabels.style.colors[r]),"function"==typeof y&&(y=y({series:e.globals.series,seriesIndex:o,dataPointIndex:r,w:e})),g&&(y=g);let L=b.offsetX,u=b.offsetY;if("bar"!==e.config.chart.type&&"rangeBar"!==e.config.chart.type||(L=0,u=0),e.globals.isSlopeChart&&(0!==r&&(L=-2*b.offsetX+5),0!==r&&r!==e.config.series[o].data.length-1&&(L=0)),w.drawnextLabel){if(p=a.drawText({width:100,height:parseInt(b.style.fontSize,10),x:s+L,y:l+u,foreColor:y,textAnchor:n||b.textAnchor,text:i,fontSize:d||b.style.fontSize,fontFamily:b.style.fontFamily,fontWeight:b.style.fontWeight||"normal"}),p.attr({class:x||"apexcharts-datalabel",cx:s,cy:l}),b.dropShadow.enabled){const t=b.dropShadow;new Filters(this.ctx).dropShadow(p,t)}c.add(p),void 0===e.globals.lastDrawnDataLabelsIndexes[o]&&(e.globals.lastDrawnDataLabelsIndexes[o]=[]),e.globals.lastDrawnDataLabelsIndexes[o].push(r)}return p}addBackgroundToDataLabel(t,e){const a=this.w,s=a.config.dataLabels.background,l=s.padding,o=s.padding/2,r=e.width,i=e.height,n=new Graphics(this.ctx).drawRect(e.x-l,e.y-o/2,r+2*l,i+o,s.borderRadius,"transparent"===a.config.chart.background?"#fff":a.config.chart.background,s.opacity,s.borderWidth,s.borderColor);if(s.dropShadow.enabled){new Filters(this.ctx).dropShadow(n,s.dropShadow)}return n}dataLabelsBackground(){const t=this.w;if("bubble"===t.config.chart.type)return;const e=t.globals.dom.baseEl.querySelectorAll(".apexcharts-datalabels text");for(let a=0;a<e.length;a++){const s=e[a],l=s.getBBox();let o=null;if(l.width&&l.height&&(o=this.addBackgroundToDataLabel(s,l)),o){s.parentNode.insertBefore(o.node,s);const e=s.getAttribute("fill");t.config.chart.animations.enabled&&!t.globals.resized&&!t.globals.dataChanged?o.animate().attr({fill:e}):o.attr({fill:e}),s.setAttribute("fill",t.config.dataLabels.background.foreColor)}}}bringForward(){const t=this.w,e=t.globals.dom.baseEl.querySelectorAll(".apexcharts-datalabels"),a=t.globals.dom.baseEl.querySelector(".apexcharts-plot-series:last-child");for(let t=0;t<e.length;t++)a&&a.insertBefore(e[t],a.nextSibling)}}export default DataLabels;