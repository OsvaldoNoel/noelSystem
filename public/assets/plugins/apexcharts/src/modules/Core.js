import Bar from"../charts/Bar";import BarStacked from"../charts/BarStacked";import BoxCandleStick from"../charts/BoxCandleStick";import CoreUtils from"./CoreUtils";import Crosshairs from"./Crosshairs";import HeatMap from"../charts/HeatMap";import Globals from"../modules/settings/Globals";import Pie from"../charts/Pie";import Radar from"../charts/Radar";import Radial from"../charts/Radial";import RangeBar from"../charts/RangeBar";import Legend from"./legend/Legend";import Line from"../charts/Line";import Treemap from"../charts/Treemap";import Graphics from"./Graphics";import Range from"./Range";import Utils from"../utils/Utils";import Scales from"./Scales";import TimeScale from"./TimeScale";export default class Core{constructor(e,s){this.ctx=s,this.w=s.w,this.el=e}setupElements(){let e=this.w.globals,s=this.w.config,t=s.chart.type;e.axisCharts=["line","area","bar","rangeBar","rangeArea","candlestick","boxPlot","scatter","bubble","radar","heatmap","treemap"].indexOf(t)>-1,e.xyCharts=["line","area","bar","rangeBar","rangeArea","candlestick","boxPlot","scatter","bubble"].indexOf(t)>-1,e.isBarHorizontal=("bar"===s.chart.type||"rangeBar"===s.chart.type||"boxPlot"===s.chart.type)&&s.plotOptions.bar.horizontal,e.chartClass=".apexcharts"+e.chartID,e.dom.baseEl=this.el,e.dom.elWrap=document.createElement("div"),Graphics.setAttrs(e.dom.elWrap,{id:e.chartClass.substring(1),class:"apexcharts-canvas "+e.chartClass.substring(1)}),this.el.appendChild(e.dom.elWrap),e.dom.Paper=new window.SVG.Doc(e.dom.elWrap),e.dom.Paper.attr({class:"apexcharts-svg","xmlns:data":"ApexChartsNS",transform:`translate(${s.chart.offsetX}, ${s.chart.offsetY})`}),e.dom.Paper.node.style.background="dark"!==s.theme.mode||s.chart.background?s.chart.background:"rgba(0, 0, 0, 0.8)",this.setSVGDimensions(),e.dom.elLegendForeign=document.createElementNS(e.SVGNS,"foreignObject"),Graphics.setAttrs(e.dom.elLegendForeign,{x:0,y:0,width:e.svgWidth,height:e.svgHeight}),e.dom.elLegendWrap=document.createElement("div"),e.dom.elLegendWrap.classList.add("apexcharts-legend"),e.dom.elLegendWrap.setAttribute("xmlns","http://www.w3.org/1999/xhtml"),e.dom.elLegendForeign.appendChild(e.dom.elLegendWrap),e.dom.Paper.node.appendChild(e.dom.elLegendForeign),e.dom.elGraphical=e.dom.Paper.group().attr({class:"apexcharts-inner apexcharts-graphical"}),e.dom.elDefs=e.dom.Paper.defs(),e.dom.Paper.add(e.dom.elGraphical),e.dom.elGraphical.add(e.dom.elDefs)}plotChartType(e,s){const t=this.w,a=t.config,r=t.globals;let i={series:[],i:[]},o={series:[],i:[]},n={series:[],i:[]},l={series:[],i:[]},h={series:[],i:[]},c={series:[],i:[]},d={series:[],i:[]},g={series:[],i:[]},p={series:[],seriesRangeEnd:[],i:[]},m=void 0!==a.chart.type?a.chart.type:"line",b=null,x=0;r.series.forEach(((s,a)=>{let u=e[a].type||m;switch(u){case"column":case"bar":h.series.push(s),h.i.push(a),t.globals.columnSeries=h;break;case"area":o.series.push(s),o.i.push(a);break;case"line":i.series.push(s),i.i.push(a);break;case"scatter":n.series.push(s),n.i.push(a);break;case"bubble":l.series.push(s),l.i.push(a);break;case"candlestick":c.series.push(s),c.i.push(a);break;case"boxPlot":d.series.push(s),d.i.push(a);break;case"rangeBar":g.series.push(s),g.i.push(a);break;case"rangeArea":p.series.push(r.seriesRangeStart[a]),p.seriesRangeEnd.push(r.seriesRangeEnd[a]),p.i.push(a);break;case"heatmap":case"treemap":case"pie":case"donut":case"polarArea":case"radialBar":case"radar":b=u;break;default:console.warn("You have specified an unrecognized series type (",u,").")}m!==u&&"scatter"!==u&&x++})),x>0&&(null!==b&&console.warn("Chart or series type ",b," can not appear with other chart or series types."),h.series.length>0&&a.plotOptions.bar.horizontal&&(x-=h.length,h={series:[],i:[]},t.globals.columnSeries={series:[],i:[]},console.warn("Horizontal bars are not supported in a mixed/combo chart. Please turn off `plotOptions.bar.horizontal`"))),r.comboCharts||=x>0;let u=new Line(this.ctx,s),f=new BoxCandleStick(this.ctx,s);this.ctx.pie=new Pie(this.ctx);let w=new Radial(this.ctx);this.ctx.rangeBar=new RangeBar(this.ctx,s);let k=new Radar(this.ctx),S=[];if(r.comboCharts){const e=new CoreUtils(this.ctx);if(o.series.length>0&&S.push(...e.drawSeriesByGroup(o,r.areaGroups,"area",u)),h.series.length>0)if(t.config.chart.stacked){let e=new BarStacked(this.ctx,s);S.push(e.draw(h.series,h.i))}else this.ctx.bar=new Bar(this.ctx,s),S.push(this.ctx.bar.draw(h.series,h.i));if(p.series.length>0&&S.push(u.draw(p.series,"rangeArea",p.i,p.seriesRangeEnd)),i.series.length>0&&S.push(...e.drawSeriesByGroup(i,r.lineGroups,"line",u)),c.series.length>0&&S.push(f.draw(c.series,"candlestick",c.i)),d.series.length>0&&S.push(f.draw(d.series,"boxPlot",d.i)),g.series.length>0&&S.push(this.ctx.rangeBar.draw(g.series,g.i)),n.series.length>0){const e=new Line(this.ctx,s,!0);S.push(e.draw(n.series,"scatter",n.i))}if(l.series.length>0){const e=new Line(this.ctx,s,!0);S.push(e.draw(l.series,"bubble",l.i))}}else switch(a.chart.type){case"line":S=u.draw(r.series,"line");break;case"area":S=u.draw(r.series,"area");break;case"bar":if(a.chart.stacked){S=new BarStacked(this.ctx,s).draw(r.series)}else this.ctx.bar=new Bar(this.ctx,s),S=this.ctx.bar.draw(r.series);break;case"candlestick":S=new BoxCandleStick(this.ctx,s).draw(r.series,"candlestick");break;case"boxPlot":S=new BoxCandleStick(this.ctx,s).draw(r.series,a.chart.type);break;case"rangeBar":S=this.ctx.rangeBar.draw(r.series);break;case"rangeArea":S=u.draw(r.seriesRangeStart,"rangeArea",void 0,r.seriesRangeEnd);break;case"heatmap":S=new HeatMap(this.ctx,s).draw(r.series);break;case"treemap":S=new Treemap(this.ctx,s).draw(r.series);break;case"pie":case"donut":case"polarArea":S=this.ctx.pie.draw(r.series);break;case"radialBar":S=w.draw(r.series);break;case"radar":S=k.draw(r.series);break;default:S=u.draw(r.series)}return S}setSVGDimensions(){let e=this.w.globals,s=this.w.config;e.svgWidth=s.chart.width,e.svgHeight=s.chart.height;let t=Utils.getDimensions(this.el),a=s.chart.width.toString().split(/[0-9]+/g).pop();"%"===a?Utils.isNumber(t[0])&&(0===t[0].width&&(t=Utils.getDimensions(this.el.parentNode)),e.svgWidth=t[0]*parseInt(s.chart.width,10)/100):"px"!==a&&""!==a||(e.svgWidth=parseInt(s.chart.width,10));let r=s.chart.height.toString().split(/[0-9]+/g).pop();if("auto"!==e.svgHeight&&""!==e.svgHeight)if("%"===r){let t=Utils.getDimensions(this.el.parentNode);e.svgHeight=t[1]*parseInt(s.chart.height,10)/100}else e.svgHeight=parseInt(s.chart.height,10);else e.axisCharts?e.svgHeight=e.svgWidth/1.61:e.svgHeight=e.svgWidth/1.2;if(e.svgWidth<0&&(e.svgWidth=0),e.svgHeight<0&&(e.svgHeight=0),Graphics.setAttrs(e.dom.Paper.node,{width:e.svgWidth,height:e.svgHeight}),"%"!==r){let t=s.chart.sparkline.enabled?0:e.axisCharts?s.chart.parentHeightOffset:0;e.dom.Paper.node.parentNode.parentNode.style.minHeight=e.svgHeight+t+"px"}e.dom.elWrap.style.width=e.svgWidth+"px",e.dom.elWrap.style.height=e.svgHeight+"px"}shiftGraphPosition(){let e=this.w.globals,s=e.translateY,t={transform:"translate("+e.translateX+", "+s+")"};Graphics.setAttrs(e.dom.elGraphical.node,t)}resizeNonAxisCharts(){const e=this.w,s=e.globals;let t=0,a=e.config.chart.sparkline.enabled?1:15;a+=e.config.grid.padding.bottom,"top"!==e.config.legend.position&&"bottom"!==e.config.legend.position||!e.config.legend.show||e.config.legend.floating||(t=new Legend(this.ctx).legendHelpers.getLegendBBox().clwh+10);let r=e.globals.dom.baseEl.querySelector(".apexcharts-radialbar, .apexcharts-pie"),i=2.05*e.globals.radialSize;if(r&&!e.config.chart.sparkline.enabled&&0!==e.config.plotOptions.radialBar.startAngle){let s=Utils.getBoundingClientRect(r);i=s.bottom;let t=s.bottom-s.top;i=Math.max(2.05*e.globals.radialSize,t)}let o=i+s.translateY+t+a;s.dom.elLegendForeign&&s.dom.elLegendForeign.setAttribute("height",o),e.config.chart.height&&String(e.config.chart.height).indexOf("%")>0||(s.dom.elWrap.style.height=o+"px",Graphics.setAttrs(s.dom.Paper.node,{height:o}),s.dom.Paper.node.parentNode.parentNode.style.minHeight=o+"px")}coreCalculations(){new Range(this.ctx).init()}resetGlobals(){const e=()=>this.w.config.series.map((e=>[])),s=new Globals;let t=this.w.globals;s.initGlobalVars(t),t.seriesXvalues=e(),t.seriesYvalues=e()}isMultipleY(){if(this.w.config.yaxis.constructor===Array&&this.w.config.yaxis.length>1)return this.w.globals.isMultipleYAxis=!0,!0}xySettings(){let e=null;const s=this.w;if(s.globals.axisCharts){if("back"===s.config.xaxis.crosshairs.position){new Crosshairs(this.ctx).drawXCrosshairs()}if("back"===s.config.yaxis[0].crosshairs.position){new Crosshairs(this.ctx).drawYCrosshairs()}if("datetime"===s.config.xaxis.type&&void 0===s.config.xaxis.labels.formatter){this.ctx.timeScale=new TimeScale(this.ctx);let e=[];isFinite(s.globals.minX)&&isFinite(s.globals.maxX)&&!s.globals.isBarHorizontal?e=this.ctx.timeScale.calculateTimeScaleTicks(s.globals.minX,s.globals.maxX):s.globals.isBarHorizontal&&(e=this.ctx.timeScale.calculateTimeScaleTicks(s.globals.minY,s.globals.maxY)),this.ctx.timeScale.recalcDimensionsBasedOnFormat(e)}e=new CoreUtils(this.ctx).getCalculatedRatios()}return e}updateSourceChart(e){this.ctx.w.globals.selection=void 0,this.ctx.updateHelpers._updateOptions({chart:{selection:{xaxis:{min:e.w.globals.minX,max:e.w.globals.maxX}}}},!1,!1)}setupBrushHandler(){const e=this.w;if(e.config.chart.brush.enabled&&"function"!=typeof e.config.chart.events.selection){let s=Array.isArray(e.config.chart.brush.targets)?e.config.chart.brush.targets:[e.config.chart.brush.target];s.forEach((e=>{let s=ApexCharts.getChartByID(e);s.w.globals.brushSource=this.ctx,"function"!=typeof s.w.config.chart.events.zoomed&&(s.w.config.chart.events.zoomed=()=>{this.updateSourceChart(s)}),"function"!=typeof s.w.config.chart.events.scrolled&&(s.w.config.chart.events.scrolled=()=>{this.updateSourceChart(s)})})),e.config.chart.events.selection=(e,t)=>{s.forEach((e=>{ApexCharts.getChartByID(e).ctx.updateHelpers._updateOptions({xaxis:{min:t.xaxis.min,max:t.xaxis.max}},!1,!1,!1,!1)}))}}}}