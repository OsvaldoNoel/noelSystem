import Graphics from"../../modules/Graphics";import Utils from"../../utils/Utils";import Helpers from"./Helpers";import XAxisAnnotations from"./XAxisAnnotations";import YAxisAnnotations from"./YAxisAnnotations";import PointsAnnotations from"./PointsAnnotations";import Options from"./../settings/Options";export default class Annotations{constructor(t){this.ctx=t,this.w=t.w,this.graphics=new Graphics(this.ctx),this.w.globals.isBarHorizontal&&(this.invertAxis=!0),this.helpers=new Helpers(this),this.xAxisAnnotations=new XAxisAnnotations(this),this.yAxisAnnotations=new YAxisAnnotations(this),this.pointsAnnotations=new PointsAnnotations(this),this.w.globals.isBarHorizontal&&this.w.config.yaxis[0].reversed&&(this.inversedReversedAxis=!0),this.xDivision=this.w.globals.gridWidth/this.w.globals.dataPoints}drawAxesAnnotations(){const t=this.w;if(t.globals.axisCharts){let o=this.yAxisAnnotations.drawYAxisAnnotations(),n=this.xAxisAnnotations.drawXAxisAnnotations(),a=this.pointsAnnotations.drawPointAnnotations();const s=t.config.chart.animations.enabled,i=[o,n,a],e=[n.node,o.node,a.node];for(let o=0;o<3;o++)t.globals.dom.elGraphical.add(i[o]),!s||t.globals.resized||t.globals.dataChanged||"scatter"!==t.config.chart.type&&"bubble"!==t.config.chart.type&&t.globals.dataPoints>1&&e[o].classList.add("apexcharts-element-hidden"),t.globals.delayedElements.push({el:e[o],index:0});this.helpers.annotationsBackground()}}drawImageAnnos(){this.w.config.annotations.images.map(((t,o)=>{this.addImage(t,o)}))}drawTextAnnos(){this.w.config.annotations.texts.map(((t,o)=>{this.addText(t,o)}))}addXaxisAnnotation(t,o,n){this.xAxisAnnotations.addXaxisAnnotation(t,o,n)}addYaxisAnnotation(t,o,n){this.yAxisAnnotations.addYaxisAnnotation(t,o,n)}addPointAnnotation(t,o,n){this.pointsAnnotations.addPointAnnotation(t,o,n)}addText(t,o){const{x:n,y:a,text:s,textAnchor:i,foreColor:e,fontSize:r,fontFamily:d,fontWeight:l,cssClass:h,backgroundColor:x,borderWidth:c,strokeDashArray:p,borderRadius:A,borderColor:m,appendTo:g=".apexcharts-svg",paddingLeft:b=4,paddingRight:y=4,paddingBottom:f=2,paddingTop:w=2}=t,u=this.w;let E=this.graphics.drawText({x:n,y:a,text:s,textAnchor:i||"start",fontSize:r||"12px",fontWeight:l||"regular",fontFamily:d||u.config.chart.fontFamily,foreColor:e||u.config.chart.foreColor,cssClass:h});const T=u.globals.dom.baseEl.querySelector(g);T&&T.appendChild(E.node);const C=E.bbox();if(s){const t=this.graphics.drawRect(C.x-b,C.y-w,C.width+b+y,C.height+f+w,A,x||"transparent",1,c,m,p);T.insertBefore(t.node,E.node)}}addImage(t,o){const n=this.w,{path:a,x:s=0,y:i=0,width:e=20,height:r=20,appendTo:d=".apexcharts-svg"}=t;let l=n.globals.dom.Paper.image(a);l.size(e,r).move(s,i);const h=n.globals.dom.baseEl.querySelector(d);return h&&h.appendChild(l.node),l}addXaxisAnnotationExternal(t,o,n){return this.addAnnotationExternal({params:t,pushToMemory:o,context:n,type:"xaxis",contextMethod:n.addXaxisAnnotation}),n}addYaxisAnnotationExternal(t,o,n){return this.addAnnotationExternal({params:t,pushToMemory:o,context:n,type:"yaxis",contextMethod:n.addYaxisAnnotation}),n}addPointAnnotationExternal(t,o,n){return void 0===this.invertAxis&&(this.invertAxis=n.w.globals.isBarHorizontal),this.addAnnotationExternal({params:t,pushToMemory:o,context:n,type:"point",contextMethod:n.addPointAnnotation}),n}addAnnotationExternal({params:t,pushToMemory:o,context:n,type:a,contextMethod:s}){const i=n,e=i.w,r=e.globals.dom.baseEl.querySelector(`.apexcharts-${a}-annotations`),d=r.childNodes.length+1,l=new Options,h=Object.assign({},"xaxis"===a?l.xAxisAnnotation:"yaxis"===a?l.yAxisAnnotation:l.pointAnnotation),x=Utils.extend(h,t);switch(a){case"xaxis":this.addXaxisAnnotation(x,r,d);break;case"yaxis":this.addYaxisAnnotation(x,r,d);break;case"point":this.addPointAnnotation(x,r,d)}let c=e.globals.dom.baseEl.querySelector(`.apexcharts-${a}-annotations .apexcharts-${a}-annotation-label[rel='${d}']`);const p=this.helpers.addBackgroundToAnno(c,x);return p&&r.insertBefore(p.node,c),o&&e.globals.memory.methodsToExec.push({context:i,id:x.id?x.id:Utils.randomId(),method:s,label:"addAnnotation",params:t}),n}clearAnnotations(t){const o=t.w;let n=o.globals.dom.baseEl.querySelectorAll(".apexcharts-yaxis-annotations, .apexcharts-xaxis-annotations, .apexcharts-point-annotations");o.globals.memory.methodsToExec.map(((t,n)=>{"addText"!==t.label&&"addAnnotation"!==t.label||o.globals.memory.methodsToExec.splice(n,1)})),n=Utils.listToArray(n),Array.prototype.forEach.call(n,(t=>{for(;t.firstChild;)t.removeChild(t.firstChild)}))}removeAnnotation(t,o){const n=t.w;let a=n.globals.dom.baseEl.querySelectorAll(`.${o}`);a&&(n.globals.memory.methodsToExec.map(((t,a)=>{t.id===o&&n.globals.memory.methodsToExec.splice(a,1)})),Array.prototype.forEach.call(a,(t=>{t.parentElement.removeChild(t)})))}}