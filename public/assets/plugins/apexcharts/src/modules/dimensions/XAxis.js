import Formatters from"../Formatters";import Graphics from"../Graphics";import Utils from"../../utils/Utils";import DateTime from"../../utils/DateTime";export default class DimXAxis{constructor(t){this.w=t.w,this.dCtx=t}getxAxisLabelsCoords(){let t,i=this.w,e=i.globals.labels.slice();if(i.config.xaxis.convertedCatToNumeric&&0===e.length&&(e=i.globals.categoryLabels),i.globals.timescaleLabels.length>0){const e=this.getxAxisTimeScaleLabelsCoords();t={width:e.width,height:e.height},i.globals.rotateXLabels=!1}else{this.dCtx.lgWidthForSideLegends="left"!==i.config.legend.position&&"right"!==i.config.legend.position||i.config.legend.floating?0:this.dCtx.lgRect.width;let s=i.globals.xLabelFormatter,l=Utils.getLargestStringFromArr(e),a=this.dCtx.dimHelpers.getLargestStringFromMultiArr(l,e);i.globals.isBarHorizontal&&(l=i.globals.yAxisScale[0].result.reduce(((t,i)=>t.length>i.length?t:i),0),a=l);let h=new Formatters(this.dCtx.ctx),o=l;l=h.xLabelFormat(s,l,o,{i:void 0,dateFormatter:new DateTime(this.dCtx.ctx).formatDate,w:i}),a=h.xLabelFormat(s,a,o,{i:void 0,dateFormatter:new DateTime(this.dCtx.ctx).formatDate,w:i}),(i.config.xaxis.convertedCatToNumeric&&void 0===l||""===String(l).trim())&&(l="1",a=l);let g=new Graphics(this.dCtx.ctx),r=g.getTextRects(l,i.config.xaxis.labels.style.fontSize),d=r;if(l!==a&&(d=g.getTextRects(a,i.config.xaxis.labels.style.fontSize)),t={width:r.width>=d.width?r.width:d.width,height:r.height>=d.height?r.height:d.height},t.width*e.length>i.globals.svgWidth-this.dCtx.lgWidthForSideLegends-this.dCtx.yAxisWidth-this.dCtx.gridPad.left-this.dCtx.gridPad.right&&0!==i.config.xaxis.labels.rotate||i.config.xaxis.labels.rotateAlways){if(!i.globals.isBarHorizontal){i.globals.rotateXLabels=!0;const e=t=>g.getTextRects(t,i.config.xaxis.labels.style.fontSize,i.config.xaxis.labels.style.fontFamily,`rotate(${i.config.xaxis.labels.rotate} 0 0)`,!1);r=e(l),l!==a&&(d=e(a)),t.height=(r.height>d.height?r.height:d.height)/1.5,t.width=r.width>d.width?r.width:d.width}}else i.globals.rotateXLabels=!1}return i.config.xaxis.labels.show||(t={width:0,height:0}),{width:t.width,height:t.height}}getxAxisGroupLabelsCoords(){let t=this.w;if(!t.globals.hasXaxisGroups)return{width:0,height:0};const i=t.config.xaxis.group.style?.fontSize||t.config.xaxis.labels.style.fontSize;let e,s=t.globals.groups.map((t=>t.title)),l=Utils.getLargestStringFromArr(s),a=this.dCtx.dimHelpers.getLargestStringFromMultiArr(l,s),h=new Graphics(this.dCtx.ctx),o=h.getTextRects(l,i),g=o;return l!==a&&(g=h.getTextRects(a,i)),e={width:o.width>=g.width?o.width:g.width,height:o.height>=g.height?o.height:g.height},t.config.xaxis.labels.show||(e={width:0,height:0}),{width:e.width,height:e.height}}getxAxisTitleCoords(){let t=this.w,i=0,e=0;if(void 0!==t.config.xaxis.title.text){let s=new Graphics(this.dCtx.ctx).getTextRects(t.config.xaxis.title.text,t.config.xaxis.title.style.fontSize);i=s.width,e=s.height}return{width:i,height:e}}getxAxisTimeScaleLabelsCoords(){let t,i=this.w;this.dCtx.timescaleLabels=i.globals.timescaleLabels.slice();let e=this.dCtx.timescaleLabels.map((t=>t.value)),s=e.reduce(((t,i)=>void 0===t?(console.error("You have possibly supplied invalid Date format. Please supply a valid JavaScript Date"),0):t.length>i.length?t:i),0);return t=new Graphics(this.dCtx.ctx).getTextRects(s,i.config.xaxis.labels.style.fontSize),1.05*t.width*e.length>i.globals.gridWidth&&0!==i.config.xaxis.labels.rotate&&(i.globals.overlappingXLabels=!0),t}additionalPaddingXLabels(t){const i=this.w,e=i.globals,s=i.config,l=s.xaxis.type;let a=t.width;e.skipLastTimelinelabel=!1,e.skipFirstTimelinelabel=!1;const h=i.config.yaxis[0].opposite&&i.globals.isBarHorizontal,o=t=>{if(this.dCtx.timescaleLabels&&this.dCtx.timescaleLabels.length){const l=this.dCtx.timescaleLabels[0],h=this.dCtx.timescaleLabels[this.dCtx.timescaleLabels.length-1].position+a/1.75-this.dCtx.yAxisWidthRight,o=l.position-a/1.75+this.dCtx.yAxisWidthLeft;let g="right"===i.config.legend.position&&this.dCtx.lgRect.width>0?this.dCtx.lgRect.width:0;h>e.svgWidth-e.translateX-g&&(e.skipLastTimelinelabel=!0),o<-(t.show&&!t.floating||"bar"!==s.chart.type&&"candlestick"!==s.chart.type&&"rangeBar"!==s.chart.type&&"boxPlot"!==s.chart.type?10:a/1.75)&&(e.skipFirstTimelinelabel=!0)}else"datetime"===l?this.dCtx.gridPad.right<a&&!e.rotateXLabels&&(e.skipLastTimelinelabel=!0):"datetime"!==l&&this.dCtx.gridPad.right<a/2-this.dCtx.yAxisWidthRight&&!e.rotateXLabels&&!i.config.xaxis.labels.trim&&("between"!==i.config.xaxis.tickPlacement||i.globals.isBarHorizontal)&&(this.dCtx.xPadRight=a/2+1)},g=(t,i)=>{s.yaxis.length>1&&(t=>-1!==e.collapsedSeriesIndices.indexOf(t))(i)||o(t)};s.yaxis.forEach(((t,i)=>{h?(this.dCtx.gridPad.left<a&&(this.dCtx.xPadLeft=a/2+1),this.dCtx.xPadRight=a/2+1):g(t,i)}))}}