const $=require("jquery"),Typeahead=require("../../src/jquery.typeahead"),sinon=require("sinon");function sleep(e){return new Promise((t=>setTimeout(t,e)))}describe("Typeahead asyncResult option Tests",(()=>{"use strict";let e;describe("when asyncResult has multiple static groups",(()=>{beforeAll((()=>{document.body.innerHTML='<input class="js-typeahead">',e=$.typeahead({input:".js-typeahead",minLength:0,group:"category",groupOrder:"desc",display:"name",asyncResult:!0,source:{group1:{data:[{id:"1",name:"group1-item1"},{id:"2",name:"group1-item2"},{id:"3",name:"group1-item3"}]},group2:{data:function(){return[{id:"1",name:"group2-item1"},{id:"2",name:"group2-item2"},{id:"3",name:"group2-item3"}]}}}})})),it("Should have 6 results",(()=>{e.node.val("").trigger("input"),expect(e.result.length).toEqual(6)}))})),describe.only("when asyncResult has multiple static, dynamic and promised groups",(()=>{beforeAll((()=>{const t=sinon.fakeServer.create();t.respondWith("GET",/\/group3\.json/,[200,{"Content-Type":"application/json"},JSON.stringify([{id:"1",name:"group3-item1"},{id:"2",name:"group3-item2"},{id:"3",name:"group3-item3"}])]),t.autoRespond=!0,t.autoRespondAfter=1e3,document.body.innerHTML='<form>\n          <div class="typeahead__container">\n              <div class="typeahead__field">\n                  <div class="typeahead__query">\n                      <input class="js-typeahead"\n                              name="q"\n                              autofocus\n                              autocomplete="off">\n                  </div>\n              </div>\n          </div>\n      </form>',e=$.typeahead({input:".js-typeahead",minLength:0,display:"name",asyncResult:!0,maxItem:9,emptyTemplate:"no result for {{query}}",source:{group1:{data:[{id:"1",name:"group1-item1"},{id:"2",name:"group1-item2"},{id:"3",name:"group1-item3"}]},group2:{data:()=>{const e=$.Deferred(),t=[{id:"1",name:"group2-item1"},{id:"2",name:"group2-item2"},{id:"3",name:"group2-item3"}];return setTimeout((()=>{e.resolve(t)}),2e3),e}},group3:{dynamic:!0,ajax:{type:"GET",url:"http://test.com/group3.json"}}}})})),it("Should display async results",(t=>{e.node.triggerHandler("input").done((async()=>{await sleep(10),expect(e.container.hasClass("loading")).toBe(!0),expect(e.result.length).toEqual(3),await sleep(1010),expect(e.container.hasClass("loading")).toBe(!0),expect(e.result.length).toEqual(6),await sleep(2010),expect(e.container.hasClass("loading")).toBe(!1),expect(e.result.length).toEqual(9),t()}))})),it("Should display async results for dynamic request",(t=>{e.node.val("item").triggerHandler("input").done((async()=>{await sleep(10),expect(e.container.hasClass("loading")).toBe(!0),expect(e.result.length).toEqual(6),await sleep(2010),expect(e.container.hasClass("loading")).toBe(!1),expect(e.result.length).toEqual(9),t()}))})),it("Should display no async results for dynamic request",(t=>{e.node.val("invalid").triggerHandler("input").done((async()=>{expect(e.container.hasClass("loading")).toBe(!0),expect(e.result.length).toEqual(0),await sleep(2010),expect(e.container.hasClass("loading")).toBe(!1),expect(e.container.find("."+e.options.selector.empty).length).toBe(1),expect(e.result.length).toEqual(0),expect(e.resultHtml.text()).toEqual("no result for invalid"),t()}))}))}))}));